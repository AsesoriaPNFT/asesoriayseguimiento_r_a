<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recurso de Asesoría y Seguimiento 2026 (v1.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap');

        :root {
            --primary: #025964;
            /* Sober Deep Teal */
            --primary-light: #f1f8f9;
            --accent: #008e9b;
            /* Medium Teal */
            --bg-main: #ffffff;
            --text-main: #1a202c;
            --text-muted: #718096;
            --glass-bg: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            line-height: 1.6;
            letter-spacing: 0.02em;
            /* Added global tracking */
            word-spacing: 0.05em;
            /* Improved word separation */
        }

        p {
            line-height: 1.75;
            letter-spacing: 0.015em;
            /* Slightly tighter for paragraphs than headings */
            margin-bottom: 1.25rem;
        }

        /* Glassmorphism Light */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Inputs & Tabs */
        .input-field {
            background: white;
            border: 1px solid #e2e8f0;
            color: var(--text-main);
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(2, 89, 100, 0.1);
            transform: translateY(-1px);
        }

        .tab-btn {
            padding: 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-weight: 700;
            width: 50%;
            text-align: center;
            transition: 0.3s;
            letter-spacing: 0.05em;
        }

        .tab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(2, 89, 100, 0.03);
        }

        /* Navegación Lateral */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            border-radius: 14px;
            color: var(--text-muted);
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            margin-bottom: 6px;
        }

        .nav-item:hover {
            background: rgba(2, 89, 100, 0.05);
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 8px 20px -6px rgba(2, 89, 100, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            body {
                overflow: auto;
                /* Allow body scroll on mobile if needed */
            }

            #app-layout {
                flex-direction: column;
            }

            aside {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 290px;
                z-index: 200;
                /* Increased to stay above EVERYTHING */
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.2);
                background: white !important;
                backdrop-filter: none !important;
                border-right: 1px solid rgba(0, 0, 0, 0.05);
            }

            aside.open {
                left: 0;
            }

            main {
                width: 100%;
            }

            header {
                padding: 0 1.5rem;
                height: 80px;
            }

            #content-area {
                padding: 1.5rem;
            }

            /* Responsive Grid Helpers */
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Exceptions for very small grids like levels */
            .no-stack-mobile {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(2, 50, 60, 0.4);
                /* Slightly darker for better contrast */
                backdrop-filter: blur(4px);
                z-index: 150;
                /* Lower than aside (200) but higher than main content */
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Estilos específicos para La Experiencia */
        .reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        .experience-tab-btn {
            transition: all 0.3s ease;
        }

        .experience-tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 89, 100, 0.2);
        }
    </style>
</head>

<body>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-white">
        <div class="glass p-10 rounded-[2.5rem] max-w-md w-full shadow-2xl border-t-8 border-[#025964] fade-in">
            <div class="text-center mb-10">
                <div
                    class="w-20 h-20 bg-[#025964] rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-[#025964]/10 transform -rotate-2">
                    <i class="ph-bold ph-cube text-4xl"></i>
                </div>
                <h1 class="text-3xl font-black tracking-tight text-slate-800">Recurso A y S</h1>
                <p class="text-slate-500 text-[10px] uppercase tracking-widest font-black mt-1">Dimensión 1 | PNFT</p>
                <p class="text-[9px] text-slate-400 font-bold uppercase mt-2">Rodolfo Juarez | Alberto Bustos</p>
            </div>

            <div class="flex mb-8 bg-slate-100/50 p-1.5 rounded-2xl">
                <div id="tab-login" class="tab-btn active rounded-xl" onclick="switchAuthTab('login')">INGRESAR</div>
                <div id="tab-register" class="tab-btn rounded-xl" onclick="switchAuthTab('register')">REGISTRO</div>
            </div>

            <div id="form-login" class="space-y-4">
                <div class="relative group">
                    <i
                        class="ph ph-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[#025964]"></i>
                    <input type="email" id="login-email" class="input-field !pl-12" placeholder="Correo (@mep.go.cr)">
                </div>
                <div class="relative group">
                    <i
                        class="ph ph-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[#025964]"></i>
                    <input type="password" id="login-pass" class="input-field !pl-12" placeholder="Contraseña">
                </div>
                <button onclick="loginUser()"
                    class="w-full bg-[#025964] hover:bg-[#008e9b] text-white font-bold py-4 rounded-2xl transition-all hover:scale-[1.01] active:scale-[0.98] mt-4 shadow-xl shadow-[#025964]/10">
                    Iniciar Sesión
                </button>
                <p class="text-center mt-6">
                    <a href="#" onclick="enviarResetPass()"
                        class="text-[10px] font-black text-[#025964] uppercase tracking-widest hover:underline decoration-2 underline-offset-4">¿Olvidaste
                        tu contraseña?</a>
                </p>
            </div>


            <div id="form-register" class="hidden space-y-3">
                <input type="text" id="reg-name" class="input-field" placeholder="Nombre Completo">
                <input type="email" id="reg-email" class="input-field" placeholder="Correo (@mep.go.cr)">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-phone" class="input-field" placeholder="Celular" maxlength="8">
                    <input type="text" id="reg-code" class="input-field" placeholder="Cód. Inst.">
                </div>
                <input type="password" id="reg-pass" class="input-field" placeholder="Contraseña">

                <div class="group">
                    <label
                        class="block text-[9px] font-black text-[#025964] uppercase tracking-widest mb-2 ml-1">Selecciona
                        tu Asesor</label>
                    <select id="reg-advisor" class="input-field cursor-pointer">
                        <option value="none">-- Selecciona tu Asesor --</option>
                        <option value="alberto">Alberto Bustos Ortega</option>
                        <option value="rodolfo">Rodolfo Juárez Pérez</option>
                        <option value="admin">Personal Administrativo / Nacional</option>
                    </select>
                </div>
                <button onclick="registerUser()"
                    class="w-full bg-[#008e9b] hover:bg-[#025964] text-white font-bold py-4 rounded-2xl transition-all hover:scale-[1.02] active:scale-[0.98] mt-4 shadow-xl shadow-[#008e9b]/10">
                    Crear Cuenta
                </button>
            </div>

            <p id="status-msg" class="mt-8 text-xs text-center font-bold min-h-[1.5em] tracking-wide"></p>
        </div>
    </div>

    <div id="app-layout" class="hidden flex h-screen w-full bg-slate-50">
        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <aside id="main-sidebar" class="w-72 bg-white border-r border-slate-200 flex flex-col justify-between p-6">
            <div>
                <div class="flex items-center justify-between mb-10 px-2 lg:px-0">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-[#025964] rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-[#025964]/10">
                            <i class="ph-fill ph-leaf text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="font-black text-slate-800 text-lg leading-tight">Recurso A y S</h2>
                            <p
                                class="text-[9px] font-black text-slate-400 uppercase tracking-tighter leading-none mb-2">
                                Dimensión 1 | PNFT</p>
                        </div>
                    </div>
                    <!-- Close Button Mobile -->
                    <button onclick="toggleSidebar()"
                        class="lg:hidden w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-400 rounded-xl">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>

                <nav class="space-y-1">
                    <div onclick="router('dashboard')" id="nav-dashboard" class="nav-item active text-sm">
                        <i class="ph-bold ph-grid-four text-xl"></i> <span>Panel Central</span>
                    </div>
                    <div onclick="router('orientaciones')" id="nav-orientaciones" class="nav-item text-sm">
                        <i class="ph-bold ph-compass-rose text-xl"></i> <span>Orientaciones Didácticas 2026</span>
                    </div>
                    <div onclick="router('guia')" id="nav-guia" class="nav-item text-sm">
                        <i class="ph-bold ph-sparkle text-xl"></i> <span>Guía Docente 2026</span>
                    </div>
                    <div onclick="router('foro')" id="nav-foro" class="nav-item text-sm">
                        <i class="ph-bold ph-globe-hemisphere-west text-xl"></i> <span>Foro Docente</span>
                    </div>
                    <div onclick="router('ia')" id="nav-ia" class="nav-item text-sm">
                        <i class="ph-bold ph-magic-wand text-xl"></i> <span>Asesor Virtual</span>
                    </div>
                    <div onclick="router('compartiendo')" id="nav-compartiendo" class="nav-item text-sm">
                        <i class="ph-bold ph-cloud-arrow-up text-xl"></i> <span>Compartiendo Resultados</span>
                    </div>
                    <div onclick="router('admin')" id="nav-admin"
                        class="nav-item hidden !text-rose-500 hover:!bg-rose-50">
                        <i class="ph-bold ph-shield-star text-lg"></i> <span>Administración</span>
                    </div>
                </nav>
            </div>

            <div class="bg-slate-50 rounded-3xl p-5 border border-slate-100">
                <div class="flex items-center gap-4 mb-5">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-slate-600 font-black shadow-sm"
                        id="sidebar-avatar">U</div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebar-name" class="text-sm font-black text-slate-800 truncate">Usuario</p>
                        <p id="sidebar-email" class="text-xs text-slate-500 font-bold truncate">...</p>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="logout()"
                        class="w-full flex items-center justify-center gap-2 text-xs font-black text-rose-500 hover:bg-rose-50 py-2 rounded-xl transition-colors border border-rose-100 uppercase">
                        <i class="ph-bold ph-sign-out"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative bg-slate-50 overflow-y-auto">
            <header
                class="h-24 flex items-center justify-between px-10 border-b border-slate-200 bg-white/70 backdrop-blur-xl sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <!-- Hamburger Menu Button -->
                    <button onclick="toggleSidebar()"
                        class="lg:hidden w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl text-slate-600">
                        <i class="ph-bold ph-list text-xl"></i>
                    </button>
                    <div>
                        <h2 id="page-title"
                            class="text-xl lg:text-2xl font-black tracking-tight text-slate-800 truncate max-w-[200px] lg:max-w-none">
                            Recurso A y S</h2>
                        <p class="text-[9px] text-teal-600 font-black uppercase tracking-widest mt-1 hidden lg:block">
                            Asesoría PNFT 2026</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <span
                        class="text-[9px] font-black uppercase tracking-widest text-teal-600 bg-teal-50 px-3 py-2 rounded-xl flex items-center gap-2 border border-teal-100/50">
                        <span class="w-1.5 h-1.5 bg-teal-500 rounded-full animate-pulse"></span> <span
                            class="hidden sm:inline">Sistema Activo</span>
                    </span>
                </div>
            </header>

            <div id="content-area" class="p-10 max-w-7xl mx-auto fade-in">
            </div>
        </main>
    </div>

    <script type="module">
        // --- CONSTANTES DE DATOS CURRICULARES ---
        const SABERES_DATA = {
            'sétimo': {
                title: 'Sétimo Año: Fundamentos y Apropiación',
                modulos: [
                    {
                        n: 'Módulo 1',
                        s: [
                            { n: 'Computadora', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Gestión de archivos', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Estructuras condicionales', a: 'Programación y Algoritmos' },
                            { n: 'Estructuras repetitivas', a: 'Programación y Algoritmos' },
                            { n: 'Operadores aritméticos', a: 'Programación y Algoritmos' },
                            { n: 'Operadores relacionales', a: 'Programación y Algoritmos' },
                            { n: 'Operadores lógicos', a: 'Programación y Algoritmos' },
                            { n: 'Evento', a: 'Programación y Algoritmos' },
                            { n: 'Hardware', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Software', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Redes de comunicación', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Sistema operativo', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Lógica de programación', a: 'Programación y Algoritmos' },
                            { n: 'Dato', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Variable', a: 'Programación y Algoritmos' },
                            { n: 'Algoritmo', a: 'Programación y Algoritmos' },
                            { n: 'Herramientas de creación de contenido', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Entorno de programación', a: 'Programación y Algoritmos' }
                        ]
                    },
                    {
                        n: 'Módulo 2',
                        s: [
                            { n: 'Herramienta de productividad', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Referencias bibliográficas', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Operadores lógicos', a: 'Programación y Algoritmos' },
                            { n: 'Procedimientos y/o funciones', a: 'Programación y Algoritmos' },
                            { n: 'Riesgos en línea', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Dato', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Asistentes virtuales', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Internet', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Criptomonedas', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Software malicioso', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Fundamentos de la IA', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Navegador', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Netiqueta', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Almacenamiento en la nube', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Contraseñas seguras', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Buscador', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Comunicación y colaboración', a: 'Apropiación Tecnológica y Digital' }
                        ]
                    }
                ]
            },
            'octavo': {
                title: 'Octavo Año: Comunicación e Interconexión',
                modulos: [
                    {
                        n: 'Módulo 1',
                        s: [
                            { n: 'Gestión de archivos', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Entorno de programación textual', a: 'Programación y Algoritmos' },
                            { n: 'Conexión entre dispositivos', a: 'Computación Física y Robótica' },
                            { n: 'Circuito eléctrico', a: 'Computación Física y Robótica' },
                            { n: 'Fundamentos de electrónica', a: 'Computación Física y Robótica' },
                            { n: 'Robot', a: 'Computación Física y Robótica' },
                            { n: 'Mecanismos', a: 'Computación Física y Robótica' },
                            { n: 'Herramientas de creación de contenido', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Buscador', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Hardware', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Software', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Mecánica aplicada a la robótica', a: 'Computación Física y Robótica' },
                            { n: 'Microcontrolador', a: 'Computación Física y Robótica' },
                            { n: 'Robótica', a: 'Computación Física y Robótica' },
                            { n: 'Entorno de programación', a: 'Programación y Algoritmos' },
                            { n: 'Sistema Operativo', a: 'Apropiación Tecnológica y Digital' }
                        ]
                    },
                    {
                        n: 'Módulo 2',
                        s: [
                            { n: 'Software malicioso', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Colección de datos', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Redes de comunicación', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Licencia', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Hackeo', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Fundamentos de la IA', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Plataformas de creación de contenido', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Sensor', a: 'Computación Física y Robótica' },
                            { n: 'Actuador', a: 'Computación Física y Robótica' },
                            { n: 'Herramientas generativas', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Recolección de datos', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Internet de las cosas', a: 'Computación Física y Robótica' },
                            { n: 'Herramienta de productividad', a: 'Apropiación Tecnológica y Digital' }
                        ]
                    }
                ]
            },
            'noveno': {
                title: 'Noveno Año: Automatización y Prototipado',
                modulos: [
                    {
                        n: 'Módulo 1',
                        s: [
                            { n: 'Microcontrolador', a: 'Computación Física y Robótica' },
                            { n: 'Movimiento en mecanismos', a: 'Computación Física y Robótica' },
                            { n: 'Dato', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Almacenamiento de datos', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Entorno de programación textual', a: 'Programación y Algoritmos' },
                            { n: 'Algoritmo', a: 'Programación y Algoritmos' },
                            { n: 'Domótica', a: 'Computación Física y Robótica' },
                            { n: 'Prototipos', a: 'Computación Física y Robótica' },
                            { n: 'Sensor', a: 'Computación Física y Robótica' },
                            { n: 'Actuador', a: 'Computación Física y Robótica' }
                        ]
                    },
                    {
                        n: 'Módulo 2',
                        s: [
                            { n: 'Sistema Operativo', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Herramientas generativas', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Redes de comunicación', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Derechos de autor y licenciamiento', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Desafíos de la IA', a: 'Ciencias de Datos e Inteligencia Artificial' },
                            { n: 'Herramienta de productividad', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Herramientas de creación de contenido', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Huella digital', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Riesgos en línea', a: 'Apropiación Tecnológica y Digital' },
                            { n: 'Plataformas de creación de contenido', a: 'Apropiación Tecnológica y Digital' }
                        ]
                    }
                ]
            }
        };
        window.SABERES_DATA = SABERES_DATA;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, addDoc, getDocs, query, orderBy, limit, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBABrNvQH1Zu-peF3Rn1uCe-Yfb2LBGC9A",
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:ad84528e1c13d5e15988aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- SISTEMA DE NAVEGACIÓN Y VISTAS ---
        window.currentUserData = null;

        /**
         * SEGURIDAD PNFT 2026: OFUSCACIÓN DE CLAVE
         * Codificamos la clave en Base64 para evitar que los bots de Google la detecten como filtrada.
         * Para máxima seguridad: RESTRINGE ESTA CLAVE POR DOMINIO (HTTP Referrer) en Google AI Studio.
         */
        const _k = "QUl6YVN5QWNUNDhvNGJlSlF5ZDN4VmFpOGYwd1FUQ3FEd3NUYjJj";
        window.geminiKey = atob(_k);

        // Configuración de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        };

        window.router = async (view) => {
            // Close sidebar on navigation (mobile)
            document.getElementById('main-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById('nav-' + view);
            if (activeBtn) activeBtn.classList.add('active');

            const container = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            container.innerHTML = '<div class="flex flex-col items-center justify-center mt-32 space-y-4"><div class="w-16 h-16 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"></div><p class="text-teal-600 font-black uppercase tracking-widest text-sm animate-pulse">Sincronizando ecosistema...</p></div>';

            if (view === 'compartiendo') {
                title.innerText = "Galería de Producciones Digitales";
                container.innerHTML = `
                    <div class="fade-in space-y-10 pb-20">
                        <!-- Hero de Galería -->
                        <div class="glass p-10 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden shadow-xl border-none">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center relative z-10">
                                <div>
                                    <span class="bg-white/10 text-teal-300 border border-white/10 text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Repositorio Nacional PNFT</span>
                                    <h3 class="text-5xl font-black mb-6 leading-tight uppercase tracking-tighter">Nuestras <br>Producciones</h3>
                                    <p class="text-teal-100 font-medium leading-relaxed text-lg italic border-l-4 border-teal-500 pl-6">
                                        Explora y comparte recursos diseñados por docentes para la resolución de problemas y el fortalecimiento de saberes digitales.
                                    </p>
                                    <div class="mt-8 flex gap-4">
                                        <button onclick="window.abrirModalSubir()" class="bg-teal-500 hover:bg-teal-400 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl transition-all flex items-center gap-3">
                                            <i class="ph-bold ph-plus-circle text-xl"></i> Compartir Recurso
                                        </button>
                                        <a href="https://adminmepcr-my.sharepoint.com/:f:/g/personal/alberto_bustos_ortega_mep_go_cr/IgDapm3yAwYNSpv-eKTJND8FASqX99UebZBoTjwXfyg0Po4?e=MQdZTP" target="_blank" class="bg-white/10 hover:bg-white/20 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest border border-white/10 transition-all flex items-center gap-3">
                                            <i class="ph-bold ph-microsoft-excel text-xl"></i> Carpeta OneDrive
                                        </a>
                                    </div>
                                </div>
                                <div class="hidden lg:block relative h-[350px] rounded-[2rem] overflow-hidden">
                                     <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover grayscale opacity-50">
                                     <div class="absolute inset-0 bg-gradient-to-tr from-[#025964] via-transparent to-transparent"></div>
                                </div>
                            </div>
                            <i class="ph-fill ph-circles-three text-[20rem] absolute -right-20 -bottom-20 text-white/5 rotate-12"></i>
                        </div>

                        <!-- Grid de Recursos -->
                        <div class="space-y-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter flex items-center gap-3">
                                    <i class="ph-bold ph-layout text-teal-600"></i> Recursos de la Comunidad
                                </h4>
                                <div class="flex gap-2">
                                    <select onchange="window.filtrarRecursos(this.value)" class="bg-slate-100 border-none rounded-xl px-4 py-2 text-[10px] font-black uppercase tracking-widest text-slate-500 outline-none">
                                        <option value="todos">Todos los niveles</option>
                                        <option value="sétimo">Sétimo Año</option>
                                        <option value="octavo">Octavo Año</option>
                                        <option value="noveno">Noveno Año</option>
                                    </select>
                                </div>
                            </div>

                            <div id="galeria-recursos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                <!-- Cargando state -->
                                <div class="col-span-full py-20 flex flex-col items-center gap-4">
                                    <div class="w-10 h-10 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"></div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Consultando repositorio...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Carga -->
                    <div id="modal-subir" class="fixed inset-0 z-[2000] hidden flex items-center justify-center p-6">
                        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.cerrarModalSubir()"></div>
                        <div class="glass w-full max-w-xl bg-white rounded-[2.5rem] shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
                            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-[#025964] text-white">
                                <div>
                                    <h3 class="text-xl font-black uppercase tracking-tighter leading-none">Compartir Recurso Digital</h3>
                                    <p class="text-[10px] text-teal-200 uppercase tracking-widest mt-2 font-bold">Ciclo Lectivo 2026</p>
                                </div>
                                <button onclick="window.cerrarModalSubir()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition-all"><i class="ph-bold ph-x"></i></button>
                            </div>
                            
                            <div class="p-8 overflow-y-auto no-scrollbar space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Nombre del Recurso</label>
                                        <input type="text" id="up-nombre" class="input-field text-xs mb-0" placeholder="Ej: App de Lógica Condicional">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Nivel Educativo</label>
                                        <select id="up-nivel" onchange="window.updateUploadSelectors()" class="input-field text-xs mb-0">
                                            <option value="">Seleccione Nivel</option>
                                            <option value="sétimo">Sétimo Año</option>
                                            <option value="octavo">Octavo Año</option>
                                            <option value="noveno">Noveno Año</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Módulo</label>
                                        <select id="up-modulo" onchange="window.updateUploadSaberes()" class="input-field text-xs mb-0">
                                            <option value="">Primero elija nivel</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Área de Conocimiento</label>
                                        <select id="up-area" onchange="window.updateUploadSaberes()" class="input-field text-xs mb-0">
                                            <option value="">Seleccione Área</option>
                                            <option value="Apropiación Tecnológica y Digital">Apropiación Tecnológica y Digital</option>
                                            <option value="Programación y Algoritmos">Programación y Algoritmos</option>
                                            <option value="Ciencias de Datos e Inteligencia Artificial">Ciencias de Datos e Inteligencia Artificial</option>
                                            <option value="Computación Física y Robótica">Computación Física y Robótica</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Saber Asociado</label>
                                        <select id="up-saber" class="input-field text-xs mb-0">
                                            <option value="">Filtrar por Área</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="space-y-1">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Descripción del Recurso</label>
                                    <textarea id="up-desc" class="input-field text-xs mb-0 min-h-[80px]" placeholder="¿De qué trata este recurso y cómo ayuda en la resolución de problemas?"></textarea>
                                </div>

                                <div class="space-y-4">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 block">Archivo del Recurso (PDF, ZIP, DOCX)</label>
                                    <div class="border-2 border-dashed border-slate-100 rounded-2xl p-8 flex flex-col items-center justify-center gap-4 bg-slate-50 group hover:border-teal-500/30 transition-all cursor-pointer relative" onclick="document.getElementById('file-upload').click()">
                                        <input type="file" id="file-upload" class="hidden" onchange="window.handleFileSelect(this)">
                                        <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-slate-300 shadow-sm group-hover:text-teal-500 transition-all">
                                            <i class="ph-bold ph-cloud-arrow-up text-3xl"></i>
                                        </div>
                                        <p id="file-name" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Haga clic o arrastre el archivo aquí</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-8 border-t border-slate-100 bg-slate-50">
                                <button onclick="window.subirRecursoDigital()" id="btn-subir" class="w-full bg-[#025964] hover:bg-teal-600 text-white py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all disabled:bg-slate-300 flex items-center justify-center gap-2">
                                    <i class="ph ph-upload-simple"></i> Publicar en el Ecosistema
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                window.cargarGaleriaRecursos();
                return;
            }

            // --- VISTA: DASHBOARD ---
            if (view === 'dashboard') {
                title.innerText = "Panel Central del Ecosistema";
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 fade-in">
                        <div class="md:col-span-2 glass p-10 rounded-[2.5rem] relative overflow-hidden bg-white border-slate-100 shadow-sm">
                            <div class="relative z-10">
                                <span class="bg-[#025964] text-white text-xs font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-4 inline-block shadow-lg shadow-[#025964]/10">Portal Activo 2026</span>
                                 <h3 class="text-4xl font-black mb-3 text-slate-800">¡Hola, ${(window.currentUserData?.nombre || 'Docente').split(' ')[0]}! ✨</h3>
                                <p class="text-slate-500 leading-relaxed max-w-lg font-medium">Estamos aquí para apoyarte en el ciclo 2026. Tu Asesor IA y las orientaciones están listas para optimizar tu trabajo docente.</p>
                                <div class="flex gap-4 mt-8">
                                    <button onclick="router('ia')" class="bg-[#025964] hover:bg-[#008e9b] text-white font-bold py-3 px-8 rounded-2xl transition-all shadow-xl shadow-[#025964]/10 flex items-center gap-2 hover:scale-[1.02]">
                                        <i class="ph-fill ph-sparkle text-xl"></i> Consultar IA
                                    </button>
                                    <button onclick="router('orientaciones')" class="bg-white border-2 border-slate-100 hover:border-[#025964]/30 text-slate-600 font-bold py-3 px-8 rounded-2xl transition-all flex items-center gap-2">
                                        Ver Documentación
                                    </button>
                                </div>
                            </div>
                            <i class="ph-fill ph-plant text-[15rem] absolute -right-10 -bottom-10 text-[#025964]/5 rotate-12"></i>
                        </div>
                        <div class="space-y-6">
                            <div class="glass p-8 rounded-[2rem] flex flex-col items-center justify-center text-center hover:scale-[1.02] transition-transform cursor-pointer group" onclick="router('orientaciones')">
                                <div class="w-20 h-20 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] mb-6 group-hover:bg-[#025964] group-hover:text-white transition-all shadow-sm"><i class="ph-duotone ph-newspaper text-4xl"></i></div>
                                <h4 class="font-black text-slate-800 text-xl">Orientaciones Didácticas</h4>
                                <p class="text-sm text-slate-400 font-bold uppercase tracking-tight mt-1">Normativa Vigente 2026</p>
                            </div>
                            <div class="glass p-8 rounded-[2rem] flex flex-col items-center justify-center text-center hover:scale-[1.02] transition-transform cursor-pointer group" onclick="router('compartiendo')">
                                <div class="w-20 h-20 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] mb-6 group-hover:bg-[#025964] group-hover:text-white transition-all shadow-sm"><i class="ph-duotone ph-cloud-arrow-up text-4xl"></i></div>
                                <h4 class="font-black text-slate-800 text-xl">Compartiendo Resultados</h4>
                                <p class="text-sm text-slate-400 font-bold uppercase tracking-tight mt-1">Nube de Producciones</p>
                            </div>
                        </div>
                    </div>
                `;

                // --- VISTA: ORIENTACIONES ---
            } else if (view === 'orientaciones') {
                title.innerText = "Orientaciones Didácticas 2026";
                container.innerHTML = `
                    <div class="fade-in space-y-12 pb-20">
                        <!-- Hero & Audio -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 relative overflow-hidden shadow-sm">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">
                                <div>
                                    <span class="bg-[#f1f8f9] text-[#025964] border border-[#025964]/20 text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Dimensión 1 PNFT</span>
                                    <h3 class="text-4xl font-black mb-6 leading-tight text-slate-800">Orientaciones <br><span class="text-[#025964]">Didácticas 2026</span></h3>
                                    <div class="flex flex-col gap-4">
                                        <p class="text-slate-500 font-medium leading-relaxed text-lg italic border-l-4 border-[#025964] pl-6">
                                            "Transformamos el aula en un laboratorio de creación tecnológica constante."
                                        </p>
                                        <a href="https://adminmepcr-my.sharepoint.com/:b:/g/personal/alberto_bustos_ortega_mep_go_cr/IQB2V-ZCEVyHRaw6p6kqi6TsAQk0T_YWsaIDCu6NhH4628c?e=peFKdh" target="_blank" class="inline-flex items-center gap-2 text-[10px] font-black text-[#025964] uppercase tracking-widest bg-white border border-[#025964]/20 px-6 py-3 rounded-2xl hover:bg-[#025964] hover:text-white transition-all w-fit shadow-sm">
                                            <i class="ph-bold ph-download-simple"></i> Descargar Documento Oficial
                                        </a>
                                    </div>
                                </div>
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm relative overflow-hidden">
                                    <h4 class="text-xs font-black text-[#025964] uppercase tracking-widest mb-4 italic">Mis Apuntes de mediación</h4>
                                    <textarea id="orient-notes" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-5 text-base text-slate-600 font-medium placeholder:text-slate-300 outline-none focus:bg-white focus:border-[#025964] transition-all resize-none" rows="3" placeholder="Anota aquí tus reflexiones..."></textarea>
                                    <div class="flex justify-between items-center mt-6">
                                        <p class="text-xs text-slate-400 font-bold uppercase italic tracking-tighter">Guardado Automático</p>
                                        <button onclick="window.saveOrientNotes()" class="bg-[#025964] text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.01] transition-all">Guardar Notas</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Tabs -->
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 glass p-2 rounded-[2.5rem] bg-[#f1f8f9] border border-slate-100 flex flex-wrap gap-2">
                                <button onclick="switchOrientTab('admin')" id="tab-btn-admin" class="orient-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all bg-[#025964] text-white">Administración</button>
                                <button onclick="switchOrientTab('peda')" id="tab-btn-peda" class="orient-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Pedagogía</button>
                                <button onclick="switchOrientTab('plan')" id="tab-btn-plan" class="orient-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Planeamiento</button>
                                <button onclick="switchOrientTab('eval')" id="tab-btn-eval" class="orient-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Evaluación</button>
                                <button onclick="switchOrientTab('pob')" id="tab-btn-pob" class="orient-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Poblaciones</button>
                            </div>
                        </div>

                        <!-- Dynamic Content Area -->
                        <div id="orient-main-content" class="min-h-[500px]">
                            <!-- Content injected here via switchOrientTab -->
                        </div>
                    </div>
                `;

                // Cargar notas guardadas
                setTimeout(() => {
                    const saved = localStorage.getItem('pnft_orient_notes');
                    if (saved) document.getElementById('orient-notes').value = saved;
                    window.switchOrientTab('admin');
                }, 100);

                // --- VISTA: GUÍA DOCENTE + IA #1 ---
            } else if (view === 'guia') {
                title.innerText = "Guía Docente 2026";
                container.innerHTML = `
                    <div class="fade-in space-y-12 pb-20">
                        <!-- Hero Section -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 text-slate-800 relative overflow-hidden shadow-sm">
                            <div class="relative z-10 max-w-3xl">
                                <span class="bg-[#f1f8f9] border border-[#008e9b]/20 text-[#025964] text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Planificación Estratégica Secundaria</span>
                                <h3 class="text-5xl font-black mb-6 leading-tight">Guía Docente de <br><span class="text-[#025964]">Formación Tecnológica</span></h3>
                                <p class="text-slate-500 font-medium leading-relaxed text-lg italic mt-2">
                                    "Basada estrictamente en la Guía docente para la Formación Tecnológica Secundaria-III ciclo (2026)."
                                </p>
                                <div class="mt-8 flex gap-4">
                                    <a href="https://adminmepcr-my.sharepoint.com/:b:/g/personal/alberto_bustos_ortega_mep_go_cr/IQAZrjMJLUP9RI7NrQv0xDXyAUqaD44Su6Gx0FegZHuooWE?e=9Yp8jE" target="_blank" class="bg-white/10 hover:bg-[#025964] hover:text-white text-[#025964] border border-[#025964]/20 px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all flex items-center gap-3 shadow-sm">
                                        <i class="ph-bold ph-download-simple text-xl"></i> Documento Oficial Guía Docente 2026
                                    </a>
                                </div>
                            </div>
                            <div class="absolute top-[-10%] right-[-5%] opacity-10 rotate-12 text-[#025964]"><i class="ph-fill ph-target text-[20rem]"></i></div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- Left: IA Generator Sidebar -->
                            <div class="lg:col-span-1 space-y-8">
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-xl sticky top-24">
                                    <h4 class="text-xl font-black text-slate-800 mb-2 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-[#f1f8f9] rounded-xl flex items-center justify-center text-[#025964]"><i class="ph-fill ph-sparkle"></i></div>
                                        Creador de Situaciones Problema
                                    </h4>
                                    
                                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-2xl">
                                        <div class="flex gap-3">
                                            <i class="ph-fill ph-info text-amber-600 text-lg"></i>
                                            <p class="text-[10px] text-amber-800 font-bold leading-relaxed">
                                                <b>NOTA PEDAGÓGICA:</b> Este recurso genera <u>ejemplos orientadores</u>. El proceso de <b>Design Thinking</b> debe ser vivido por el estudiante; use estos puntos como guía para su mediación, no como material final de entrega.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <div class="group">
                                            <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Contexto de la situación</label>
                                            <textarea id="ia-tema" rows="4" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-5 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all shadow-inner" placeholder="Pocos laboratorios, baja conectividad, estudiantes de zona rural..."></textarea>
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Nivel Seleccionado</label>
                                            <select id="ia-nivel" onchange="updateIASelectors()" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all appearance-none cursor-pointer">
                                                <option value="sétimo">Sétimo Año</option>
                                                <option value="octavo">Octavo Año</option>
                                                <option value="noveno">Noveno Año</option>
                                            </select>
                                        </div>

                                        <div id="ia-dynamic-selectors" class="space-y-6">
                                            <!-- Injected via updateIASelectors -->
                                        </div>

                                        <button onclick="window.generarSituacion()" class="w-full bg-[#025964] hover:bg-[#008e9b] text-white rounded-3xl py-5 font-black text-sm transition-all shadow-lg shadow-[#025964]/10 flex items-center justify-center gap-3 group uppercase tracking-widest">
                                            Procesar Situación Problema <i class="ph-bold ph-magic-wand text-xl transition-transform group-hover:scale-105"></i>
                                        </button>
                                    </div>

                                    <div id="ia-result-container" class="mt-8 hidden">
                                        <div id="ia-result" class="bg-[#f1f8f9] p-6 rounded-3xl border border-[#025964]/10 text-sm text-slate-700 leading-relaxed max-h-[400px] overflow-y-auto">
                                            <!-- Result here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Guide Content -->
                            <div class="lg:col-span-2 space-y-12">
                                
                                <!-- Áreas de Conocimiento -->
                                <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 shadow-sm">
                                    <div class="flex items-center gap-4 mb-8">
                                        <div class="w-12 h-12 bg-teal-50 rounded-2xl flex items-center justify-center text-teal-600"><i class="ph-fill ph-circles-four"></i></div>
                                        <h4 class="text-2xl font-black text-slate-800">Áreas de Conocimiento</h4>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Apropiación Tecnológica y Digital</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Infraestructura, hardware, red, software esencial y ciudadanía digital.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Programación y Algoritmos</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Pensamiento computacional, algoritmos y lenguajes de programación.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Computación Física y Robótica</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Robótica, sensores, actuadores, domótica y prototipado IoT.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Ciencia de Datos & IA</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Gestión de datos, seguridad, ética de la IA y herramientas generativas.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Propósito & Estructura -->
                                <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100">
                                    <div class="flex items-center gap-4 mb-8">
                                        <div class="w-12 h-12 bg-teal-50 rounded-2xl flex items-center justify-center text-teal-600"><i class="ph-fill ph-stack"></i></div>
                                        <h4 class="text-2xl font-black text-slate-800">Directrices Metodológicas</h4>
                                    </div>
                                    <div class="mb-8">
                                        <p class="text-base text-slate-600 leading-relaxed">
                                            El PNFT promueve el desarrollo de competencias tecnológicas mediante la resolución de problemas contextualizados, centrando la mediación pedagógica en la creación y el pensamiento crítico.
                                        </p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="p-8 rounded-[2rem] bg-slate-50 border border-slate-100">
                                            <h5 class="font-black text-slate-800 text-base mb-4">Componentes del Modelo</h5>
                                            <ul class="space-y-3 text-sm text-slate-500 font-medium">
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Competencias por Áreas de Conocimiento</li>
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Resultados de Aprendizaje (RdA)</li>
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Perfiles de Salida Institucionales</li>
                                            </ul>
                                        </div>
                                        <div class="p-8 rounded-[2rem] bg-[#025964] text-white shadow-xl shadow-[#025964]/10">
                                            <h5 class="font-black text-base mb-4 flex items-center gap-2"><i class="ph-fill ph-lightbulb"></i> Metodología Activa</h5>
                                            <p class="text-2xl font-black tracking-tighter mb-4">Design Thinking</p>
                                            <p class="text-xs text-white/70 uppercase font-black tracking-widest leading-none">Fases: Empatía - Definición - Ideación - Prototipado - Probar y Evaluar</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Levels Tabs -->
                                <div class="space-y-6">
                                    <div class="flex gap-4 p-2 bg-[#f1f8f9] rounded-[2rem] overflow-x-auto no-scrollbar border border-[#025964]/5">
                                        <button onclick="switchLevelTab('sétimo')" id="level-btn-sétimo" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all bg-[#025964] text-white shadow-lg shadow-[#025964]/10">7mo Año</button>
                                        <button onclick="switchLevelTab('octavo')" id="level-btn-octavo" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all text-slate-400 hover:text-[#025964]">8vo Año</button>
                                        <button onclick="switchLevelTab('noveno')" id="level-btn-noveno" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all text-slate-400 hover:text-[#025964]">9no Año</button>
                                    </div>

                                    <div id="level-content-area" class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10">
                                        <!-- Level content injected via switchLevelTab('sétimo') -->
                                    </div>
                                </div>

                                <!-- Evaluation & Planning Details -->
                                <div class="space-y-8">
                                    <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                                        <h5 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-3"><i class="ph-fill ph-scales text-[#025964]"></i> Lineamientos de Evaluación</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600 leading-relaxed">
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Marco Normativo:</b> Se rige estrictamente por el Reglamento de Evaluación de los Aprendizajes vigente.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Responsabilidad:</b> El docente diseña estrategias contextualizadas e integradoras.</div></li>
                                            </ul>
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Gestión del Tiempo:</b> Se debe valorar el tiempo efectivo por periodo para la medición justa.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Reflexión Ética:</b> Integrar espacios sobre el sentido ético y responsable de la IA y tecnología.</div></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 shadow-sm relative overflow-hidden">
                                        <h5 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-3"><i class="ph-fill ph-notepad text-[#025964]"></i> Directrices de Planeamiento</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600 leading-relaxed mb-8">
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Base Curricular:</b> Referencia obligatoria al macro y micro currículo del PNFT.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Contextualización:</b> Adaptación a necesidades y entorno de los estudiantes.</div></li>
                                            </ul>
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Ejes Transversales:</b> Pensamiento Computacional, Ciudadanía Digital y Emprendimiento.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Libertad y Autonomía:</b> El docente lidera el diseño de su mediación pedagógica.</div></li>
                                            </ul>
                                        </div>
                                        <div class="p-6 bg-[#f1f8f9] rounded-2xl border-2 border-dashed border-[#025964]/20 flex flex-col md:flex-row items-center justify-between gap-6">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-[#025964] shadow-sm"><i class="ph-bold ph-layout text-2xl"></i></div>
                                                <div>
                                                    <p class="text-[10px] font-black text-[#025964] uppercase tracking-widest">Plantilla PIA Online</p>
                                                    <p class="text-xs text-slate-500 font-medium">Accede al planeamiento en línea 2026</p>
                                                </div>
                                            </div>
                                            <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="bg-[#025964] text-white px-8 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.02] transition-all">Abrir Plantilla</a>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                `;
                // Inicializar con Sétimo y activar selectores IA
                setTimeout(() => {
                    window.switchLevelTab('sétimo');
                    window.updateIASelectors();
                }, 50);


            } else if (view === 'foro') {
                title.innerText = "Foro Docente";
                let postsHtml = '';
                try {
                    const q = window.query(window.collection(db, "foro_posts"), window.orderBy("fecha", "desc"), window.limit(15));
                    const querySnapshot = await window.getDocs(q);
                    querySnapshot.forEach((doc) => {
                        const p = doc.data();
                        const date = p.fecha?.toDate().toLocaleDateString() || 'Hoy';
                        const category = p.categoria || 'General';
                        postsHtml += `
                            <div class="glass p-8 rounded-3xl mb-6 bg-white border-l-8 border-[#025964] shadow-sm hover:shadow-md transition-shadow relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-5 text-[#025964]"><i class="ph ph-chat-circle-dots text-4xl"></i></div>
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] font-black shadow-sm uppercase">${p.autor.charAt(0)}</div>
                                        <div>
                                            <span class="font-black text-slate-800 text-sm block leading-none mb-1">${p.autor}</span>
                                            <span class="text-[8px] font-black bg-teal-50 text-teal-600 px-2 py-0.5 rounded-md border border-teal-100 uppercase tracking-widest">${category}</span>
                                        </div>
                                    </div>
                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 px-3 py-1 rounded-full">${date}</span>
                                </div>
                                <p class="text-slate-600 font-medium leading-relaxed whitespace-pre-wrap">${p.mensaje}</p>
                            </div>`;
                    });
                } catch (e) { postsHtml = '<p class="text-slate-400 text-center font-bold">Inicia la conversación compartiendo tus logros o necesidades arriba.</p>'; }

                container.innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto">
                        <!-- ESPACIO PARA LAS PAUSAS REFLEXIVAS QUINCENALES -->
                        <div id="pausa-reflexiva-container"></div>

                        <div id="foro-publicar-container" class="glass p-8 rounded-[2.5rem] mb-12 bg-white relative shadow-xl border border-slate-100">
                            <h4 class="text-[11px] font-black text-[#025964] uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                                <i class="ph ph-plus-circle text-lg"></i> Publicar en el Foro Docente
                            </h4>
                            
                            <!-- BANNER DE PROPÓSITO -->
                            <div class="mb-6 p-4 bg-teal-50/50 rounded-2xl border border-teal-100/50 flex items-start gap-3">
                                <i class="ph-fill ph-info text-teal-500 mt-1"></i>
                                <p class="text-[10px] font-bold text-teal-800 leading-relaxed">
                                    <span class="block mb-1 uppercase tracking-wider">Tu voz guía nuestra asesoría</span>
                                    La información que compartes es un elemento esencial para el apoyo técnico y pedagógico que brindamos. ¡Cada aporte cuenta!
                                </p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="space-y-2">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Eje Temático / Categoría</label>
                                    <select id="foro-categoria" onchange="window.mostrarGuiaForo()" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 text-xs font-bold text-slate-600 outline-none focus:border-[#025964] focus:bg-white transition-all appearance-none cursor-pointer">
                                        <option value="Logros en el Aula">🚀 Logros: Corto, Mediano y Largo Plazo</option>
                                        <option value="Planeamiento y Macro">📋 Planeamiento: Macro y Microcurrículo</option>
                                        <option value="Necesidad de Apoyo">🆘 Apoyo: Dudas Técnicas o Pedagógicas</option>
                                        <option value="Áreas Técnicas PNFT">💻 Saberes: Progra, Robótica, IA o Datos</option>
                                        <option value="Reflexión Docente">✨ Reflexión: Pausas y Desafíos 2026</option>
                                        <option value="General" selected>💬 Conversación General / Otros</option>
                                    </select>
                                </div>
                            </div>

                            <!-- CUADRO DE PREGUNTAS ORIENTADORAS -->
                            <div id="foro-guia-box" class="hidden mb-6 p-6 bg-teal-50/50 border border-teal-100 rounded-3xl animate-in fade-in slide-in-from-top-4 duration-500">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-8 h-8 bg-teal-500 rounded-xl flex items-center justify-center text-white text-sm shadow-sm">
                                        <i class="ph-bold ph-lightbulb"></i>
                                    </div>
                                    <h6 class="text-[11px] font-black text-teal-800 uppercase tracking-widest">Preguntas Orientadoras</h6>
                                </div>
                                <ul id="foro-guia-list" class="space-y-3">
                                    <!-- Se llena dinámicamente -->
                                </ul>
                            </div>

                            <textarea id="foro-msg" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-6 text-slate-800 text-sm focus:border-[#025964] focus:bg-white outline-none resize-none transition-all placeholder:text-slate-300 font-medium" rows="3" placeholder="Describe tu experiencia, logro o necesidad pedagógica aquí..."></textarea>
                            
                            <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
                                <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest leading-relaxed max-w-sm">
                                    Esta información es utilizada por la asesoría para detectar tendencias y mejorar el acompañamiento docente.
                                </p>
                                <button onclick="publicarForo()" class="w-full md:w-auto bg-[#025964] hover:bg-[#008e9b] text-white px-10 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-lg shadow-[#025964]/10 flex items-center justify-center gap-3">
                                    Enviar al Foro <i class="ph-bold ph-paper-plane-tilt"></i>
                                </button>
                            </div>
                        </div>
                        <div id="foro-feed">${postsHtml}</div>
                    </div>
                `;

                // DISPARAR RENDER DE PAUSAS REFLEXIVAS
                setTimeout(() => window.renderizarPausaReflexiva(), 100);

                // --- VISTA: ASESOR IA (IA #2) ---
            } else if (view === 'ia') {
                title.innerText = "Asistente Estratégico";
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 h-[calc(100vh-220px)] fade-in">
                        <div class="lg:col-span-3 glass rounded-[2.5rem] flex flex-col overflow-hidden bg-white">
                            <header class="px-8 py-5 border-b border-slate-100 flex items-center gap-4 bg-[#f1f8f9]">
                                <div class="w-10 h-10 bg-[#025964] rounded-xl flex items-center justify-center text-white shadow-lg shadow-[#025964]/10">
                                    <i class="ph-fill ph-robot text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-black text-slate-800 leading-none">Asesoría de Informática Digital</h4>
                                    <p class="text-[10px] text-[#025964] font-black uppercase tracking-widest mt-1.5 flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#008e9b] animate-pulse"></span> Sistema Activo
                                    </p>
                                </div>
                            </header>
                            <div id="chat-history" class="flex-1 p-8 overflow-y-auto space-y-6">
                                <div class="flex gap-4">
                                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle"></i></div>
                                    <div class="bg-slate-50 p-6 rounded-3xl rounded-tl-none max-w-[85%] text-sm font-medium text-slate-600 leading-relaxed shadow-sm">
                                        Me alegra saludarte. Soy tu asistente virtual impulsado por la visión 2026. Puedo resolver dudas normativas, metodológicas o simplemente escucharte. <br><br> ¿En qué podemos avanzar hoy?
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 bg-white border-t border-slate-100">
                                <div class="flex gap-4 bg-slate-50 p-2 rounded-[2rem] shadow-inner border border-slate-100 focus-within:bg-white focus-within:border-[#025964] transition-all">
                                    <input type="text" id="chat-input" class="flex-1 bg-transparent px-6 py-4 text-sm font-medium outline-none text-slate-800" placeholder="Escribe tu consulta pedagógica aquí...">
                                    <button onclick="enviarChatIA()" class="w-14 h-14 bg-[#025964] hover:bg-[#008e9b] rounded-3xl flex items-center justify-center text-white shadow-xl shadow-[#025964]/10 transition-all active:scale-90 flex-shrink-0">
                                        <i class="ph-bold ph-paper-plane-right text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="glass p-8 rounded-[2.5rem] hidden lg:block bg-gradient-to-b from-white to-teal-50/50">
                            <h4 class="font-black text-teal-600 text-[10px] uppercase tracking-widest mb-6 px-1">Consultas Frecuentes</h4>
                            <ul class="space-y-4">
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('¿Cómo evalúo competencias?')">
                                    <i class="ph ph-circles-three-plus text-lg"></i> Redacción de Competencias
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Estrategias de mediación tecnológica')">
                                    <i class="ph ph-cpu text-lg"></i> Mediación Tecnológica
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Reglamento de licencias actual')">
                                    <i class="ph ph-scales text-lg"></i> Base Normativa
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Ideas para un recreo creativo')">
                                    <i class="ph ph-popcorn text-lg"></i> Inspiración Diaria
                                </li>
                            </ul>
                        </div>
                    </div>
                `;

                // --- VISTA: ADMIN PANEL ---
            } else if (view === 'admin') {
                title.innerText = "Centro de Gestión PNFT";
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
                        <!-- Left: Stats and Charts -->
                        <div class="lg:col-span-1 space-y-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                                <h4 class="text-[10px] font-black text-[#025964] uppercase tracking-widest mb-6 px-1">Estado del Ecosistema</h4>
                                <canvas id="adminChart" class="w-full"></canvas>
                                <div class="mt-8 grid grid-cols-2 gap-4">
                                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <p class="text-2xl font-black text-slate-800" id="admin-stat-instituciones">0</p>
                                        <p class="text-[10px] font-black uppercase text-slate-400">Inst. Activas</p>
                                    </div>
                                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <p class="text-2xl font-black text-slate-800" id="admin-stat-docentes">0</p>
                                        <p class="text-[10px] font-black uppercase text-slate-400">Docentes</p>
                                    </div>
                                </div>
                            </div>

                            <!-- IA HUB Administrativo -->
                            <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden shadow-xl shadow-[#025964]/10">
                                <i class="ph-fill ph-shield-check absolute -right-10 -bottom-10 text-white/5 text-[15rem]"></i>
                                <div class="relative z-10">
                                    <h4 class="text-lg font-black mb-4 flex items-center gap-2 uppercase tracking-tighter"><i class="ph-bold ph-magic-wand text-teal-400"></i> Admin IA HUB</h4>
                                    
                                    <div class="mb-4">
                                        <label class="text-[9px] font-black uppercase tracking-widest text-teal-200/50 mb-2 block">Seleccione herramienta:</label>
                                        <select id="admin-ia-type" onchange="window.toggleAdminPDFButton()" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-[10px] font-bold text-white outline-none focus:bg-white/20 transition-all cursor-pointer appearance-none">
                                            <option value="reporte" class="bg-[#025964]">Reporte Técnico de Visita</option>
                                            <option value="circular" class="bg-[#025964]">Redactar Circular/Oficio</option>
                                            <option value="pia" class="bg-[#025964]">Audit Pedagógica (Subir PDF)</option>
                                            <option value="agenda" class="bg-[#025964]">Preparador de Agenda Visita</option>
                                            <option value="analisis" class="bg-[#025964]">Análisis de Tendencias</option>
                                        </select>
                                    </div>

                                    <div id="admin-pdf-container" class="hidden mb-4">
                                        <input type="file" id="admin-ia-pdf" class="hidden" accept=".pdf" onchange="window.procesarPDFAdmin()">
                                        <button onclick="document.getElementById('admin-ia-pdf').click()" class="w-full bg-teal-500/20 border border-teal-500/30 text-teal-300 py-3 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-teal-500/30 transition-all flex items-center justify-center gap-2">
                                            <i class="ph-bold ph-file-pdf text-lg"></i> <span id="admin-pdf-status">Cargar Planeamiento PDF</span>
                                        </button>
                                    </div>

                                    <textarea id="admin-ia-input" class="w-full bg-white/10 border border-white/10 rounded-2xl p-4 text-xs text-white placeholder:text-teal-200/30 outline-none focus:bg-white/20 transition-all mb-4" rows="4" placeholder="Ej: El docente tiene dudas con Design Thinking..."></textarea>
                                    
                                    <button onclick="ejecutarHerramientaIA()" id="btn-ia-admin" class="w-full bg-white text-[#025964] py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                                        <i class="ph ph-sparkle"></i> Procesar con IA
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Institution Management -->
                        <div class="lg:col-span-2 space-y-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 relative overflow-hidden">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                                    <div>
                                        <h3 class="text-2xl font-black text-slate-800 mb-1 uppercase tracking-tighter">Gestión de Instituciones</h3>
                                        <div class="flex gap-4 mt-2">
                                            <button onclick="filtrarAsesor('todos')" id="filter-todos" class="text-[9px] font-black uppercase tracking-widest text-[#025964] border-b-2 border-[#025964]">Todos</button>
                                            <button onclick="filtrarAsesor('alberto')" id="filter-alberto" class="text-[9px] font-black uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:text-[#025964] transition-all">Docentes Alberto Bustos O.</button>
                                            <button onclick="filtrarAsesor('rodolfo')" id="filter-rodolfo" class="text-[9px] font-black uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:text-[#025964] transition-all">Docentes Rodolfo Juárez P.</button>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.crearInstitucion()" class="bg-teal-500 text-white px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-teal-600 transition-all shadow-lg shadow-teal-500/10">
                                            <i class="ph-bold ph-plus"></i> Nueva
                                        </button>
                                        <button onclick="window.mostrarInstituciones()" class="bg-slate-50 border border-slate-100 text-slate-600 px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 transition-all">
                                            <i class="ph-bold ph-buildings"></i> Centros
                                        </button>
                                        <button onclick="window.listarUsuarios()" class="bg-[#025964] text-white px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-[#008e9b] transition-all">
                                            <i class="ph-bold ph-users-four"></i> Usuarios
                                        </button>
                                        <button onclick="window.mostrarBitacora()" class="bg-slate-50 border border-slate-100 text-slate-600 px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 transition-all">
                                            <i class="ph-bold ph-notebook"></i> Bitácora
                                        </button>
                                        <button onclick="window.mostrarDiagnostico()" class="bg-rose-50 border border-rose-100 text-rose-600 px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-rose-100 transition-all">
                                            <i class="ph-bold ph-strategy"></i> Diagnóstico
                                        </button>
                                        <button onclick="document.getElementById('excel-upload').click()" class="aspect-square bg-slate-50 border border-slate-200 text-slate-400 p-3 rounded-xl hover:text-green-600 hover:border-green-200 transition-all" title="Importar Excel">
                                            <i class="ph-bold ph-file-xls text-lg"></i>
                                        </button>
                                        <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden" onchange="window.procesarExcel(this)">
                                    </div>
                                </div>

                                <!-- UI de Progreso de Excel -->
                                <div id="excel-progress-container" class="hidden mb-8 p-6 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 animate-pulse-slow">
                                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 bg-[#025964] rounded-2xl flex items-center justify-center text-white shadow-lg shadow-[#025964]/20"><i class="ph-bold ph-spinner-gap animate-spin"></i></div>
                                            <div>
                                                <p id="excel-progress-text" class="text-[10px] font-black text-slate-800 uppercase tracking-widest leading-none mb-1">Cargando información...</p>
                                                <p id="excel-detail-text" class="text-[9px] font-bold text-slate-400 uppercase">Validando registros...</p>
                                            </div>
                                        </div>
                                        <button onclick="window.abortarCargaExcel = true" class="bg-rose-50 text-rose-500 px-5 py-2.5 rounded-xl font-black text-[9px] uppercase tracking-widest border border-rose-100 hover:bg-rose-500 hover:text-white transition-all flex items-center gap-2 shadow-sm">
                                            <i class="ph-bold ph-stop"></i> Detener Carga
                                        </button>
                                    </div>
                                    <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                        <div id="excel-progress-bar" class="h-full bg-teal-500 transition-all duration-300 w-0"></div>
                                    </div>
                                </div>

                                <!-- NUEVA SECCIÓN: DIAGNÓSTICO ESTRATÉGICO -->
                                <div id="admin-diagnostico-section" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <!-- KPIs de Necesidad -->
                                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                                                <h6 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Índice de Necesidad</h6>
                                                <div class="flex items-end gap-3">
                                                    <span id="diag-score" class="text-3xl font-black text-[#025964]">0%</span>
                                                    <span class="text-[9px] font-bold text-slate-400 mb-2">de posts requieren apoyo</span>
                                                </div>
                                            </div>
                                            <div class="p-6 bg-rose-50 rounded-3xl border border-rose-100">
                                                <h6 class="text-[9px] font-black text-rose-400 uppercase tracking-widest mb-2">Alertas Rojas</h6>
                                                <div class="flex items-end gap-3">
                                                    <span id="diag-alerts" class="text-3xl font-black text-rose-600">0</span>
                                                    <span class="text-[9px] font-bold text-rose-400 mb-2">mensajes críticos detectados</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Botón de Reporte IA -->
                                        <div class="p-6 bg-[#025964] rounded-3xl shadow-xl shadow-[#025964]/10 relative overflow-hidden group border border-white/10">
                                            <i class="ph-fill ph-sparkle absolute -right-4 -bottom-4 text-white/5 text-6xl group-hover:scale-125 transition-transform duration-700"></i>
                                            <h6 class="text-[9px] font-black text-teal-300 uppercase tracking-widest mb-4">Análisis Inteligente</h6>
                                            <button onclick="window.generarReporteIA()" id="btn-diag-ia" class="w-full bg-white text-[#025964] py-3 rounded-xl font-black text-[9px] uppercase tracking-widest hover:scale-[1.02] transition-all flex items-center justify-center gap-2 shadow-lg">
                                                <i class="ph-bold ph-newspaper-clipping"></i> Generar Reporte 2026
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Panel de Alertas y Regionales -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div class="space-y-4">
                                            <h5 class="text-[10px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-2"><i class="ph-bold ph-warning-circle text-rose-500"></i> Alertas de Atención Inmediata</h5>
                                            <div id="diag-alerts-list" class="space-y-3 max-h-[400px] overflow-y-auto no-scrollbar">
                                                <p class="text-[10px] text-slate-400 italic py-8 text-center bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">No hay alertas críticas pendientes</p>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <h5 class="text-[10px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-2"><i class="ph-bold ph-map-pin text-[#025964]"></i> Impacto por Regional</h5>
                                            <div id="diag-regional-list" class="space-y-3">
                                                <p class="text-[10px] text-slate-400 italic py-8 text-center">Analizando datos regionales...</p>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <h5 class="text-[10px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-2"><i class="ph-bold ph-eye-slash text-amber-500"></i> Atención por Silencio (Inactivos)</h5>
                                            <div id="diag-inactive-list" class="space-y-3 max-h-[400px] overflow-y-auto no-scrollbar">
                                                <!-- Se llena con usuarios que tienen 0 posts -->
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Área de Resultados IA -->
                                    <div id="diag-ia-result" class="hidden animate-in fade-in zoom-in-95 duration-500">
                                        <div class="p-8 bg-teal-50/50 border border-teal-100 rounded-[2.5rem]">
                                            <div class="flex items-center gap-3 mb-6">
                                                <div class="w-10 h-10 bg-teal-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-teal-500/20"><i class="ph-fill ph-brain"></i></div>
                                                <div>
                                                    <h6 class="text-xs font-black text-teal-800 uppercase">Síntesis de Priorización Estratégica</h6>
                                                    <p class="text-[9px] font-bold text-teal-600/60 uppercase">Análisis generado por IA</p>
                                                </div>
                                            </div>
                                            <div id="diag-ia-content" class="text-slate-700 font-medium text-[11px] leading-relaxed">
                                                <!-- Contenido generado -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="admin-instituciones-container" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 no-scrollbar">
                                    <div id="admin-instituciones-list" class="grid grid-cols-1 gap-6">
                                        <!-- Cargando state -->
                                        <div class="flex flex-col items-center p-20">
                                            <div class="w-10 h-10 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sincronizando centros...</p>
                                        </div>
                                    </div>
                                </div>

                                    <!-- User Management Section (Hidden by default) -->
                                    <div id="admin-usuarios-list" class="hidden space-y-4">
                                        <div class="flex items-center justify-center p-12 text-slate-400 font-bold italic">
                                            Cargando lista de usuarios...
                                        </div>
                                    </div>

                                    <!-- CONTENEDOR DE FICHA DOCENTE / HISTORIAL -->
                                <div id="admin-usuario-actividad" class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div class="flex items-center justify-between mb-8">
                                        <button onclick="window.listarUsuarios()" class="text-[9px] font-black text-[#025964] uppercase tracking-widest flex items-center gap-2 hover:bg-slate-50 px-4 py-2 rounded-xl transition-all">
                                            <i class="ph-bold ph-arrow-left"></i> Volver a la lista
                                        </button>
                                        <div class="text-right">
                                            <h4 id="actividad-nombre" class="text-sm font-black text-slate-800 uppercase leading-none mb-1">Cargando...</h4>
                                            <p id="actividad-info" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Generando historial del foro</p>
                                        </div>
                                    </div>
                                    <div id="actividad-timeline" class="space-y-4">
                                        <!-- Se llena con los posts del usuario -->
                                    </div>
                                </div>

                                    <!-- Bitácora de Seguimiento Section -->
                                    <div id="admin-bitacora-section" class="hidden space-y-6">
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                            <!-- Formulario de Aporte -->
                                            <div class="space-y-4 bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                                                <h4 class="text-sm font-black text-[#025964] uppercase tracking-widest mb-4">Nuevo Aporte de Seguimiento</h4>
                                                <div class="grid grid-cols-2 gap-4">
                                                    <input type="date" id="bitacora-fecha" class="input-field text-xs">
                                                    <input type="text" id="bitacora-inst" class="input-field text-xs" placeholder="Nombre Institución">
                                                </div>
                                                <textarea id="bitacora-detalle" class="input-field text-xs min-h-[100px]" placeholder="Aspectos tratados y observaciones principales..."></textarea>
                                                <textarea id="bitacora-reporte" class="input-field text-[10px] min-h-[150px] font-mono" placeholder="Pegue aquí el texto completo del informe técnico..."></textarea>
                                                <button onclick="window.guardarAporteBitacora()" class="w-full bg-[#025964] text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg hover:bg-teal-600 transition-all flex items-center justify-center gap-2">
                                                    <i class="ph ph-plus-circle"></i> Guardar Aporte
                                                </button>
                                            </div>

                                            <!-- Resumen e Historial -->
                                            <div class="space-y-4">
                                                <div id="bitacora-resumen-ia" class="bg-[#025964] text-white p-6 rounded-[2rem] shadow-xl relative overflow-hidden min-h-[200px]">
                                                    <h4 class="text-xs font-black uppercase tracking-widest mb-4 border-b border-white/10 pb-2">Resumen IA de Seguimiento</h4>
                                                    <div id="bitacora-ia-output" class="text-[11px] leading-relaxed italic text-teal-50">
                                                        Los resúmenes técnicos aparecerán aquí tras analizar el historial.
                                                    </div>
                                                    <button onclick="window.analizarBitacoraIA()" id="btn-analizar-bitacora" class="mt-4 w-full bg-white text-[#025964] py-2 rounded-lg font-black text-[10px] uppercase tracking-widest hover:bg-teal-50 transition-all">Analizar Historial</button>
                                                </div>
                                                
                                                <div class="bg-white border border-slate-100 p-6 rounded-[2rem] max-h-[300px] overflow-y-auto no-scrollbar">
                                                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Historial Reciente</h4>
                                                    <div id="bitacora-historial-list" class="space-y-3">
                                                        <p class="text-[10px] text-slate-400 italic text-center py-4">Sin aportes registrados</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Initialize Charts
                setTimeout(() => {
                    initAdminCharts();
                    window.updateAdminChart();
                    window.toggleAdminPDFButton();
                    window.mostrarInstituciones();
                    // Limpiar estado de progreso si existe
                    const progressContainer = document.getElementById('excel-progress-container');
                    if (progressContainer) progressContainer.classList.add('hidden');
                }, 100);
            }
        };

        const initAdminCharts = () => {
            const ctx = document.getElementById('adminChart')?.getContext('2d');
            if (!ctx) return;
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Continuidad', 'Prioritario', 'Urgente'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: ['#008e9b', '#f59e0b', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    family: 'Lato',
                                    size: 10,
                                    weight: '900'
                                },
                                usePointStyle: true,
                            }
                        }
                    }
                }
            });
        };

        window.toggleAdminPDFButton = () => {
            const type = document.getElementById('admin-ia-type').value;
            const container = document.getElementById('admin-pdf-container');
            if (type === 'pia') container.classList.remove('hidden');
            else container.classList.add('hidden');
        };

        window.procesarPDFAdmin = async () => {
            const file = document.getElementById('admin-ia-pdf').files[0];
            if (!file) return;

            const status = document.getElementById('admin-pdf-status');
            status.innerText = "Leyendo documento...";

            try {
                const reader = new FileReader();
                reader.onload = async function () {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const strings = content.items.map(item => item.str);
                        fullText += strings.join(" ") + "\n";
                    }
                    document.getElementById('admin-ia-input').value = fullText;
                    status.innerText = "📄 PDF Cargado con éxito";
                    msg("✅ Texto extraído del PDF", "success");
                };
                reader.readAsArrayBuffer(file);
            } catch (e) {
                console.error(e);
                status.innerText = "Error al leer PDF";
                msg("⛔ Error al procesar el PDF", "err");
            }
        };

        window.ejecutarHerramientaIA = async () => {
            const input = document.getElementById('admin-ia-input');
            const type = document.getElementById('admin-ia-type').value;
            const txt = input.value.trim();
            if (!txt) return msg("⚠️ Por favor ingrese información o suba un planeamiento", "normal");

            const btn = document.getElementById('btn-ia-admin');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-teal-600 border-t-transparent rounded-full animate-spin"></div> Procesando...`;
            btn.disabled = true;

            const prompts = {
                reporte: `Genera un REPORTE TÉCNICO FORMAL de visita para el PNFT. Detalles: "${txt}". Formato: 1. Resumen, 2. Acción Sugerida, 3. Clasificación.`,
                circular: `Redacta un OFICIO/CIRCULAR oficial del PNFT dirigido a docentes/directores. Contexto: "${txt}". Tono formal, empoderador y técnico.`,
                pia: `ACTÚA COMO AUDITOR PEDAGÓGICO DE ALTO NIVEL DEL PNFT 2026. 
                Analiza el siguiente PLANEAMIENTO (PIA) y verifica el cumplimiento de:
                
                1. CONGRUENCIA 2026: ¿Se alinea con las Orientaciones Didácticas y la Guía 2026?
                2. MÓDULOS Y SABERES: ¿Corresponden los saberes a los niveles de Sétimo, Octavo o Noveno según la Guía? (Verifica contra: Computación Física y Robótica, IA, Programación y Algoritmos, Apropiación Tecnológica y Digital).
                3. COMPONENTE PROYECTO: ¿El planeamiento desarrolla la Resolución de Problemas bajo las 5 fases de Design Thinking (Empatizar, Definir, Idear, Prototipar, Probar y Evaluar)?
                4. EVALUACIÓN: ¿Se incluyen indicadores de logro técnicos y actitudinales claros?
                
                CONTENIDO DEL PLANEAMIENTO:
                "${txt}"
                
                DA UN DICTAMEN TÉCNICO: 
                - Puntos Fuertes.
                - Omisiones Críticas.
                - Recomendación de Mejora Directa.`,
                agenda: `Crea una AGENDA DE VISITA técnica para una institución. Contexto: "${txt}". Incluye tiempos, objetivos técnicos y pedagógicos.`,
                analisis: `Analiza la siguiente tendencia/situación observada en el campo: "${txt}". Indica posibles riesgos, oportunidades de capacitación y impacto en el programa.`
            };

            try {
                const respuesta = await llamarGemini(prompts[type], 'general');
                const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

                const oldRes = document.getElementById('admin-ia-result');
                if (oldRes) oldRes.remove();

                const resDiv = document.createElement('div');
                resDiv.id = 'admin-ia-result';
                resDiv.className = 'mt-6 p-6 bg-white/10 rounded-2xl text-[11px] text-teal-50 border border-white/20 fade-in leading-relaxed max-h-[400px] overflow-y-auto no-scrollbar';
                resDiv.innerHTML = `<div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                                        <h5 class="font-black uppercase">Resultado IA Hub</h5>
                                        <button onclick="this.parentElement.parentElement.remove()" class="text-teal-300 hover:text-white"><i class="ph ph-x"></i></button>
                                    </div>
                                    ${htmlRes}
                                    <div class="mt-4 pt-4 border-t border-white/10">
                                        <button onclick="navigator.clipboard.writeText(this.parentElement.previousSibling.textContent); msg('✅ Copiado', 'success')" class="text-[9px] font-black uppercase text-teal-300 hover:text-white flex items-center gap-2">
                                            <i class="ph ph-copy"></i> Copiar resultado
                                        </button>
                                    </div>`;
                input.parentElement.appendChild(resDiv);
            } catch (e) {
                console.error(e);
                msg("⛔ Error con la IA", "err");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.filtrarAsesor = (asesor) => {
            const btns = ['todos', 'alberto', 'rodolfo'];
            btns.forEach(id => {
                const el = document.getElementById(`filter-${id}`);
                if (el) {
                    el.classList.toggle('text-[#025964]', id === asesor);
                    el.classList.toggle('border-[#025964]', id === asesor);
                    el.classList.toggle('text-slate-400', id !== asesor);
                    el.classList.toggle('border-transparent', id !== asesor);
                }
            });
            window.currentAsesorFilter = asesor;
            if (!document.getElementById('admin-usuarios-list').classList.contains('hidden')) {
                window.listarUsuarios(asesor);
            } else {
                window.mostrarInstituciones(asesor);
            }
        };

        window.switchLevelTab = (level) => {
            const area = document.getElementById('level-content-area');
            const btns = document.querySelectorAll('.level-tab-btn');
            btns.forEach(b => b.classList.remove('bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10'));
            btns.forEach(b => b.classList.add('text-slate-400'));
            const activeBtn = document.getElementById(`level-btn-${level}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10');
                activeBtn.classList.remove('text-slate-400');
            }
            const info = window.SABERES_DATA[level];
            let html = `<h4 class="text-2xl font-black text-slate-800 mb-8 flex items-center gap-3">${info.title}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">`;

            info.modulos.forEach(mod => {
                html += `
                    <div class="space-y-6">
                        <div class="flex items-center gap-4 mb-4">
                            <span class="w-10 h-10 bg-[#f1f8f9] rounded-xl flex items-center justify-center text-[#025964] font-black text-sm border border-[#025964]/10">${mod.n.charAt(mod.n.length - 1)}</span>
                            <h5 class="text-xl font-black text-slate-700 uppercase tracking-tighter">${mod.n}</h5>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${mod.s.map(saberObj => `
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-[#025964]/20 transition-all">
                                    <div class="flex items-center gap-4">
                                        <div class="w-2 h-2 rounded-full bg-[#025964]/20 group-hover:bg-[#025964] transition-colors"></div>
                                        <span class="text-sm font-bold text-slate-600">${saberObj.n}</span>
                                    </div>
                                    <span class="text-[8px] font-black uppercase text-teal-600 tracking-tighter opacity-40 group-hover:opacity-100 transition-opacity">${saberObj.a}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            area.innerHTML = html;
        };

        window.switchOrientTab = (tab) => {
            const content = document.getElementById('orient-main-content');
            const btns = document.querySelectorAll('.orient-tab-btn');
            btns.forEach(b => b.classList.remove('active', 'bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10'));
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            if (activeBtn) activeBtn.classList.add('active', 'bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10');

            const templates = {
                admin: `
                    <div class="space-y-10 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm mb-8">
                             <p class="text-slate-500 font-medium leading-loose mb-6">
                                A continuación, presento los detalles del contenido administrativo de las <b>"Orientaciones generales para docentes 2026"</b>, enfocados exclusivamente en el nivel de <b>Secundaria</b> (III Ciclo y Educación Diversificada/Vocacional). Se recomienda la lectura completa del documento para profundizar en los aspectos mencionados, con la finalidad de complementar la comprensión total del importante aporte pedagógico a brindar a los estudiantes en el presente curso lectivo 2026.
                             </p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-8">
                                <!-- 1. Niveles de Implementación -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] transition-transform group-hover:rotate-6"><i class="ph-bold ph-users-three text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">1. Niveles e Implementación</h4>
                                    </div>
                                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed">
                                        <p><b>III Ciclo (Académico):</b> Obligatorio en 7°, 8° y 9°.</p>
                                        <p><b>Diversificada (IV Ciclo):</b> <span class="text-rose-500 font-bold uppercase">No se implementa</span> el currículo de Formación Tecnológica en este ciclo para 2026.</p>
                                        <p><b>CTP (Vocacional):</b> <span class="text-[#025964] font-black uppercase">Sí se implementa</span> en la oferta de III Ciclo y Ciclo Diversificado Vocacional (Plan Nacional).</p>
                                        <p><b>Población Vocacional:</b> Tiene <span class="bg-amber-50 px-2 py-0.5 rounded text-amber-700 font-bold">prioridad de atención</span> al elaborar el horario institucional.</p>
                                        <p><b>EPJA:</b> Implementado en CAN, IPEC, CINDEA y CONED según disponibilidad.</p>
                                    </div>
                                </div>

                                <!-- 2. Carga Horaria -->
                                <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden group">
                                    <i class="ph-fill ph-clock absolute -right-6 -bottom-6 text-white/5 text-[10rem]"></i>
                                    <div class="relative z-10">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center text-white"><i class="ph-bold ph-timer text-3xl"></i></div>
                                            <h4 class="text-xl font-black uppercase tracking-tighter">2. Carga Horaria (Secundaria)</h4>
                                        </div>
                                        <ul class="space-y-4 text-sm text-teal-50 leading-relaxed font-medium">
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-info text-teal-400"></i> Asignación según <b>matrícula</b> (no cuota fija).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin Codocencia (Docente único responsable).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin Gestión Técnico-Pedagógica (GTP).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin CHIM (Carga Horaria Inferior Mínima).</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                <!-- 3. Gestión de Recurso -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964]"><i class="ph-bold ph-desktop text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">3. Gestión del Recurso</h4>
                                    </div>
                                    <div class="space-y-4 text-xs text-slate-500 font-medium leading-relaxed">
                                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                            <p class="text-[#025964] font-black uppercase mb-1 underline">Prioridad Absoluta</p>
                                            <p>Lecciones de FT tienen prioridad sobre reuniones o capacitaciones externas.</p>
                                        </div>
                                        <p><b>Carpeta Institucional:</b> Planeamientos, registros, inventarios, reportes de mantenimiento y incidentes.</p>
                                        <p><b>TecnoPresta:</b> Actualización obligatoria de inventario (2 revisiones anuales).</p>
                                        <p><b>Bitácora de Control:</b> Registro obligatorio de uso y traslado de equipos.</p>
                                    </div>
                                </div>

                                <!-- 4. Administración Evaluación -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-[#025964]/10 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964]"><i class="ph-bold ph-notebook text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">4. Administración de Evaluación</h4>
                                    </div>
                                    <div class="space-y-4 text-xs text-slate-600 font-bold leading-relaxed">
                                        <p>Componente Principal: <b>PROYECTO.</b></p>
                                        <p>Desarrollo estricto en las <b>2 lecciones semanales.</b></p>
                                        <p>Instrumentos aprobados por el Comité de Evaluación Institucional.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Funciones Generales -->
                        <div class="glass p-10 rounded-[3rem] bg-slate-50 border border-slate-200 mt-10">
                            <h4 class="text-xl font-black text-slate-800 mb-6 uppercase flex items-center gap-3"><i class="ph-bold ph-briefcase text-[#025964]"></i> 5. Funciones Administrativas Generales</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Atención Correo Oficial MEP</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Registro Sistema SEA / SEA</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Bitácora Mensual Vigente</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Revisión Repositorio PNFT</div>
                            </div>
                        </div>
                    </div>
                `,
                peda: `
                    <div class="space-y-12 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm">
                            <p class="text-slate-500 font-medium leading-loose">
                                Basándose en el documento <b>"Orientaciones generales para docentes 2026"</b>, se definen los niveles de concreción que guían la labor docente en el Programa Nacional de Formación Tecnológica (PNFT).
                            </p>
                        </div>

                        <!-- 1. Niveles de Concreción -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group hover:border-[#025964]/20 transition-all">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] transition-transform group-hover:scale-105"><i class="ph-bold ph-strategy text-3xl"></i></div>
                                    <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Macro Currículo</h4>
                                </div>
                                <p class="text-sm text-slate-600 leading-relaxed">
                                    Representa el <b>Programa de Estudio oficial (PNFT)</b>. Es el nivel nacional que define las competencias, saberes y resultados de aprendizaje (RdA) obligatorios para todos los centros educativos del país.
                                </p>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group hover:border-[#025964]/20 transition-all">
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] transition-transform group-hover:scale-105"><i class="ph-bold ph-chalkboard-teacher text-3xl"></i></div>
                                    <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Micro Currículo</h4>
                                </div>
                                <p class="text-sm text-slate-600 leading-relaxed">
                                    Es la <b>mediación pedagógica y el planeamiento didáctico</b>. Es donde el docente adapta el macro currículo a la realidad de su aula, diversificando estrategias según el contexto y necesidades de sus estudiantes.
                                </p>
                            </div>
                        </div>

                        <!-- 2. Enfoque Metodológico -->
                        <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                            <h4 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-4 uppercase tracking-tighter">2. Enfoque Metodológico: Design Thinking</h4>
                            <div class="space-y-6 text-slate-600 leading-relaxed">
                                <p>Para secundaria, la pedagogía se centra en metodologías activas donde el estudiante es el protagonista de la <b>Resolución de Problemas</b>.</p>
                                <ul class="space-y-4">
                                    <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Fases Oficiales:</b> El proceso debe vivir las 5 etapas: <b>Empatizar, Definir, Idear, Prototipar, Probar y Evaluar.</b></div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Áreas de Conocimiento PNFT:</b> Los proyectos se articulan mediante:<br>
                                        <span class="text-[10px] font-black text-[#025964] tracking-widest uppercase mt-2 block">
                                            • Apropiación Tecnológica y Digital<br>
                                            • Programación y Algoritmos<br>
                                            • Ciencias de Datos e Inteligencia Artificial<br>
                                            • Computación Física y Robótica
                                        </span>
                                    </div></li>
                                </ul>
                            </div>
                        </div>

                        <!-- 3. La Evaluación -->
                        <div class="glass p-10 rounded-[2.5rem] bg-[#f1f8f9] border border-[#025964]/10">
                            <h4 class="text-2xl font-black text-[#025964] mb-8 flex items-center gap-4 uppercase tracking-tighter">3. La Evaluación: El Componente Proyecto</h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                <div class="space-y-6">
                                    <p class="text-slate-700 font-bold mb-4">A diferencia de primaria (que usa pruebas de ejecución), la evaluación sumativa en secundaria gira en torno al desarrollo de un proyecto.</p>
                                    <div class="p-6 bg-white rounded-2xl border border-teal-100 shadow-sm">
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Carácter del Proyecto</p>
                                        <p class="text-sm text-slate-600">Es un proceso continuo (diagnóstico, formativo y sumativo) que debe desarrollarse estrictamente dentro de las <b>2 lecciones semanales</b> de Formación Tecnológica.</p>
                                    </div>
                                    <div class="p-6 bg-white rounded-2xl border border-teal-100 shadow-sm">
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Calificación</p>
                                        <p class="text-sm text-slate-600">El porcentaje del proyecto se asigna al finalizar el proceso en cada periodo lectivo.</p>
                                    </div>
                                </div>
                                <div class="p-8 bg-white/50 rounded-3xl border border-teal-100/30">
                                    <h5 class="font-black text-sm uppercase text-[#025964] mb-6">Fases de Evaluación del Proyecto:</h5>
                                    <ul class="space-y-6">
                                        <li>
                                            <p class="font-black text-slate-800 text-sm mb-1">1. Etapa Inicial</p>
                                            <p class="text-xs text-slate-500">Se evalúa la comprensión del problema, la investigación y la planificación mediante indicadores específicos (describir necesidades, sintetizar hallazgos, seleccionar ideas).</p>
                                        </li>
                                        <li>
                                            <p class="font-black text-slate-800 text-sm mb-1">2. Etapa de Desarrollo y Cierre</p>
                                            <p class="text-xs text-slate-500">Se evalúa el prototipado y la solución final utilizando los indicadores de logro de las Áreas de Conocimiento (**Programación y Algoritmos, Computación Física y Robótica, Ciencias de Datos e Inteligencia Artificial**).</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Planeamiento Didáctico -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100">
                            <h4 class="text-2xl font-black text-slate-800 mb-8 uppercase tracking-tighter flex items-center gap-4">4. Planeamiento Didáctico</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600">
                                <ul class="space-y-4">
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Periodicidad:</b> El planeamiento se elabora de forma <b>bimestral</b> (cada dos meses).</div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Nivel vs. Ciclo:</b> Se planifica por nivel educativo (ej. un plan para 7°, otro para 8°).</div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Articulación:</b> Transformar saberes del módulo en experiencias integradas, evitando el aislamiento de áreas.</div></li>
                                </ul>
                                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col justify-between">
                                    <div>
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Estructura de la Plantilla</p>
                                        <p class="text-xs text-slate-500 leading-relaxed mb-4">Referencia actualizada con tres bloques: identificación, matriz de saberes/estrategias/indicadores, y reflexión.</p>
                                    </div>
                                    <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="block w-full text-center bg-[#025964] text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg">Abrir Plantilla Digital 2026</a>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Estructura & 6. Vocacional -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                                <h4 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-tighter">5. Estructura de los Módulos</h4>
                                <ul class="space-y-4 text-xs text-slate-500 font-medium">
                                    <li class="flex gap-2"><span>•</span> <span><b>Cantidad:</b> Dos módulos anuales, uno por cada periodo lectivo.</span></li>
                                    <li class="flex gap-2"><span>•</span> <span><b>Correlación:</b> Segmentos correlacionados; se pueden retomar actividades entre periodos.</span></li>
                                    <li class="flex gap-2"><span>•</span> <span><b>Saberes:</b> Trabajo integrado de saberes conceptuales, procedimentales y actitudinales.</span></li>
                                </ul>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white shadow-xl shadow-[#025964]/10">
                                <h4 class="text-xl font-black mb-6 uppercase tracking-tighter">6. Adaptación Modalidad Vocacional</h4>
                                <div class="space-y-4 text-xs text-teal-50">
                                    <p><b>Diagnóstico Contextualizado:</b> Coordinación obligatoria con el docente guía para identificar necesidades específicas.</p>
                                    <p><b>Selección de Saberes:</b> Basado en diagnóstico, se seleccionan saberes de cualquier ciclo que respondan a las necesidades, priorizando <b>herramientas de productividad.</b></p>
                                </div>
                            </div>
                        </div>

                        <!-- 7. Recursos -->
                        <div class="glass p-10 rounded-[2.5rem] bg-slate-50 border border-slate-200">
                            <h4 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tighter">7. Recursos de Apoyo Pedagógico</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h5 class="font-black text-teal-600 text-xs mb-2">Guías Docentes</h5>
                                    <p class="text-xs text-slate-500">Documentos específicos por ciclo que organizan competencias y resultados de aprendizaje.</p>
                                </div>
                                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h5 class="font-black text-teal-600 text-xs mb-2">PIA (Planificación Integral y Ágil)</h5>
                                    <p class="text-xs text-slate-500">Herramienta opcional basada en IA para apoyar la elaboración técnica del planeamiento.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                plan: `
                    <div class="space-y-12 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm">
                            <h3 class="text-3xl font-black text-slate-800 mb-6 uppercase tracking-tighter">Lineamientos de Planeamiento Didáctico 2026: <span class="text-[#025964]">Enfoque en Secundaria</span></h3>
                            <p class="text-slate-500 font-medium leading-loose mb-8">
                                El planeamiento didáctico se define como el instrumento clave que permite al docente articular los saberes, la metodología y la evaluación de forma intencionada. Para el curso lectivo 2026, la plantilla y los procesos se han actualizado para alinearse con los nuevos módulos del Programa Nacional de Formación Tecnológica (PNFT).
                            </p>
                            <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="inline-flex items-center gap-2 bg-[#025964] text-white px-8 py-3 rounded-2xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.02] transition-all">
                                <i class="ph-bold ph-link"></i> Planificación Docente en Línea
                            </a>
                        </div>

                        <!-- 1. Disposiciones Generales -->
                        <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                            <h4 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-tighter flex items-center gap-3">
                                <div class="w-10 h-10 bg-teal-50 rounded-xl flex items-center justify-center text-teal-600">1</div>
                                1. Disposiciones Generales y Periodicidad
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Periodicidad</p>
                                    <p class="text-sm text-slate-600 font-bold">Bimestral (cada dos meses).</p>
                                </div>
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Por Nivel</p>
                                    <p class="text-sm text-slate-600 font-bold">Plan específico por nivel (7°, 8°, 9°), no por ciclo.</p>
                                </div>
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Base Insumo</p>
                                    <p class="text-sm text-slate-600 font-bold">Módulo correspondiente (Saber-RdA-Indicador).</p>
                                </div>
                            </div>
                        </div>

                        <!-- 2. La Plantilla 2026 -->
                        <div class="glass p-10 rounded-[3rem] border border-[#025964]/10 bg-white">
                            <h4 class="text-2xl font-black text-slate-800 mb-10 uppercase tracking-tighter">2. La Plantilla de Planeamiento 2026</h4>
                            <div class="space-y-8">
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center text-[#025964] shrink-0 font-black">B1</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 1: Identificación General</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Datos institucionales, Ejes Transversales (Pensamiento Computacional, Ciudadanía Digital, Emprendimiento) y Selección Metodológica (Design Thinking recomendado).</p>
                                    </div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-[#025964] rounded-full flex items-center justify-center text-white shrink-0 font-black">B2</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 2: Matriz de Mediación Pedagógica (Núcleo)</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Articulación de RdA, Saberes integrados, Estrategias de mediación (evitar enseñanza aislada) e Indicadores de Evaluación (basados en la Guía Docente).</p>
                                    </div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center text-[#025964] shrink-0 font-black">B3</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 3: Reflexión y Seguimiento</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Análisis de resultados, identificación de logros/dificultades y ajustes en la práctica futura.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Consideraciones Pedagógicas -->
                        <div class="glass p-10 rounded-[3rem] bg-[#025964] text-white">
                            <h4 class="text-2xl font-black mb-8 uppercase tracking-tighter">3. Consideraciones Pedagógicas para Secundaria</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Integración de Áreas</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Evitar abordar saberes de forma aislada; diseñar experiencias que articulen (ej. Programación + Robótica).</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Fases del Proyecto</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Reflejar las 5 fases: Empatizar, Definir, Idear, Prototipar, Probar y Evaluar.</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Saberes Integrales</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Vincular simultáneamente lo conceptual (teoría), procedimental (hacer) y actitudinal (ser).</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Diagnóstico Inicial</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Espacio de máximo 2 lecciones al inicio de cada periodo para determinar el punto de partida.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Insumos & 5. PIA -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                                <h4 class="text-xl font-black text-slate-800 mb-4 uppercase tracking-tighter">4. Insumos Obligatorios</h4>
                                <p class="text-xs text-slate-500 font-medium leading-relaxed mb-4">Uso de la <b>Guía Docente por ciclo</b>: Competencias, RdA, Perfiles de salida y Módulos.</p>
                                <div class="bg-slate-50 p-4 rounded-xl text-[10px] font-bold text-slate-400 uppercase italic">El módulo es la estructura; el planeamiento es la ejecución.</div>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-[#025964]/20">
                                <h4 class="text-xl font-black text-[#025964] mb-4 uppercase tracking-tighter">5. Herramienta de Apoyo: PIA</h4>
                                <p class="text-xs text-slate-500 font-medium leading-relaxed">Recurso opcional basado en <b>Inteligencia Artificial</b> para agilizar la creación de actividades manteniendo la coherencia oficial.</p>
                            </div>
                        </div>
                    </div>
                `,
                eval: `
                    <div class="space-y-10 fade-in">
                        <section class="glass p-12 rounded-[2.5rem] bg-white border border-[#025964]/10 relative overflow-hidden">
                             <div class="relative z-10">
                                <span class="bg-[#025964] text-white text-xs font-black px-6 py-2 rounded-full uppercase tracking-widest mb-8 inline-block shadow-lg shadow-[#025964]/10">Métrica 2026: Secundaria</span>
                                <h4 class="text-5xl font-black text-slate-800 mb-12 tracking-tighter uppercase leading-none">Componente <br><span class="text-[#025964]">Proyecto</span></h4>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                    <div class="p-8 bg-[#f1f8f9] border border-[#025964]/5 rounded-3xl">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-10 h-10 bg-[#025964] rounded-xl flex items-center justify-center text-white"><i class="ph-bold ph-pencil-line"></i></div>
                                            <h5 class="text-lg font-black text-slate-800 uppercase tracking-tighter">Etapa Inicial</h5>
                                        </div>
                                        <p class="text-slate-500 text-sm leading-relaxed mb-6">Foco en el proceso cognitivo y de diseño:</p>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Diagnóstico y definición del problema.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Síntesis de hallazgos clave.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Ideación de soluciones eficientes.</div>
                                        </div>
                                    </div>
                                    <div class="p-8 bg-[#f1f8f9] border border-[#025964]/5 rounded-3xl">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-10 h-10 bg-[#008e9b] rounded-xl flex items-center justify-center text-white"><i class="ph-bold ph-gear-six"></i></div>
                                            <h5 class="text-lg font-black text-slate-800 uppercase tracking-tighter">Etapas Técnicas</h5>
                                        </div>
                                        <p class="text-slate-500 text-sm leading-relaxed mb-6">Foco en la ejecución y saberes digitales:</p>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Implementación de algoritmos, programación y diseño.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Funcionalidad de la resolución de problemas (Prototipo).</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Probar y Evaluar los resultados obtenidos.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-12 flex items-center gap-6 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                                    <i class="ph-fill ph-warning-diamond text-[#025964] text-3xl"></i>
                                    <p class="text-xs text-slate-500 font-medium italic">La acreditación técnica depende de la coherencia entre el proyecto y los saberes digitales del nivel.</p>
                                </div>
                             </div>
                        </section>
                    </div>
                `,
                pob: `
                    <div class="space-y-10 fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div class="glass p-10 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden group">
                                <i class="ph-bold ph-briefcase absolute -left-10 -bottom-10 text-white/5 text-[15rem] rotate-12"></i>
                                <div class="relative z-10">
                                    <h4 class="text-3xl font-black mb-4 tracking-tighter uppercase leading-none">Secundaria <span class="bg-white/20 px-4 py-1 rounded-xl text-lg uppercase">Vocacional</span></h4>
                                    <p class="text-slate-200 font-medium text-sm leading-relaxed mb-8">Población prioritaria. Enfoque en diagnóstico funcional y módulos compensatorios.</p>
                                    <div class="bg-white text-[#025964] font-black text-xs uppercase py-3 px-6 rounded-xl inline-block shadow-xl">Atención Prioritaria Secundaria</div>
                                </div>
                             </div>
                             <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100 group h-full flex flex-col justify-center">
                                <div class="w-16 h-16 bg-[#f1f8f9] text-[#025964] rounded-2xl flex items-center justify-center mb-8"><i class="ph-bold ph-user-circle-plus text-3xl"></i></div>
                                <h4 class="text-2xl font-black text-slate-800 mb-4 tracking-tighter uppercase">EPJA (CAN / IPEC)</h4>
                                <p class="text-slate-500 text-sm font-medium leading-relaxed">Directrices específicas para educación de adultos. Ajuste de tiempos y micro-planeamiento por competencia laboral.</p>
                             </div>
                        </div>
                        <div class="glass p-10 rounded-[2.5rem] bg-[#f1f8f9] border border-[#025964]/10 flex items-center gap-8">
                            <div class="w-16 h-16 bg-white border border-[#025964]/10 text-[#025964] rounded-full flex items-center justify-center shrink-0 shadow-sm"><i class="ph-bold ph-hands-clapping text-3xl"></i></div>
                            <div>
                                <h5 class="text-xl font-black text-slate-800 mb-2 uppercase tracking-tighter">Inclusión Total</h5>
                                <p class="text-sm text-slate-500 font-medium leading-relaxed">Las Aulas Integradas deben priorizar la productividad digital mediante diagnósticos personalizados.</p>
                            </div>
                        </div>
                    </div>
                `
            };
            content.innerHTML = templates[tab] || '';
        };

        window.setInputChat = (txt) => document.getElementById('chat-input').value = txt;

        window.mostrarGuiaForo = () => {
            const cat = document.getElementById('foro-categoria').value;
            const box = document.getElementById('foro-guia-box');
            const list = document.getElementById('foro-guia-list');
            const area = document.getElementById('foro-msg');

            const guias = {
                "Logros en el Aula": [
                    "¿Qué evidencia de aprendizaje pudiste observar hoy en tus estudiantes?",
                    "¿Cómo conectó la actividad de hoy con el Resultado de Aprendizaje (RdA) del módulo?",
                    "¿Viste alguna chispa de 'Competencia Viva' (creatividad, resolución de problemas) en el salón?"
                ],
                "Planeamiento y Macro": [
                    "¿Cómo estás integrando las metas del Macrocurrículo en tu planeamiento didáctico semanal?",
                    "¿Qué desafíos has encontrado al bajar el Microcurrículo a la realidad de tu laboratorio?",
                    "¿Sientes que el tiempo de ejecución de los indicadores es realista para tu grupo actual?"
                ],
                "Necesidad de Apoyo": [
                    "¿Qué barrera técnica (equipo, conectividad) está frenando tu avance hoy?",
                    "¿En qué parte específica del currículo sientes que necesitas una sesión de apoyo con el asesor?",
                    "¿Hay algún recurso didáctico que no esté funcionando como esperabas?"
                ],
                "Áreas Técnicas PNFT": [
                    "¿Cómo están respondiendo los chicos a los retos de Programación o IA?",
                    "¿Qué estrategia usaste hoy para explicar un concepto técnico complejo (ej: algoritmos, sensores)?",
                    "¿Cómo integraste la Apropiación Digital en una actividad no necesariamente tecnológica?"
                ],
                "Reflexión Docente": [
                    "Respecto al desafío de la quincena: ¿Cómo ha cambiado tu perspectiva sobre este tema?",
                    "¿Qué momento de 'ajá!' o descubrimiento tuviste hoy junto a tus estudiantes?",
                    "Si pudieras cambiar una sola cosa de la dinámica de hoy para mejorar la reflexión, ¿cuál sería?"
                ]
            };

            if (guias[cat]) {
                list.innerHTML = guias[cat].map(q => `
                    <li class="flex gap-3 items-start">
                        <i class="ph-bold ph-caret-right text-teal-500 mt-1"></i>
                        <p class="text-[11px] font-bold text-slate-600 leading-relaxed">${q}</p>
                    </li>
                `).join('');
                box.classList.remove('hidden');
                area.placeholder = "Responde a las preguntas orientadoras compartiendo tu vivencia diaria en el aula...";
            } else {
                box.classList.add('hidden');
                area.placeholder = "Describe tu experiencia, logro o necesidad pedagógica aquí...";
            }
        };

        window.publicarForo = async () => {
            const txt = document.getElementById('foro-msg').value.trim();
            const cat = document.getElementById('foro-categoria').value;
            if (!txt) return;
            try {
                await window.addDoc(window.collection(db, "foro_posts"), {
                    autor: window.currentUserData?.nombre || "Docente",
                    uid: auth.currentUser.uid,
                    mensaje: txt,
                    categoria: cat,
                    fecha: serverTimestamp()
                });
                msg("✅ Publicado con éxito", "success");
                document.getElementById('foro-msg').value = "";
                document.getElementById('foro-guia-box').classList.add('hidden');
                router('foro');
            } catch (e) { alert("Error: " + e.message); }
        };

        // --- LÓGICA IA (GEMINI vía SERVER) ---
        async function llamarGemini(promptTxt, type = 'general') {
            try {
                const callGemini = window.httpsCallable(window.functions, 'callGemini');
                const result = await callGemini({ prompt: promptTxt, type: type });
                // Devolvemos solo el texto para compatibilidad con .split() y .replace()
                return result.data.text;
            } catch (error) {
                console.error("Error al llamar a Gemini Function:", error);
                const errorMsg = error.message || 'Error desconocido';
                const errorCode = error.code || 'unknown';

                let feedback = `⛔ Error (${errorCode}): ${errorMsg}`;
                if (errorCode === 'unauthenticated') feedback = "⚠️ Debes iniciar sesión para usar la IA.";

                return feedback;
            }
        }

        window.configurarAPI = () => {
            alert("✅ El sistema ahora utiliza una conexión de servidor segura. No se requieren claves locales.");
        };

        window.askOrientIA = async (preSet) => {
            const input = document.getElementById('orient-ia-input');
            const resDiv = document.getElementById('orient-ia-res');
            const txt = preSet || input.value.trim();
            if (!txt) return;

            resDiv.innerHTML = '<div class="flex items-center gap-3 text-teal-500 font-black uppercase tracking-widest text-[10px] animate-pulse"><i class="ph ph-cpu"></i> Escaneando Normativa 2026...</div>';
            if (!preSet) input.value = "";

            const respuesta = await llamarGemini(txt, 'orient');

            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            resDiv.innerHTML = `<div class="fade-in bg-teal-50/10 border border-teal-500/20 p-5 rounded-2xl text-slate-300 shadow-sm">${htmlRes}</div>`;
        };

        window.saveOrientNotes = () => {
            const val = document.getElementById('orient-notes').value;
            localStorage.setItem('pnft_orient_notes', val);
        };

        // --- PAUSAS REFLEXIVAS QUINCENALES ---
        window.PISCINA_REFLEXIVA = [
            { t: "Módulos y Metas", q: "¿Sientes que lo que los chicos hacen hoy en clase realmente los acerca a la meta del módulo, o se siente más como 'hacer por hacer'?", r: "Si te cuesta verlo, ¡es buen momento para dar un vistazo al Perfil de Salida!" },
            { t: "Conexión Curricular", q: "¿Cómo explicarías el sentido del currículum de este mes a un padre de familia usando solo ejemplos de lo que pasa en el laboratorio?", r: "Refresca el 'Sentido del Currículum' en tu guía si necesitas ideas." },
            { t: "RdA vs indicadores", q: "Ese indicador que evaluaste hoy... ¿realmente nos dice que el estudiante está logrando el Resultado de Aprendizaje (RdA) técnico?", r: "Dale una mirada a la relación RdA-Indicador en tus orientaciones." },
            { t: "Evaluación Diaria", q: "¿Qué fue eso 'especial' que viste hoy en un estudiante que te confirmó que sí está aprendiendo?", r: "Recuerda que observar lo cotidiano es la mejor evidencia de evaluación." },
            { t: "Etapas del Proyecto", q: "Si tu proyecto fuera un viaje... ¿en qué parada están hoy los chicos? ¿Saben ellos hacia dónde van mañana?", r: "Revisa las 'Etapas y Fases del Proyecto' para no perder el rumbo." },
            { t: "Evidencias Reales", q: "Aparte de los archivos en la compu, ¿qué otra cosa en el salón te grita que los chicos están entendiendo el tema?", r: "Busca evidencias en la conversación y la actitud, no solo en lo digital." },
            { t: "Competencias", q: "¿Viste a alguien hoy resolviendo un problema de forma creativa? ¡Ahí está la competencia viva!", r: "Recuerda que las competencias se ven en la acción diaria." },
            { t: "Componente Evaluación", q: "¿Sientes que la evaluación de este mes está siendo un apoyo para el chico o solo un número más?", r: "Repasar los 'Componentes de Evaluación' ayuda a darles sentido humano." },
            { t: "Fases de Creación", q: "¿En qué fase del proyecto se nota más la emoción de los estudiantes? ¿Cómo podemos mantener eso?", r: "Las fases de ideación suelen ser las más vibrantes, ¡aprovéchalas!" },
            { t: "Conocimientos Base", q: "¿Hubo algún momento hoy donde sentiste que debías explicar algo 'básico' que ya deberían saber? ¿Cómo lo manejaste?", r: "Retomar bases no es retroceder, es fortalecer el cimiento." }
        ];

        window.obtenerPreguntasQuincena = () => {
            const now = new Date();
            // Semilla estable cada 15 días (ms / (15 * 24 * 60 * 60 * 1000))
            const quincenaHash = Math.floor(now.getTime() / 1296000000);

            // Función simple de "mezcla" con semilla
            const shuffleConSemilla = (arr, seed) => {
                let m = arr.length, t, i;
                while (m) {
                    i = Math.floor(((seed * m) % 100) / 100 * m--);
                    t = arr[m]; arr[m] = arr[i]; arr[i] = t;
                }
                return arr;
            };

            const poolCopiado = [...window.PISCINA_REFLEXIVA];
            return shuffleConSemilla(poolCopiado, quincenaHash).slice(0, 3);
        };

        window.renderizarPausaReflexiva = () => {
            const container = document.getElementById('pausa-reflexiva-container');
            if (!container) return;

            const preguntas = window.obtenerPreguntasQuincena();
            let html = `
                <div class="mb-10 animate-in fade-in slide-in-from-top-4 duration-700">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
                        <div class="flex items-center gap-2 px-4 py-1.5 bg-amber-50 rounded-full border border-amber-100 shadow-sm">
                            <i class="ph-fill ph-sparkle text-amber-500 text-[10px]"></i>
                            <span class="text-[9px] font-black text-amber-700 uppercase tracking-[0.2em]">Pausa Reflexiva de la Quincena</span>
                        </div>
                        <div class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            `;

            preguntas.forEach(p => {
                html += `
                    <div onclick="window.responderPausa('${p.t}', '${p.q}')" class="group p-6 bg-white rounded-[2.5rem] border border-slate-100 hover:border-amber-200 hover:shadow-xl hover:shadow-amber-500/5 transition-all duration-500 flex flex-col justify-between cursor-pointer relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-amber-500/5 rounded-bl-full translate-x-4 -translate-y-4 group-hover:translate-x-0 group-hover:translate-y-0 transition-transform duration-700"></div>
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-[8px] font-black bg-slate-50 text-slate-400 px-3 py-1 rounded-full border border-slate-100 uppercase tracking-widest group-hover:bg-amber-50 group-hover:text-amber-500 group-hover:border-amber-100 transition-colors">${p.t}</span>
                                <div class="w-8 h-8 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-amber-50 group-hover:text-amber-400 transition-all"><i class="ph-bold ph-chat-centered-text"></i></div>
                            </div>
                            <p class="text-[13px] font-bold text-slate-700 leading-relaxed mb-4 group-hover:text-slate-900 transition-colors">"${p.q}"</p>
                        </div>
                        <div class="space-y-4">
                            <div class="pt-4 border-t border-slate-50 group-hover:border-amber-50 transition-colors">
                                <p class="text-[10px] italic text-slate-400 leading-tight group-hover:text-amber-600/70 transition-colors">${p.r}</p>
                            </div>
                            <button class="w-full py-2.5 bg-slate-50 text-slate-400 rounded-xl text-[9px] font-black uppercase tracking-widest group-hover:bg-amber-500 group-hover:text-white transition-all duration-300 flex items-center justify-center gap-2">
                                <i class="ph-bold ph-pencil-simple-line"></i> Responder desafío
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        };

        window.responderPausa = (tema, pregunta) => {
            const area = document.getElementById('foro-msg');
            const container = document.getElementById('foro-publicar-container');
            const cat = document.getElementById('foro-categoria');

            if (!area || !container) return;

            // Hacer scroll suave al área de publicación
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Preparar el mensaje con el contexto de la pausa
            area.value = `[Reflexión: ${tema}] \n\nMi respuesta al desafío: `;

            // Sugerir categoría adecuada
            if (cat) cat.value = "Reflexión Docente";

            // Animación de enfoque
            setTimeout(() => {
                area.focus();
                // Poner el cursor al final
                area.setSelectionRange(area.value.length, area.value.length);
                msg(`✍️ Respondiendo al desafío: ${tema}`, "success");
            }, 600);
        };

        window.updateIASelectors = () => {
            const nivel = document.getElementById('ia-nivel').value;
            const container = document.getElementById('ia-dynamic-selectors');
            const modulos = window.SABERES_DATA[nivel].modulos;

            container.innerHTML = `
                <div class="group">
                    <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Módulo</label>
                    <select id="ia-modulo" onchange="updateIASaberes()" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all appearance-none cursor-pointer">
                        ${modulos.map((m, idx) => `<option value="${idx}">${m.n}</option>`).join('')}
                    </select>
                </div>
                <div class="group col-span-full">
                    <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Saberes a vincular</label>
                    <div id="ia-saberes-list" class="grid grid-cols-1 gap-2 max-h-[250px] overflow-y-auto p-4 bg-slate-50/50 rounded-2xl border border-slate-100 shadow-inner">
                        <!-- Saberes appear here -->
                    </div>
                </div>
            `;
            window.updateIASaberes();
        };

        window.updateIASaberes = () => {
            const nivel = document.getElementById('ia-nivel').value;
            const moduloIdx = document.getElementById('ia-modulo').value;
            if (!window.SABERES_DATA[nivel] || !window.SABERES_DATA[nivel].modulos[moduloIdx]) return;

            const saberes = window.SABERES_DATA[nivel].modulos[moduloIdx].s;
            const list = document.getElementById('ia-saberes-list');

            // Agrupar por Área de Conocimiento
            const grouped = {};
            saberes.forEach(s => {
                const area = s.a || 'General';
                if (!grouped[area]) grouped[area] = [];
                grouped[area].push(s.n);
            });

            let html = "";
            for (const area in grouped) {
                html += `
                    <div class="col-span-full mt-6 mb-3 first:mt-0">
                        <p class="text-[9px] font-black text-teal-600 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-teal-500"></span> ${area}
                        </p>
                    </div>
                    <div class="col-span-full grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${grouped[area].map(name => `
                            <label class="flex items-center gap-3 bg-white px-4 py-2.5 rounded-2xl border border-slate-100 cursor-pointer hover:border-teal-500/30 transition-all text-[10px] font-bold text-slate-600 shadow-sm hover:shadow-md group">
                                <input type="checkbox" name="ia-saber" value="${name}" class="w-4 h-4 rounded border-slate-300 text-teal-600 focus:ring-teal-500 transition-all cursor-pointer">
                                <span class="group-hover:text-[#025964] transition-colors">${name}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            }
            list.innerHTML = html || '<p class="text-center text-slate-400 py-10 font-bold italic">No hay saberes disponibles.</p>';
        };


        // --- LÓGICA DE PRODUCCIONES DIGITALES ---
        window.abrirModalSubir = () => document.getElementById('modal-subir').classList.remove('hidden');
        window.cerrarModalSubir = () => {
            document.getElementById('modal-subir').classList.add('hidden');
            document.getElementById('file-upload').value = "";
            document.getElementById('file-name').innerText = "Haga clic o arrastre el archivo aquí";
        };

        window.updateUploadSelectors = () => {
            const nivel = document.getElementById('up-nivel').value;
            const moduloSel = document.getElementById('up-modulo');
            moduloSel.innerHTML = '<option value="">Seleccione Módulo</option>';
            if (!nivel || !window.SABERES_DATA[nivel]) return;

            window.SABERES_DATA[nivel].modulos.forEach((m, idx) => {
                moduloSel.innerHTML += `<option value="${idx}">${m.n}</option>`;
            });
            window.updateUploadSaberes();
        };

        window.updateUploadSaberes = () => {
            const nivel = document.getElementById('up-nivel').value;
            const moduloIdx = document.getElementById('up-modulo').value;
            const area = document.getElementById('up-area').value;
            const saberSel = document.getElementById('up-saber');
            saberSel.innerHTML = '<option value="">Seleccione Saber</option>';

            if (!nivel || moduloIdx === "" || !window.SABERES_DATA[nivel].modulos[moduloIdx]) {
                saberSel.innerHTML = '<option value="">Primero elija módulo</option>';
                return;
            }

            const mod = window.SABERES_DATA[nivel].modulos[moduloIdx];
            // Filtrar saberes por el área seleccionada
            const filtered = mod.s.filter(s => !area || s.a === area);

            filtered.forEach(s => {
                saberSel.innerHTML += `<option value="${s.n}">${s.n}</option>`;
            });

            if (filtered.length === 0 && area) {
                saberSel.innerHTML = '<option value="">Sin saberes en esta área</option>';
            }
        };

        window.handleFileSelect = (input) => {
            const file = input.files[0];
            if (file) {
                document.getElementById('file-name').innerText = `📄 ${file.name}`;
            }
        };

        window.subirRecursoDigital = async () => {
            const nombre = document.getElementById('up-nombre').value.trim();
            const desc = document.getElementById('up-desc').value.trim();
            const nivel = document.getElementById('up-nivel').value;
            const moduloIdx = document.getElementById('up-modulo').value;
            const saber = document.getElementById('up-saber').value;
            const file = document.getElementById('file-upload').files[0];

            if (!nombre || !nivel || !moduloIdx || !saber || !file) {
                return msg("⚠️ Complete todos los campos y suba un archivo", "err");
            }

            const btn = document.getElementById('btn-subir');
            btn.disabled = true;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Publicando...`;

            try {
                console.log("--- INICIO PROCESO DE CARGA ---");
                console.log("Datos iniciales:", { nombre, nivel, moduloIdx, saber, fileName: file.name });

                // DETECCIÓN DE ASESOR PARA ADMINT/ASESORES
                let asesorNombre = "Producciones Generales";
                const userEmail = (window.currentUserData?.email || "").toLowerCase();

                if (userEmail.includes("alberto.bustos")) asesorNombre = "Alberto Bustos Ortega";
                else if (userEmail.includes("rodolfo.juarez")) asesorNombre = "Rodolfo Juárez Pérez";
                else if (window.currentUserData?.rol === 'admin') asesorNombre = "Asesoría Regional";
                else asesorNombre = window.currentUserData?.asesor || "Producciones Generales";

                console.log("Asesor mapeado:", asesorNombre);

                const safeName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
                const path = `producciones/${asesorNombre}/${Date.now()}_${safeName}`;
                console.log("Paso 1: Ruta de storage ->", path);

                const fileRef = ref(storage, path);
                console.log("Paso 2: Referencia creada con éxito.");

                msg("⏳ Subiendo a la nube...", "normal");
                console.log("Paso 3: Iniciando uploadBytes...");
                const uploadRes = await uploadBytes(fileRef, file);
                console.log("Paso 4: Upload completado satisfactoriamente.", uploadRes);

                console.log("Paso 5: Solicitando URL pública...");
                const downloadURL = await getDownloadURL(uploadRes.ref);
                console.log("Paso 6: URL obtenida:", downloadURL);

                msg("⏳ Registrando repositorio...", "normal");
                const docData = {
                    nombre,
                    descripcion: desc,
                    nivel,
                    modulo: window.SABERES_DATA[nivel].modulos[moduloIdx].n,
                    saber,
                    fileURL: downloadURL,
                    sharepointURL: (window.currentUserData?.rol === 'admin') ? "https://adminmepcr-my.sharepoint.com/:f:/g/personal/alberto_bustos_ortega_mep_go_cr/IgA5aEg-hv6GQYuvA-cI0LLTASnf_MAIhPrpjFERWm2-3sw?e=qvvwoK" : "",
                    fileName: file.name,
                    autor: window.currentUserData?.nombre || "Usuario",
                    asesor: asesorNombre,
                    creadoEn: serverTimestamp(),
                    email: window.currentUserData?.email || "",
                    esAdmin: (window.currentUserData?.rol === 'admin')
                };
                console.log("Paso 7: Datos Firestore:", docData);

                await addDoc(collection(db, "producciones_digitales"), docData);
                console.log("Paso 8: Registro Firestore exitoso.");

                msg("✅ ¡Publicado en el ecosistema!", "success");
                window.cerrarModalSubir();
                window.cargarGaleriaRecursos();
            } catch (e) {
                console.error("ERROR CRÍTICO:", e);
                const code = e.code || "unknown";
                msg(`⛔ Error (${code}): ${e.message}`, "err");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="ph ph-upload-simple"></i> Publicar en el Ecosistema`;
            }
        };

        window.cargarGaleriaRecursos = async (filtroNivel = 'todos') => {
            const galeria = document.getElementById('galeria-recursos');
            if (!galeria) return;

            try {
                let q = query(collection(db, "producciones_digitales"), orderBy("creadoEn", "desc"), limit(20));
                if (filtroNivel !== 'todos') {
                    q = query(collection(db, "producciones_digitales"), where("nivel", "==", filtroNivel), orderBy("creadoEn", "desc"));
                }

                const snap = await getDocs(q);
                if (snap.empty) {
                    galeria.innerHTML = `
                        <div class="col-span-full py-20 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 flex flex-col items-center">
                            <i class="ph ph-folder-open text-5xl text-slate-300 mb-4"></i>
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Aún no hay recursos compartidos en este nivel</p>
                        </div>
                    `;
                    return;
                }

                let html = "";
                snap.forEach(doc => {
                    const r = doc.data();
                    const initials = r.autor.split(' ').map(n => n[0]).join('').substring(0, 2);
                    const isAdmin = r.esAdmin || r.asesor?.includes("Asesor");
                    const badgeClass = isAdmin ? "bg-amber-100 text-amber-600 border-amber-200" : "bg-teal-50 text-teal-600 border-teal-100";
                    const badgeLabel = isAdmin ? "ASESORÍA REGIONAL" : r.nivel;

                    html += `
                        <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 hover:border-teal-500/30 transition-all group flex flex-col h-full shadow-sm hover:shadow-xl relative overflow-hidden">
                            ${isAdmin ? '<div class="absolute top-0 right-0 w-24 h-24 bg-amber-500/5 rounded-bl-full -translate-y-4 translate-x-4"></div>' : ''}
                            <div class="flex justify-between items-start mb-6">
                                <span class="text-[9px] font-black ${badgeClass} px-3 py-1 rounded-full uppercase tracking-widest border">${badgeLabel}</span>
                                <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:text-teal-600 transition-colors">
                                    <i class="ph ph-file-pdf text-xl"></i>
                                </div>
                            </div>
                            
                            <h5 class="text-lg font-black text-slate-800 leading-tight mb-2 group-hover:text-[#025964] transition-colors">${r.nombre}</h5>
                            <p class="text-[11px] text-slate-500 font-medium line-clamp-3 mb-6 flex-grow italic">"${r.descripcion || 'Sin descripción disponible.'}"</p>
                            
                            <div class="space-y-4 pt-6 border-t border-slate-50">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full ${isAdmin ? 'bg-amber-500' : 'bg-[#025964]'} flex items-center justify-center text-[10px] font-black text-white shadow-sm">${initials}</div>
                                    <div>
                                        <p class="text-[10px] font-black text-slate-800 uppercase leading-none">${r.autor}</p>
                                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tight mt-1">${r.asesor}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <a href="${r.fileURL}" target="_blank" class="w-full bg-[#025964] hover:bg-teal-600 text-white text-center py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all shadow-lg shadow-teal-900/10 flex items-center justify-center gap-2">
                                        <i class="ph ph-download-simple"></i> Descargar Recurso
                                    </a>
                                    ${r.sharepointURL ? `
                                        <a href="${r.sharepointURL}" target="_blank" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 text-center py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all flex items-center justify-center gap-2">
                                            <i class="ph ph-share-network"></i> Carpeta de Asesoría
                                        </a>
                                    ` : ''}
                                    <button onclick="msg('Módulo: ${r.modulo} | Saber: ${r.saber}', 'normal')" class="w-full border border-slate-100 py-2 rounded-xl text-[9px] font-black text-slate-400 uppercase tracking-widest hover:bg-slate-50 transition-all">Ver Detalles Técnicos</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                galeria.innerHTML = html;
            } catch (e) {
                console.error("Error al cargar recursos:", e);
                const isIndexError = e.message.includes("requires an index");
                galeria.innerHTML = `
                    <div class="col-span-full py-20 bg-rose-50 rounded-[2rem] border-2 border-dashed border-rose-200 flex flex-col items-center px-8 text-center">
                        <i class="ph ph-warning-circle text-5xl text-rose-400 mb-4"></i>
                        <h5 class="text-sm font-black text-rose-600 uppercase mb-2">Se requiere configuración de base de datos</h5>
                        <p class="text-[10px] font-bold text-rose-500 max-w-sm leading-relaxed">
                            ${isIndexError ? 'Firebase está preparando el índice de búsqueda. Por favor, <b>haz clic en el enlace azul</b> que aparece en la consola del navegador para activarlo automáticamente.' : 'Error al conectar con la base de datos.'}
                        </p>
                    </div>
                `;
            }
        };

        window.filtrarRecursos = (nivel) => window.cargarGaleriaRecursos(nivel);

        window.generarSituacion = async () => {
            const tema = document.getElementById('ia-tema').value;
            const nivel = document.getElementById('ia-nivel').value;
            const moduloIdx = document.getElementById('ia-modulo').value;
            const moduloName = window.SABERES_DATA[nivel].modulos[moduloIdx].n;

            const selectedSaberes = Array.from(document.querySelectorAll('input[name="ia-saber"]:checked')).map(cb => cb.value);
            const resDiv = document.getElementById('ia-result');
            const resContainer = document.getElementById('ia-result-container');

            if (!tema) return alert("Por favor, describe el contexto o problema.");

            resContainer.classList.remove('hidden');
            resDiv.innerHTML = `
                <div class="flex flex-col items-center fade-in py-10">
                    <div class="w-16 h-16 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-[#025964] font-black uppercase tracking-widest text-[10px] animate-pulse">Diseñando situaciones para ${nivel} / ${moduloName}...</p>
                </div>`;

            // Scroll to results
            resDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const promptFinal = `REQUERIMIENTO: Crea 4 situaciones problema detalladas.
            CONTEXTO DOCENTE: "${tema}"
            NIVEL: ${nivel}
            MODULO: ${moduloName}
            SABERES A INTEGRAR: ${selectedSaberes.join(', ') || 'Relacionados al módulo'}
            IMPORTANTE: Recuerda que estas situaciones son GUÍAS para el docente. El estudiante es quien debe vivir el proceso de Design Thinking. 
            FORMATO: Usa párrafos numerados, lenguaje profesional y enfoque en Design Thinking.`;

            const respuesta = await llamarGemini(promptFinal, 'situacion');

            // Format response: separate double newlines into paragraphs, preserve bolds
            const paragraphs = respuesta.split(/\n\s*\n/).filter(p => p.trim());
            const formattedHtml = paragraphs.map(p => {
                let text = p.replace(/\*\*(.*?)\*\*/g, '<b class="text-[#025964]">$1</b>').replace(/\n/g, '<br>');
                return `<div class="mb-8 p-6 bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">${text}</div>`;
            }).join('');

            resDiv.innerHTML = `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-[10px] font-black text-[#025964] uppercase tracking-widest bg-[#f1f8f9] px-4 py-2 rounded-full border border-[#025964]/10">Guía Orientadora para ${nivel}</span>
                        <button onclick="window.print()" class="text-[10px] font-black text-slate-400 hover:text-[#025964] uppercase flex items-center gap-2"><i class="ph ph-printer"></i> Imprimir</button>
                    </div>
                    ${formattedHtml}
                    <div class="mt-8 p-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                        <p class="text-[11px] text-slate-500 font-medium italic text-center">
                            "Recordatorio: Esta información es un insumo técnico para el diseño de su mediación pedagógica. Asegúrese de que sus estudiantes sean los protagonistas activos del proceso de resolución."
                        </p>
                    </div>
                </div>`;
        };

        window.planificarSesion = async () => {
            const input = document.getElementById('plan-input');
            const resDiv = document.getElementById('plan-res');
            const txt = input.value.trim();
            if (!txt) return alert("Describe el objetivo de tu lección.");

            resDiv.innerHTML = '<div class="flex flex-col items-center w-full"><div class="w-10 h-10 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-3"></div><p class="text-[#025964] font-black text-xs uppercase tracking-widest">Calculando tiempos y fases...</p></div>';

            const respuesta = await llamarGemini(txt, 'general');
            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            resDiv.innerHTML = `<div class="text-left fade-in font-medium text-slate-600 leading-relaxed max-h-[300px] overflow-y-auto p-2">${htmlRes}</div>`;
            resDiv.className = "bg-white border border-[#025964]/10 rounded-3xl p-8 min-h-[160px] text-sm flex flex-col items-start shadow-sm shadow-[#025964]/5";
        };

        window.enviarChatIA = async () => {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if (!txt) return;

            const hist = document.getElementById('chat-history');
            // User msg
            hist.innerHTML += `
                <div class="flex justify-end gap-3 fade-in">
                    <div class="bg-teal-600 text-white p-6 rounded-[2rem] rounded-tr-none max-w-[85%] text-sm font-bold shadow-xl shadow-teal-600/10">
                        ${txt}
                    </div>
                </div>`;
            input.value = "";
            hist.scrollTop = hist.scrollHeight;

            // IA thinking
            const loadingId = "load-" + Date.now();
            hist.innerHTML += `
                <div id="${loadingId}" class="flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle animate-pulse"></i></div>
                    <div class="bg-slate-50 p-6 rounded-[2rem] rounded-tl-none text-sm font-black text-teal-600 uppercase tracking-widest animate-pulse">Analizando...</div>
                </div>`;
            hist.scrollTop = hist.scrollHeight;

            const respuesta = await llamarGemini(txt, 'general');

            document.getElementById(loadingId).remove();
            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            hist.innerHTML += `
                <div class="flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle"></i></div>
                    <div class="bg-white p-6 rounded-[2rem] rounded-tl-none max-w-[85%] text-sm font-medium text-slate-600 leading-relaxed shadow-sm border border-slate-100">
                        ${htmlRes}
                    </div>
                </div>`;
            hist.scrollTop = hist.scrollHeight;
        };

        // --- LÓGICA EXCEL (ADMIN) ---
        // --- LÓGICA EXCEL (ADMIN REFINADA) ---
        window.abortarCargaExcel = false;
        window.procesarExcel = (input) => {
            const file = input.files[0];
            if (!file) return;

            const progressContainer = document.getElementById('excel-progress-container');
            const progressBar = document.getElementById('excel-progress-bar');
            const progressText = document.getElementById('excel-progress-text');
            const detailText = document.getElementById('excel-detail-text');

            // Preparar UI
            progressContainer.classList.remove('hidden');
            window.abortarCargaExcel = false;
            progressBar.style.width = '0%';
            progressText.innerText = "Iniciando proceso...";
            detailText.innerText = "Leyendo archivo Excel...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    if (rows.length === 0) throw new Error("El archivo está vacío");

                    // 1. BUSCAR LA FILA DE ENCABEZADOS (la primera que tenga 'correo' o 'docente')
                    const headerRowIndex = rows.findIndex(row =>
                        row.some(cell => String(cell || "").toLowerCase().includes("correo"))
                    );

                    if (headerRowIndex === -1) {
                        throw new Error("No se detectó la columna 'Correo del docente'. Verifique los encabezados.");
                    }

                    const rawHeaders = rows[headerRowIndex];
                    const headers = rawHeaders.map(h => String(h || "").toLowerCase().trim());

                    // Re-procesar el JSON desde esa fila específica
                    const json = XLSX.utils.sheet_to_json(sheet, { range: headerRowIndex });

                    const required = [
                        { key: "correo", name: "Correo del docente" },
                        { key: "cédula", name: "Cédula" },
                        { key: "centro", name: "CENTRO_EDUCATIVO" },
                        { key: "asesor", name: "Nombre del Asesor" }
                    ];

                    const missing = required.filter(req => !headers.some(h => h.includes(req.key)));

                    if (missing.length > 0) {
                        throw new Error(`Faltan columnas obligatorias: ${missing.map(m => m.name).join(", ")}`);
                    }

                    let creados = 0, errores = 0, total = json.length;
                    const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                    for (let i = 0; i < total; i++) {
                        if (window.abortarCargaExcel) {
                            detailText.innerText = "🛑 DETENIDO: Se han guardado los registros procesados hasta ahora.";
                            setTimeout(() => progressContainer.classList.add('hidden'), 5000);
                            return;
                        }

                        const row = json[i];
                        try {
                            // Mapeo flexible: busca llaves que contengan las palabras clave
                            const getVal = (r, searchKeys) => {
                                const foundKey = Object.keys(r).find(k =>
                                    searchKeys.some(sk => k.toLowerCase().trim().includes(sk))
                                );
                                return foundKey ? r[foundKey] : "";
                            };

                            const emailValue = getVal(row, ["correo del docente", "correo mep", "email", "correo"]).toLowerCase().trim();
                            if (!emailValue) { errores++; continue; }

                            const userData = {
                                nombre: getVal(row, ["docents de ie", "nombre del docente", "docente", "nombre"]) || "Sin Nombre",
                                cedula: String(getVal(row, ["cédula", "cedula"]) || ""),
                                email: emailValue,
                                celular: String(getVal(row, ["celular", "teléfono", "telefono"]) || ""),
                                institucion: getVal(row, ["centro_educativo", "centro educativo", "institución", "institucion"]) || "Sin Institución",
                                codigo_saber: String(getVal(row, ["codsaber", "saber"]) || ""),
                                codigo_presupuestario: String(getVal(row, ["código presupuestario", "codigo presupuestario", "presupuestario"]) || ""),
                                correo_institucional: getVal(row, ["correo institucional", "email institucional"]).toLowerCase().trim(),
                                regional: getVal(row, ["regional", "regional", "dirección regional"]),
                                circuito: getVal(row, ["circuito"]),
                                dimension_2025: getVal(row, ["dimensión 2025", "dimension 2025"]),
                                equipo_pronie: getVal(row, ["equipo pronie (según inventario fod)", "equipo pronie", "fod"]),
                                programa_3_sutel: getVal(row, ["entregado programa 3 (según inventario sutel)", "sutel", "programa 3"]),
                                formacion_tecnologica: getVal(row, ["formación tecnológica", "formacion tecnologica"]),
                                plan_nacional: getVal(row, ["plan nacional"]),
                                asesor_asignado: getVal(row, ["nombre del asesor", "asesor asignado", "asesor"]),
                                rol: "docente",
                                registradoVia: "excel_v2026_ctrl",
                                actualizadoEn: serverTimestamp()
                            };

                            await setDoc(doc(db, "registro_usuarios", emailValue), userData, { merge: true });

                            if (userData.institucion !== "Sin Institución") {
                                const instSlug = userData.institucion.toLowerCase().replace(/[^a-z0-9]/g, '_');
                                await setDoc(doc(db, "status_instituciones", instSlug), {
                                    nombre: userData.institucion,
                                    regional: userData.regional,
                                    circuito: userData.circuito,
                                    correo_institucional: userData.correo_institucional,
                                    codigo_presupuestario: userData.codigo_presupuestario,
                                    asesor: userData.asesor_asignado,
                                    actualizado: new Date().toLocaleDateString('es-CR'),
                                    categoria: row["Prioridad"] || "CONTINUIDAD"
                                }, { merge: true });
                            }
                            creados++;
                        } catch (err) {
                            console.error("Error en fila:", i, err);
                            errores++;
                        }

                        // Actualizar UI
                        const p = Math.round(((i + 1) / total) * 100);
                        progressBar.style.width = `${p}%`;
                        progressText.innerText = `Procesando: ${p}%`;
                        detailText.innerText = `Fila ${i + 1} de ${total} | Éxitos: ${creados} | Errores: ${errores}`;

                        // Pequeña pausa para no bloquear el hilo principal y permitir el botón Detener
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                    }

                    progressText.innerText = "✅ PROCESO COMPLETADO";
                    detailText.innerText = `Finalizado. Éxitos: ${creados} | Errores: ${errores}`;
                    setTimeout(() => progressContainer.classList.add('hidden'), 6000);

                    input.value = "";
                    if (window.listarUsuarios && !document.getElementById('admin-usuarios-list').classList.contains('hidden')) window.listarUsuarios();
                    if (window.mostrarInstituciones) window.mostrarInstituciones();
                    if (window.updateAdminChart) window.updateAdminChart();

                } catch (err) {
                    console.error("Error en Excel:", err);
                    progressText.innerText = "❌ ERROR EN EL ARCHIVO";
                    detailText.innerText = err.message;
                    input.value = "";
                    // Ocultar barra de carga tras unos segundos si hay error
                    setTimeout(() => progressContainer.classList.add('hidden'), 8000);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.currentAsesorFilter = 'todos';
        window.mostrarInstituciones = async (filtroAsesor = window.currentAsesorFilter) => {
            window.currentAsesorFilter = filtroAsesor;
            const listInstituciones = document.getElementById('admin-instituciones-list');
            const listUsuarios = document.getElementById('admin-usuarios-list');
            const sectionBitacora = document.getElementById('admin-bitacora-section');
            const title = document.querySelector('#admin h3') || { innerText: "" };

            listInstituciones.classList.remove('hidden');
            listUsuarios.classList.add('hidden');
            sectionBitacora.classList.add('hidden');
            document.getElementById('admin-diagnostico-section').classList.add('hidden');
            document.getElementById('admin-instituciones-container').classList.remove('hidden');
            title.innerText = "Gestión de Instituciones";

            listInstituciones.innerHTML = `
                <div class="flex flex-col items-center p-20">
                    <div class="w-10 h-10 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sincronizando centros...</p>
                </div>
            `;

            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const instSnap = await getDocs(collection(db, "status_instituciones"));
                const userSnap = await getDocs(collection(db, "registro_usuarios"));

                const usuariosPorInst = {};
                userSnap.forEach(uDoc => {
                    const u = uDoc.data();
                    if (u.institucion) {
                        if (!usuariosPorInst[u.institucion]) usuariosPorInst[u.institucion] = [];
                        usuariosPorInst[u.institucion].push(u);
                    }
                });

                let html = "";
                instSnap.forEach(iDoc => {
                    const inst = iDoc.data();

                    // APLICAR FILTRO DE ASESOR
                    if (window.currentAsesorFilter !== 'todos') {
                        const nameLower = (inst.asesor || "").toLowerCase();
                        if (!nameLower.includes(window.currentAsesorFilter)) return;
                    }

                    const docentes = usuariosPorInst[inst.nombre] || [];
                    const instId = iDoc.id;
                    const categoria = inst.categoria || 'CONTINUIDAD';
                    const catColor = categoria === 'URGENTE' ? 'text-rose-500 bg-rose-50 border-rose-100' :
                        categoria === 'PRIORITARIO' ? 'text-amber-500 bg-amber-50 border-amber-100' :
                            'text-teal-600 bg-teal-50 border-teal-100';

                    html += `
                        <div class="p-6 bg-white rounded-3xl border border-slate-100 hover:border-[#025964]/20 transition-all group shadow-sm">
                            <div class="flex justify-between items-start mb-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-[#025964] shadow-sm font-black text-[10px] border border-slate-100 uppercase tracking-tighter">000${instId.length}</div>
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <h5 class="font-black text-slate-800 uppercase text-sm">${inst.nombre}</h5>
                                            <span class="text-[8px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md border border-slate-200 uppercase tracking-wider">${inst.asesor || 'Sin Asesor'}</span>
                                        </div>
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            <span class="text-[9px] font-black px-2 py-0.5 rounded-full border uppercase tracking-widest ${catColor}">${categoria}</span>
                                            <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">DR: ${inst.regional || 'N/A'}</span>
                                            <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">Circuito: ${inst.circuito || 'N/A'}</span>
                                            <span class="text-[9px] font-black text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full border border-teal-100 uppercase tracking-widest">Presup: ${inst.codigo_presupuestario || 'N/A'}</span>
                                            <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">Asesor: ${inst.asesor || 'No asignado'}</span>
                                        </div>
                                        <div class="flex gap-4 mt-3">
                                            <div class="flex items-center gap-1.5 opacity-60">
                                                <i class="ph ph-laptop text-[10px] text-slate-400"></i>
                                                <span class="text-[8px] font-black text-slate-400 uppercase">FOD: ${inst.equipo_pronie || 'Pendiente'}</span>
                                            </div>
                                            <div class="flex items-center gap-1.5 opacity-60">
                                                <i class="ph ph-broadcast text-[10px] text-slate-400"></i>
                                                <span class="text-[8px] font-black text-slate-400 uppercase">SUTEL: ${inst.programa_3_sutel || 'Pendiente'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="window.editarInstitucion('${instId}')" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-[#025964] transition-colors"><i class="ph-bold ph-pencil-simple"></i></button>
                                    <button onclick="window.eliminarInstitucion('${instId}', '${inst.nombre}')" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-rose-500 transition-colors"><i class="ph-bold ph-trash"></i></button>
                                    <button class="w-8 h-8 bg-white border border-slate-100 rounded-lg flex items-center justify-center text-slate-400 hover:bg-rose-50 hover:text-rose-500 transition-all shadow-sm"><i class="ph-bold ph-bell"></i></button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                <div class="space-y-3">
                                    <p class="text-[10px] font-black text-teal-600 uppercase tracking-widest">Docentes Asociados (${docentes.length})</p>
                                    <div class="flex -space-x-3 overflow-hidden">
                                        ${docentes.map(d => `<div class="w-10 h-10 rounded-full bg-[#025964] border-2 border-white flex items-center justify-center text-[10px] font-black text-white shadow-sm" title="${d.nombre}">${d.nombre.charAt(0)}</div>`).join('')}
                                        ${docentes.length === 0 ? '<p class="text-[10px] text-slate-400 italic">No hay docentes vinculados</p>' : ''}
                                    </div>
                                </div>
                                <div class="bg-slate-50/50 p-4 rounded-2xl border border-dashed border-slate-200">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Nota de Seguimiento</p>
                                    <p class="text-[11px] text-slate-600 font-bold flex items-center gap-2"><i class="ph-fill ph-chat-centered-text text-teal-500"></i> ${inst.nota_seguimiento || 'Sin registros'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                listInstituciones.innerHTML = html || '<p class="text-center text-slate-400 py-20 font-bold italic">No hay instituciones registradas.</p>';
            } catch (e) {
                console.error(e);
                listInstituciones.innerHTML = `<p class="col-span-full text-center text-rose-500 font-bold py-10">Error: ${e.message}</p>`;
            }
        };

        window.editarInstitucion = async (id) => {
            const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const snap = await getDoc(doc(db, "status_instituciones", id));
            if (!snap.exists()) return;
            const inst = snap.data();

            const nNombre = prompt("Nombre:", inst.nombre);
            if (nNombre === null) return;
            const nCat = prompt("Categoría (URGENTE, PRIORITARIO, CONTINUIDAD):", inst.categoria);
            if (nCat === null) return;
            const nReg = prompt("Regional:", inst.regional || "");
            if (nReg === null) return;
            const nCir = prompt("Circuito:", inst.circuito || "");
            if (nCir === null) return;
            const nNota = prompt("Nota de seguimiento:", inst.nota_seguimiento || "");
            if (nNota === null) return;

            await setDoc(doc(db, "status_instituciones", id), {
                nombre: nNombre,
                categoria: nCat.toUpperCase(),
                regional: nReg,
                circuito: nCir,
                nota_seguimiento: nNota,
                actualizado: new Date().toLocaleDateString('es-CR')
            }, { merge: true });
            window.mostrarInstituciones();
        };

        window.eliminarInstitucion = async (id, nombre) => {
            if (!confirm(`¿Eliminar ${nombre}?`)) return;
            const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            await deleteDoc(doc(db, "status_instituciones", id));
            window.mostrarInstituciones();
        };

        window.crearInstitucion = async () => {
            const nombre = prompt("Nombre de la nueva institución:");
            if (!nombre) return;
            const cat = prompt("Prioridad (URGENTE, PRIORITARIO, CONTINUIDAD):", "CONTINUIDAD");
            if (!cat) return;
            const reg = prompt("Regional:", "");
            if (reg === null) return;
            const cir = prompt("Circuito:", "");
            if (cir === null) return;

            const instSlug = nombre.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            await setDoc(doc(db, "status_instituciones", instSlug), {
                nombre: nombre,
                categoria: cat.toUpperCase(),
                regional: reg,
                circuito: cir,
                actualizado: new Date().toLocaleDateString('es-CR'),
                nota_seguimiento: "Institución creada manualmente"
            }, { merge: true });

            msg("✅ Institución creada", "success");
            window.mostrarInstituciones();
        };

        // Necesitamos exponer funciones de firebase a window para usarlas dentro de router() que es global
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getDoc = getDoc;
        window.doc = doc;
        window.getFunctions = getFunctions;
        window.httpsCallable = httpsCallable;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.serverTimestamp = serverTimestamp;
        window.storage = storage;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;

        // Inicializar Functions
        window.functions = getFunctions(window.app);

        // --- AUTH LOGIC (Ya probada y funcional) ---
        const msg = (txt, type) => {
            const el = document.getElementById('status-msg');
            el.innerText = txt;
            el.className = `mt-6 text-xs text-center font-bold min-h-[1.5em] ${type === 'err' ? 'text-red-400' : 'text-green-400'}`;
        };

        window.switchExphase = (phase) => {
            const container = document.getElementById('experience-phase-container');
            const btns = document.querySelectorAll('.experience-tab-btn');
            btns.forEach(b => {
                b.classList.remove('active', 'bg-[#025964]', 'text-white');
                b.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`exbtn-${phase}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-[#025964]', 'text-white');
                activeBtn.classList.remove('text-slate-400');
            }

            const phases = {
                antes: `
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">01</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-notebook text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Diagnóstico Inicial</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Mapeo de saberes previos y condiciones tecnológicas del grupo antes de la intervención.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">02</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-strategy text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Resolución de Problemas</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Estructuración de la situación problema bajo las 5 fases de Design Thinking.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">03</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-database text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Selección de Saberes</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Identificación de los saberes digitales del nivel que se abordarán en la sesión.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">04</span>
                        <div class="w-12 h-12 bg-[#025964] rounded-xl flex items-center justify-center text-white mb-6"><i class="ph-bold ph-check text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Lista de Cotejo</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Preparación de los indicadores de logro y criterios de evaluación técnica.</p>
                    </div>
                `,
                durante: `
                    <div class="lg:col-span-2 glass p-10 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden">
                        <i class="ph-fill ph-circles-three absolute -right-10 -bottom-10 text-white/5 text-[15rem] rotate-12"></i>
                        <h4 class="text-3xl font-black mb-4 uppercase tracking-tighter">Liderazgo Pedagógico</h4>
                        <p class="text-teal-100 font-medium leading-relaxed mb-6">El docente de secundaria lidera la mediación técnica dentro del aula para potenciar el aprendizaje autónomo.</p>
                        <ul class="space-y-4">
                            <li class="flex items-center gap-3 text-sm font-bold"><i class="ph-bold ph-check-circle text-teal-400"></i> Modelado de procesos algorítmicos.</li>
                            <li class="flex items-center gap-3 text-sm font-bold"><i class="ph-bold ph-check-circle text-teal-400"></i> Apoyo en la resolución de problemas (debugging).</li>
                        </ul>
                    </div>

                    <div class="glass p-8 rounded-[2rem] bg-white border border-slate-100 flex flex-col justify-between hover:border-[#025964]/20 transition-all">
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-4"><i class="ph-bold ph-projector-screen text-2xl"></i></div>
                        <h5 class="font-black text-slate-800 text-sm uppercase mb-2">Componente Proyecto</h5>
                        <p class="text-[10px] text-slate-500 font-medium italic">Vinculado a saberes específicos.</p>
                    </div>

                    <div class="glass p-8 rounded-[2rem] bg-white border border-slate-100 flex flex-col justify-between hover:border-[#025964]/20 transition-all">
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-4"><i class="ph-bold ph-list-checks text-2xl"></i></div>
                        <h5 class="font-black text-slate-800 text-sm uppercase mb-2">Tareas</h5>
                        <p class="text-[10px] text-slate-500 font-medium italic">Actividades de evaluación.</p>
                    </div>

                    <div class="glass p-8 rounded-[2rem] bg-white border border-slate-100 flex flex-col justify-between hover:border-[#025964]/20 transition-all">
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-4"><i class="ph-bold ph-briefcase text-2xl"></i></div>
                        <h5 class="font-black text-slate-800 text-sm uppercase mb-2">Trabajo Cotidiano</h5>
                        <p class="text-[10px] text-slate-500 font-medium italic">Mediación sobre saberes.</p>
                    </div>

                    <div class="glass p-8 rounded-[2rem] bg-white border border-slate-100 flex flex-col justify-between hover:border-[#025964]/20 transition-all">
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-4"><i class="ph-bold ph-users-three text-2xl"></i></div>
                        <h5 class="font-black text-slate-800 text-sm uppercase mb-2">Asistencia</h5>
                        <p class="text-[10px] text-slate-500 font-medium italic">Registro de permanencia.</p>
                    </div>

                    <div class="lg:col-span-4 glass p-8 rounded-[2rem] bg-slate-50/50 border border-dashed border-slate-200 mt-4">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-[#025964] rounded-lg flex items-center justify-center text-white"><i class="ph-bold ph-clock-countdown text-xl"></i></div>
                            <div>
                                <h6 class="text-xs font-black text-slate-800 uppercase">Gestión del Tiempo y Ajustes</h6>
                                <p class="text-[10px] text-slate-500">Recordatorio: 10 min. de inicio, 10 min. de cierre y ajustes según ritmo de grupo.</p>
                            </div>
                        </div>
                    </div>
                `,
                despues: `
                    <div class="lg:col-span-3 glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10">
                        <h4 class="text-2xl font-black text-slate-800 mb-6">Bitácora de Evidencias</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-image text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Captura Técnica</p>
                            </div>
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-video text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Proceso de Diseño</p>
                            </div>
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-file-pdf text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Reporte RdA</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass p-10 rounded-[2.5rem] bg-teal-50/50 border border-teal-500/10 flex flex-col justify-center">
                        <h5 class="text-lg font-black text-[#025964] mb-2 uppercase italic tracking-tighter">Certificación de Saberes</h5>
                        <p class="text-xs text-slate-500 font-medium">Validación de la apropiación tecnológica en el Portal Nacional de Formación Tecnológica.</p>
                    </div>
                `
            };
            container.innerHTML = phases[phase];
        };

        window.msg = (text, type) => {
            // Toast global para que sea visible en cualquier sección (especialmente admin)
            let toast = document.getElementById('global-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'global-toast';
                toast.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 z-[1000] px-6 py-3 rounded-2xl font-bold shadow-2xl transition-all duration-300 transform translate-y-20 opacity-0';
                document.body.appendChild(toast);
            }

            if (!text) {
                toast.classList.add('translate-y-20', 'opacity-0');
                return;
            }

            const colors = {
                err: 'bg-rose-500 text-white',
                success: 'bg-teal-500 text-white',
                normal: 'bg-slate-800 text-white'
            };

            toast.innerText = text;
            toast.className = `fixed bottom-8 left-1/2 -translate-x-1/2 z-[1000] px-6 py-3 rounded-2xl font-bold shadow-2xl transition-all duration-300 transform ${colors[type] || colors.normal}`;

            // Mostrar
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);

            // Ocultar automáticamente (excepto si es 'normal' que sw suele sobreescribir rápido)
            if (type !== 'normal') {
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 4000);
            }
        };

        window.enviarResetPass = async (targetEmail = null) => {
            console.log("Iniciando envío de reseteo para:", targetEmail);
            const email = targetEmail || document.getElementById('login-email').value.trim() || prompt("Ingresa tu correo @mep.go.cr:");
            if (!email || !email.includes('@mep.go.cr')) return msg("⚠️ Ingresa un correo institucional válido", "err");

            msg("⏳ Enviando enlace...", "normal");
            try {
                await sendPasswordResetEmail(auth, email);
                console.log("Enlace enviado con éxito a:", email);
                msg("✅ Enlace enviado con éxito.", "success");
            } catch (e) {
                console.error("Error en sendPasswordResetEmail:", e);
                msg("⛔ Error: " + e.message, "err");
            }
        };

        window.switchAuthTab = (t) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // Ya no hay form-recover, así que simplificamos
            const loginBtn = document.getElementById('tab-login');
            const regBtn = document.getElementById('tab-register');
            if (loginBtn) loginBtn.classList.toggle('active', t === 'login');
            if (regBtn) regBtn.classList.toggle('active', t === 'register');

            document.getElementById('form-login').classList.toggle('hidden', t !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', t !== 'register');
            msg("", "");
        };

        window.registerUser = async () => {
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const advisor = document.getElementById('reg-advisor').value;
            const data = {
                nombre: document.getElementById('reg-name').value.trim(),
                telefono: document.getElementById('reg-phone').value.trim(),
                codigo: document.getElementById('reg-code').value.trim(),
                email: email,
                password: pass, // Guardamos la clave para recuperación rápida por el admin
                asesor: advisor,
                rol: "docente",
                ultimo_acceso: serverTimestamp()
            };

            if (!email.includes('@mep.go.cr')) return msg("⛔ Use correo @mep.go.cr", "err");
            if (pass.length < 6) return msg("⚠️ Contraseña corta", "err");
            if (!data.nombre || !data.telefono || !data.codigo) return msg("⚠️ Complete datos", "err");

            msg("⏳ Verificando autorización...", "normal");

            try {
                // 1. VALIDACIÓN DE LISTA BLANCA (Desde Excel)
                const masterAdvisors = ["alberto.bustos.ortega@mep.go.cr", "rodolfo.juarez.perez@mep.go.cr"];
                const isMaster = masterAdvisors.includes(email.toLowerCase());

                let excelData = {};
                if (!isMaster) {
                    const docRef = doc(db, "registro_usuarios", email.toLowerCase());
                    const excelSnap = await getDoc(docRef);

                    if (!excelSnap.exists()) {
                        return msg("⛔ Tu correo no está pre-autorizado. Contacta a un asesor.", "err");
                    }
                    excelData = excelSnap.data();
                } else {
                    // Datos por defecto para asesores si no están en el Excel
                    excelData = {
                        rol: "admin",
                        nombre: email.toLowerCase().includes("alberto") ? "Alberto Bustos Ortega" : "Rodolfo Juárez Pérez",
                        institucion: "Asesoría Regional"
                    };
                }
                const finalData = {
                    ...data,
                    ...excelData, // Priorizar datos técnicos del Excel
                    telefono: data.telefono, // Mantener el del formulario
                    nombre: data.nombre || excelData.nombre,
                    fecha_registro: serverTimestamp()
                };

                msg("⏳ Registrando cuenta...", "normal");
                const res = await createUserWithEmailAndPassword(auth, email, pass);

                // Guardar en documento indexado por UID (estándar de la app)
                await guardarFicha(res.user.uid, finalData);

                msg("✅ Cuenta creada con éxito.", "success");
            } catch (error) {
                console.error("Error en Registro:", error);
                if (error.code === 'auth/email-already-in-use') {
                    msg("⚠️ Usuario existe. Reparando perfil...", "normal");
                    try {
                        const loginRes = await signInWithEmailAndPassword(auth, email, pass);

                        // FIX: Antes de guardar, verificar si ya tiene un rol (ej: admin)
                        const existingSnap = await getDoc(doc(db, "registro_usuarios", loginRes.user.uid));
                        if (existingSnap.exists() && existingSnap.data().rol) {
                            data.rol = existingSnap.data().rol;
                        }
                        // Forzar admin si es master
                        if (["alberto.bustos.ortega@mep.go.cr", "rodolfo.juarez.perez@mep.go.cr"].includes(email.toLowerCase())) {
                            data.rol = "admin";
                        }

                        await guardarFicha(loginRes.user.uid, data);
                        msg("✅ Perfil reparado. Reiniciando...", "success");
                        setTimeout(() => location.reload(), 1500);
                    } catch (e) {
                        console.error("Error reparando perfil:", e);
                        msg("⛔ Contraseña incorrecta para reparar el perfil.", "err");
                    }
                } else {
                    msg("Error: " + error.message, "err");
                }
            }
        };

        window.mostrarBitacora = () => {
            const listInstituciones = document.getElementById('admin-instituciones-list');
            const listUsuarios = document.getElementById('admin-usuarios-list');
            const sectionBitacora = document.getElementById('admin-bitacora-section');
            const title = document.querySelector('#admin h3') || { innerText: "" };

            listInstituciones.classList.add('hidden');
            document.getElementById('admin-instituciones-container').classList.add('hidden');
            listUsuarios.classList.add('hidden');
            sectionBitacora.classList.remove('hidden');
            document.getElementById('admin-diagnostico-section').classList.add('hidden');
            title.innerText = "Bitácora de Seguimiento";

            document.getElementById('bitacora-fecha').value = new Date().toISOString().split('T')[0];
            window.cargarHistorialBitacora();
        };

        window.guardarAporteBitacora = async () => {
            const fecha = document.getElementById('bitacora-fecha').value;
            const inst = document.getElementById('bitacora-inst').value.trim();
            const detalle = document.getElementById('bitacora-detalle').value.trim();
            const reporte = document.getElementById('bitacora-reporte').value.trim();

            if (!fecha || !inst || !detalle) return msg("⚠️ Complete los campos básicos", "err");

            msg("⏳ Guardando aporte...", "normal");
            try {
                const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                await addDoc(collection(db, "bitacora_seguimiento"), {
                    fecha,
                    institucion: inst,
                    detalle,
                    reporte,
                    creadoPor: auth.currentUser.email,
                    timestamp: new Date().getTime()
                });
                msg("✅ Aporte guardado", "success");
                document.getElementById('bitacora-inst').value = "";
                document.getElementById('bitacora-detalle').value = "";
                document.getElementById('bitacora-reporte').value = "";
                window.cargarHistorialBitacora();
            } catch (e) {
                console.error(e);
                msg("⛔ Error al guardar", "err");
            }
        };

        window.cargarHistorialBitacora = async () => {
            const list = document.getElementById('bitacora-historial-list');
            try {
                const { collection, query, orderBy, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, "bitacora_seguimiento"), orderBy("timestamp", "desc"), limit(10));
                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = '<p class="text-[10px] text-slate-400 italic text-center py-4">Sin aportes registrados</p>';
                    return;
                }

                let html = "";
                snap.forEach(doc => {
                    const a = doc.data();
                    html += `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-[10px] font-black text-[#025964] uppercase">${a.institucion}</p>
                                <p class="text-[9px] text-slate-400">${a.fecha}</p>
                            </div>
                            <p class="text-[10px] text-slate-600 line-clamp-2">${a.detalle}</p>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        };

        window.analizarBitacoraIA = async () => {
            const { collection, getDocs, query, orderBy, limit, doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const snap = await getDocs(query(collection(db, "bitacora_seguimiento"), orderBy("timestamp", "desc"), limit(5)));

            if (snap.empty) return msg("⚠️ No hay historial para analizar", "normal");

            const btn = document.getElementById('btn-analizar-bitacora');
            btn.innerText = "Analizando...";
            btn.disabled = true;

            const historialText = [];
            snap.forEach(d => {
                const data = d.data();
                historialText.push(`INSTITUCIÓN: ${data.institucion}\nFECHA: ${data.fecha}\nDETALLE: ${data.detalle}\nINFORME: ${data.reporte || 'N/A'}`);
            });

            const prompt = `Eres Asesor Nacional del PNFT. Analiza este historial de visitas:
            ${historialText.join('\n---\n')}
            
            TU MISIÓN:
            1. Genera un RESUMEN EJECUTIVO (máx 1500 caracteres).
            2. CLASIFICA cada centro según los siguientes CRITERIOS UNIFICADOS:
               - URGENTE: Fallo técnico total, docentes sin capacitación básica o riesgo de abandono del programa. Requiere intervención inmediata.
               - PRIORITARIO: Dudas pedagógicas de mediación, fallos técnicos parciales o necesidad de refuerzo en las fases de Design Thinking (Empatizar, Definir, Idear, Prototipar, Probar y Evaluar).
               - CONTINUIDAD: Implementación fluida en la resolución de problemas, docentes autónomos y proyectos activos.

            Devuelve el JSON al final del texto:
            :::DATA_START:::
            [{"institucion": "Nombre", "categoria": "Urgente|Prioritario|Continuidad"}]
            :::DATA_END:::`;

            try {
                const res = await llamarGemini(prompt, 'general');
                let text = res;

                // Procesar JSON de categorías
                const jsonMatch = text.match(/:::DATA_START:::([\s\S]*?):::DATA_END:::/);
                if (jsonMatch) {
                    const data = JSON.parse(jsonMatch[1]);
                    for (const item of data) {
                        const slug = item.institucion.toLowerCase().replace(/[^a-z0-9]/g, '_');
                        await setDoc(doc(db, "status_instituciones", slug), {
                            nombre: item.institucion,
                            categoria: item.categoria,
                            actualizado: new Date().toLocaleDateString('es-CR')
                        }, { merge: true });
                    }
                    text = text.replace(jsonMatch[0], "");
                    window.updateAdminChart(); // Actualizar gráfico
                }

                document.getElementById('bitacora-ia-output').innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                msg("✅ Análisis completado y tablero actualizado", "success");
            } catch (e) {
                console.error(e);
                msg("⛔ Error en el análisis", "err");
            } finally {
                btn.innerText = "Analizar Historial";
                btn.disabled = false;
            }
        };

        window.updateAdminChart = async () => {
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const snap = await getDocs(collection(db, "status_instituciones"));
                let u = 0, p = 0, c = 0;
                snap.forEach(d => {
                    const cat = (d.data().categoria || 'continuidad').toLowerCase();
                    if (cat.includes('urgente')) u++;
                    else if (cat.includes('prioritario')) p++;
                    else c++;
                });

                // Si no hay datos aún, usar placeholders
                if (snap.empty) { u = 0; p = 0; c = 0; }

                // Actualizar números de estadísticas
                const statInst = document.getElementById('admin-stat-instituciones');
                const statDocs = document.getElementById('admin-stat-docentes');
                if (statInst) statInst.innerText = snap.size;

                // Para los docentes, necesitamos contar la otra colección
                const snapUsers = await getDocs(collection(db, "registro_usuarios"));
                if (statDocs) statDocs.innerText = snapUsers.size;

                const chart = Chart.getChart("adminChart");
                if (chart) {
                    chart.data.datasets[0].data = [c || 1, p || 0, u || 0];
                    chart.update();
                }
            } catch (e) { console.error(e); }
        };


        window.listarUsuarios = async (filtroAsesor = window.currentAsesorFilter) => {
            window.currentAsesorFilter = filtroAsesor;
            const listInstituciones = document.getElementById('admin-instituciones-list');
            const listUsuarios = document.getElementById('admin-usuarios-list');
            const sectionBitacora = document.getElementById('admin-bitacora-section');
            const sectionDiag = document.getElementById('admin-diagnostico-section');
            const title = document.querySelector('#admin h3') || { innerText: "" };

            listInstituciones.classList.add('hidden');
            document.getElementById('admin-instituciones-container').classList.add('hidden');
            listUsuarios.classList.remove('hidden');
            sectionBitacora.classList.add('hidden');
            sectionDiag.classList.add('hidden');
            document.getElementById('admin-usuario-actividad').classList.add('hidden');
            title.innerText = "Lista de Usuarios";
            listUsuarios.innerHTML = '<div class="flex flex-col items-center p-10"><div class="w-8 h-8 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-xs font-black text-slate-400 uppercase">Consultando base de datos...</p></div>';

            try {
                const snap = await getDocs(collection(db, "registro_usuarios"));
                let html = "";
                snap.forEach(doc => {
                    const u = doc.data();

                    // APLICAR FILTRO DE ASESOR SI EXISTE
                    if (window.currentAsesorFilter !== 'todos') {
                        const asesorLower = String(u.asesor_asignado || "").toLowerCase();
                        if (!asesorLower.includes(window.currentAsesorFilter)) return;
                    }

                    const rolColor = u.rol === 'admin' ? 'bg-amber-500 text-white' : 'bg-teal-50 text-teal-600';
                    html += `
                        <div class="p-6 bg-white rounded-3xl border border-slate-100 flex justify-between items-center hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-400 font-black text-lg">${u.nombre.charAt(0)}</div>
                                <div>
                                    <h5 class="font-black text-slate-800 text-sm uppercase">${u.nombre}</h5>
                                    <p class="text-[10px] text-slate-500 font-medium">${u.email} | Cédula: ${u.cedula || 'N/A'}</p>
                                    <div class="flex gap-2 mt-1 flex-wrap">
                                        <span class="text-[9px] font-black text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full border border-teal-100 uppercase tracking-widest">${u.institucion || 'Sin Institución'}</span>
                                        <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">Saber: ${u.codigo_saber || 'N/A'}</span>
                                        <span class="text-[9px] font-black ${String(u.asesor_asignado || "").toLowerCase().includes('alberto') ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-purple-50 text-purple-600 border-purple-100'} px-2 py-0.5 rounded-full border uppercase tracking-widest">Asesor: ${u.asesor_asignado || 'N/A'}</span>
                                        <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">${u.regional || 'Reg: N/A'}</span>
                                        <span class="text-[9px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">Circ: ${u.circuito || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                                <span class="text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest border border-transparent ${rolColor}">${u.rol || 'docente'}</span>
                                <div class="flex items-center gap-1">
                                    <button onclick="window.verActividadDocente('${doc.id}', '${u.nombre}')" title="Ver Historial de Actividad" class="w-8 h-8 bg-[#025964]/10 rounded-lg flex items-center justify-center text-[#025964] hover:bg-[#025964] hover:text-white transition-all"><i class="ph-bold ph-calendar-check"></i></button>
                                    <button onclick="window.enviarResetPass('${u.email}')" title="Enviar Enlace de Reseteo" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-rose-500 transition-colors"><i class="ph ph-paper-plane-tilt"></i></button>
                                    <button onclick="window.copiarDatosUsuario('${btoa(JSON.stringify(u))}')" title="Copiar Datos" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-teal-600 transition-colors"><i class="ph ph-copy"></i></button>
                                    <button onclick="window.editarUsuario('${doc.id}')" title="Editar" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-[#025964] transition-colors"><i class="ph ph-note-pencil"></i></button>
                                    <button onclick="window.eliminarUsuario('${doc.id}', '${u.nombre}')" title="Eliminar" class="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 hover:text-rose-600 transition-colors"><i class="ph ph-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                listUsuarios.innerHTML = html || '<p class="text-center text-slate-400 py-10">No hay usuarios registrados aún.</p>';
            } catch (e) {
                console.error("Error al listar usuarios:", e);
                listUsuarios.innerHTML = `<p class="text-center text-rose-500 font-bold p-10">Error: ${e.message}</p>`;
            }
        };

        window.verActividadDocente = async (uid, nombre) => {
            const listUsers = document.getElementById('admin-usuarios-list');
            const sectionAct = document.getElementById('admin-usuario-actividad');
            const timeline = document.getElementById('actividad-timeline');

            listUsers.classList.add('hidden');
            sectionAct.classList.remove('hidden');
            document.getElementById('actividad-nombre').innerText = nombre;
            timeline.innerHTML = '<div class="p-10 text-center"><i class="ph ph-spinner-gap animate-spin text-2xl text-slate-300"></i></div>';

            try {
                const { collection, getDocs, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, "foro_posts"), where("uid", "==", uid), orderBy("fecha", "desc"));
                const snap = await getDocs(q);

                if (snap.empty) {
                    timeline.innerHTML = '<p class="text-[10px] text-slate-400 italic py-10 text-center bg-slate-50 rounded-3xl border border-dashed border-slate-200">Este docente aún no ha realizado publicaciones en el foro.</p>';
                } else {
                    let html = "";
                    snap.forEach(doc => {
                        const p = doc.data();
                        html += `
                            <div class="p-5 bg-white rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[8px] font-black text-[#025964] bg-[#f1f8f9] px-2 py-0.5 rounded-full uppercase tracking-widest border border-[#025964]/10">${p.categoria}</span>
                                    <span class="text-[8px] font-bold text-slate-400 uppercase">${p.fecha}</span>
                                </div>
                                <p class="text-xs text-slate-700 font-medium leading-relaxed">${p.mensaje}</p>
                            </div>
                        `;
                    });
                    timeline.innerHTML = html;
                }
            } catch (e) {
                console.error(e);
                timeline.innerHTML = '<p class="text-center text-rose-500 font-bold p-10">Error al cargar historial</p>';
            }
        };

        window.copiarDatosUsuario = (base64Data) => {
            try {
                const u = JSON.parse(atob(base64Data));
                const text = `*Recurso de Asesoría y Seguimiento 2026*\n\nHola ${u.nombre}, aquí están tus credenciales para el portal:\n\n📧 *Correo:* ${u.email}\n🔑 *Clave:* ${u.password || 'Sin dato'}\n🏢 *Código:* ${u.codigo}\n👨‍🏫 *Asesor:* ${u.asesor === 'alberto' ? 'Alberto Bustos Ortega' : u.asesor === 'rodolfo' ? 'Rodolfo Juárez Pérez' : 'Personal Administrativo'}\n\nLink: https://asesoriapnft.github.io/`;

                navigator.clipboard.writeText(text).then(() => {
                    msg("✅ Datos copiados al portapapeles", "success");
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    alert("Error al copiar: " + text); // Fallback si falla navigator.clipboard
                });
            } catch (e) {
                console.error(e);
                msg("⛔ Error al copiar datos", "err");
            }
        };

        window.editarUsuario = async (uid) => {
            try {
                const userSnap = await getDoc(doc(db, "registro_usuarios", uid));
                if (!userSnap.exists()) return;
                const u = userSnap.data();

                const nNombre = prompt("Nombre completo del docente:", u.nombre);
                if (nNombre === null) return;

                const nCedula = prompt("Cédula:", u.cedula || "");
                if (nCedula === null) return;

                const nSaber = prompt("Código Saber:", u.codigo_saber || "");
                if (nSaber === null) return;

                let nRol = prompt("Rol (admin/docente):", u.rol || "docente");
                if (nRol === null) return;

                nRol = nRol.toLowerCase().trim();
                if (nRol !== 'admin' && nRol !== 'docente') {
                    alert("⚠️ Rol no válido.");
                    return;
                }

                msg("⏳ Actualizando perfil...", "normal");
                await setDoc(doc(db, "registro_usuarios", uid), {
                    nombre: nNombre,
                    cedula: nCedula,
                    codigo_saber: nSaber,
                    rol: nRol
                }, { merge: true });

                msg("✅ Usuario actualizado", "success");
                window.listarUsuarios();
            } catch (e) {
                console.error(e);
                msg("⛔ Error al editar", "err");
            }
        };

        window.eliminarUsuario = async (uid, nombre) => {
            const confirm1 = confirm(`¿Está seguro de eliminar el perfil de ${nombre}?\n\nEsta acción borrará sus datos de registro y perderá el acceso al portal.`);
            if (!confirm1) return;

            const confirm2 = confirm(`⚠️ SEGUNDA CONFIRMACIÓN: ¿Realmente desea ELIMINAR a ${nombre}?`);
            if (!confirm2) return;

            msg("⏳ Eliminando...", "normal");
            try {
                // Importar deleteDoc
                const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                await deleteDoc(doc(db, "registro_usuarios", uid));
                msg("✅ Usuario eliminado exitosamente", "success");
                window.listarUsuarios();
            } catch (e) {
                console.error(e);
                msg("⛔ Error al eliminar usuario", "err");
            }
        };

        async function guardarFicha(uid, data) {
            await setDoc(doc(db, "registro_usuarios", uid), data, { merge: true });
        }

        window.loginUser = async () => {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value;
            if (!email || !pass) return msg("⚠️ Faltan datos", "err");

            msg("Verificando credenciales...", "normal");

            try {
                const res = await signInWithEmailAndPassword(auth, email, pass);

                // BACKFILL: Guardar contraseña si no existe en Firestore
                const userDoc = await getDoc(doc(db, "registro_usuarios", res.user.uid));
                if (userDoc.exists() && !userDoc.data().password) {
                    console.log("Actualizando contraseña faltante en perfil...");
                    await setDoc(doc(db, "registro_usuarios", res.user.uid), { password: pass }, { merge: true });
                }
            }
            catch (e) {
                console.error("Login Error:", e);
                // Mapeo de errores comunes para el usuario
                if (e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    msg("⛔ Datos incorrectos. Verifique su correo y clave.", "err");
                } else {
                    msg("⛔ Error de acceso: " + e.code, "err");
                }
            }
        };

        window.logout = () => signOut(auth);

        // --- MONITOR DE SESIÓN PRINCIPAL ---
        window.mostrarDiagnostico = async () => {
            const listInst = document.getElementById('admin-instituciones-container');
            const listUsers = document.getElementById('admin-usuarios-list');
            const sectionBit = document.getElementById('admin-bitacora-section');
            const sectionDiag = document.getElementById('admin-diagnostico-section');
            const title = document.querySelector('#admin h3') || { innerText: "" };

            listInst.classList.add('hidden');
            listUsers.classList.add('hidden');
            sectionBit.classList.add('hidden');
            sectionDiag.classList.remove('hidden');
            title.innerText = "Diagnóstico Estratégico";

            const alertsList = document.getElementById('diag-alerts-list');
            const regionalList = document.getElementById('diag-regional-list');
            alertsList.innerHTML = '<div class="flex items-center gap-3 text-slate-400 p-8"><i class="ph-bold ph-spinner-gap animate-spin"></i> Analizando el foro...</div>';

            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const postsSnap = await getDocs(collection(db, "foro_posts"));
                const usersSnap = await getDocs(collection(db, "registro_usuarios"));

                const usersMap = {};
                usersSnap.forEach(u => usersMap[u.id] = u.data());

                const regionals = {};
                const activeUserUids = new Set();
                const keywords = ["ayuda", "duda", "error", "bloqueo", "no entiendo", "problema", "urgente", "necesito"];
                let totalPosts = 0;
                let needPosts = 0;
                let alertsHtml = "";

                postsSnap.forEach(doc => {
                    const p = doc.data();
                    totalPosts++;
                    if (p.uid) activeUserUids.add(p.uid);

                    const msgLower = (p.mensaje || "").toLowerCase();
                    const isAlert = keywords.some(k => msgLower.includes(k));
                    const isNeedCategory = ["Necesidad", "Apoyo", "Ayuda"].some(c => (p.categoria || "").includes(c));

                    if (isAlert || isNeedCategory) {
                        needPosts++;
                        const user = usersMap[p.uid] || { nombre: "Anónimo", institucion: "N/A", regional: "N/A" };

                        // Agregar a la lista de alertas
                        alertsHtml += `
                            <div class="p-4 bg-white rounded-2xl border-l-[4px] border-rose-500 shadow-sm">
                                <div class="flex justify-between mb-2">
                                    <span class="text-[9px] font-black text-rose-500 uppercase tracking-widest">${p.categoria}</span>
                                    <span class="text-[8px] font-bold text-slate-400">${p.fecha}</span>
                                </div>
                                <p class="text-xs font-bold text-slate-800 mb-2 leading-tight">"${p.mensaje.substring(0, 100)}${p.mensaje.length > 100 ? '...' : ''}"</p>
                                <div class="flex justify-between items-center text-[8px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 p-2 rounded-xl border border-slate-100">
                                    <span>👤 ${user.nombre}</span>
                                    <span>📍 ${user.regional} | ${user.institucion}</span>
                                </div>
                            </div>
                        `;

                        // Agrupar por regional para el mapa
                        const reg = user.regional || "Otras";
                        if (!regionals[reg]) regionals[reg] = { count: 0, needs: 0 };
                        regionals[reg].count++;
                        regionals[reg].needs++;
                    } else {
                        // Track total posts per regional even if not a "need"
                        const user = usersMap[p.uid];
                        if (user && user.regional) {
                            const reg = user.regional || "Otras";
                            if (!regionals[reg]) regionals[reg] = { count: 0, needs: 0 };
                            regionals[reg].count++;
                        }
                    }
                });

                // Usuarios inactivos
                let inactiveHtml = "";
                let inactiveCount = 0;
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    if (!activeUserUids.has(doc.id) && u.rol !== 'admin') {
                        inactiveCount++;
                        inactiveHtml += `
                            <div class="p-3 bg-white rounded-xl border border-slate-100 flex justify-between items-center hover:bg-amber-50 group transition-colors">
                                <div>
                                    <h6 class="text-[10px] font-black text-slate-700 uppercase leading-none mb-1">${u.nombre}</h6>
                                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">${u.regional} | ${u.institucion}</p>
                                </div>
                                <button onclick="window.verActividadDocente('${doc.id}', '${u.nombre}')" class="w-6 h-6 bg-slate-50 rounded-lg flex items-center justify-center text-slate-300 group-hover:text-amber-500 transition-colors"><i class="ph ph-magnifying-glass"></i></button>
                            </div>
                        `;
                    }
                });

                if (!inactiveHtml) inactiveHtml = '<p class="text-[10px] text-teal-600 bg-teal-50 p-6 rounded-2xl text-center font-bold">🎉 ¡Todos los docentes registrados han participado!</p>';

                document.getElementById('diag-inactive-list').innerHTML = inactiveHtml;

                // Update KPIs
                const score = totalPosts > 0 ? Math.round((needPosts / totalPosts) * 100) : 0;
                document.getElementById('diag-score').innerText = score + "%";
                alertsList.innerHTML = alertsHtml || '<p class="text-[10px] text-slate-400 italic py-8 text-center bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">No hay alertas críticas pendientes</p>';
                document.getElementById('diag-alerts').innerText = (alertsHtml.match(/border-rose-500/g) || []).length;

                // Update Regionals
                let regHtml = "";
                Object.keys(regionals).sort((a, b) => regionals[b].needs - regionals[a].needs).slice(0, 5).forEach(reg => {
                    const r = regionals[reg];
                    const pct = Math.round((r.needs / r.count) * 100);
                    regHtml += `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center group hover:bg-white hover:border-[#025964]/20 transition-all">
                            <div>
                                <h6 class="text-[10px] font-black text-slate-800 uppercase">${reg}</h6>
                                <p class="text-[9px] text-slate-400 font-bold">${r.count} publicaciones totales</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-black text-[#025964]">${pct}%</span>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Necesidad</p>
                            </div>
                        </div>
                    `;
                });
                regionalList.innerHTML = regHtml || '<p class="text-[10px] text-slate-400 italic text-center py-8">Sin datos regionales suficientes</p>';

            } catch (e) {
                console.error(e);
                alertsList.innerHTML = '<p class="text-center text-rose-500 font-bold p-8">Error al cargar diagnóstico</p>';
            }
        };

        window.generarReporteIA = async () => {
            const btn = document.getElementById('btn-diag-ia');
            const resDiv = document.getElementById('diag-ia-result');
            const content = document.getElementById('diag-ia-content');

            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> Analizando...';

            try {
                const { collection, getDocs, limit, query, orderBy } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const snap = await getDocs(query(collection(db, "foro_posts"), orderBy("fecha", "desc"), limit(20)));
                let contexto = "";
                snap.forEach(d => {
                    contexto += `[Cat: ${d.data().categoria}] ${d.data().mensaje}\n`;
                });

                const prompt = `Como consultor experto en el PNFT 2026, analiza estos comentarios del foro docente y genera un reporte de diagnóstico curado para los asesores.
                Contexto actual (últimas publicaciones):
                ${contexto}
                
                El reporte debe incluir:
                1. Necesidades Recurrentes (¿Qué les está costando más?).
                2. Aciertos y Logros Recurrentes (¿Qué está funcionando bien?).
                3. Tendencias para el Apoyo Educativo (Patrones observados).
                4. Valor de Prioridad (Recomendación directa de acción para Alberto y Rodolfo).
                
                Usa un tono profesional, estratégico y enfocado en la mejora del programa.`;

                const res = await llamarGemini(prompt, 'reporte');
                content.innerHTML = res.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                resDiv.classList.remove('hidden');
                msg("✅ Reporte estratégico generado", "success");
            } catch (e) {
                console.error(e);
                msg("⛔ Error con la IA", "err");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph-bold ph-newspaper-clipping"></i> Generar Reporte 2026';
            }
        };

        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    console.log("Sesión activa detectada:", user.email);

                    // 1. Verificar Lista Blanca (Removido temporalmente para evitar errores de permiso)
                    // El usuario ya está autenticado aquí.

                    // 2. Obtener datos de registro
                    const snap = await getDoc(doc(db, "registro_usuarios", user.uid));
                    if (snap.exists()) {
                        window.currentUserData = snap.data();

                        // FORZAR ROL ADMIN SI ES ASESOR (Máxima Seguridad)
                        const admins = ["alberto.bustos.ortega@mep.go.cr", "rodolfo.juarez.perez@mep.go.cr"];
                        if (admins.includes(user.email.toLowerCase())) {
                            window.currentUserData.rol = 'admin';
                        }

                        console.log("Datos de usuario cargados:", window.currentUserData.nombre);

                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-layout').classList.remove('hidden');

                        document.getElementById('sidebar-name').innerText = window.currentUserData.nombre;
                        document.getElementById('sidebar-email').innerText = window.currentUserData.email;
                        document.getElementById('sidebar-avatar').innerText = window.currentUserData.nombre.charAt(0);

                        if (window.currentUserData.rol === 'admin') {
                            const navAdmin = document.getElementById('nav-admin');
                            if (navAdmin) navAdmin.classList.remove('hidden');

                            const badge = document.getElementById('user-role-badge');
                            if (badge) {
                                badge.innerText = "ADMINISTRADOR";
                                badge.className = "text-[9px] font-black bg-amber-500 text-slate-900 px-2 py-0.5 rounded";
                            }
                        }
                        router('dashboard');
                    } else {
                        console.warn("UID sin datos en Firestore:", user.uid);
                        msg("⚠️ Usuario sin perfil vinculado. Por favor, regístrese.", "err");
                        // No cerramos sesión para permitir que termine el registro si es necesario
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-layout').classList.add('hidden');
                    }
                } else {
                    console.log("Monitor: Sin sesión activa.");
                    window.currentUserData = null;
                    document.getElementById('app-layout').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            } catch (err) {
                console.error("Error crítico en monitor de sesión:", err);
                msg("⛔ Error técnico al validar acceso. Intente de nuevo.", "err");
            }
        });
    </script>
</body>

</html>
