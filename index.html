<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Apoyo Dimensi√≥n 1 PNFT - Secundaria</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col md:flex-row">

    <!-- ================= SIDEBAR ================= -->
    <aside class="w-full md:w-72 bg-white border-r border-slate-200 hidden md:flex flex-col flex-shrink-0 transition-all min-h-screen sticky top-0 z-30">
        <div class="p-6 border-b border-slate-100">
            <div class="flex items-start gap-3 text-slate-800 font-bold text-base leading-tight">
                <div class="w-8 h-8 bg-gradient-to-br from-teal-500 to-blue-600 rounded-lg flex items-center justify-center text-white shadow-md flex-shrink-0 mt-0.5">
                    <i class="ph ph-squares-four text-lg"></i>
                </div>
                Portal de Apoyo Pedag√≥gico A y S Dimensi√≥n 1 PNFT
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="sidebar-nav"></nav>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex-shrink-0 flex items-center justify-center font-bold text-xs">AN</div>
                <div class="overflow-hidden text-[10px]">
                    <p class="font-bold text-slate-700 truncate">Rodolfo Ju√°rez / Alberto Bustos</p>
                    <p class="text-slate-500 truncate mt-0.5" id="auth-status">Conectando...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="flex-1 flex flex-col relative min-w-0 h-screen overflow-hidden">
        <div class="md:hidden bg-white p-4 border-b border-slate-200 flex justify-between items-center shadow-sm sticky top-0 z-20">
            <span class="font-bold text-slate-800 flex items-center gap-2 text-sm">
                <i class="ph ph-squares-four text-teal-600"></i> Portal de Apoyo Pedag√≥gico A y S Dimensi√≥n 1 PNFT
            </span>
            <button onclick="renderView('dashboard')" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                <i class="ph ph-house text-xl"></i>
            </button>
        </div>

        <div id="app-content" class="flex-1 p-6 md:p-12 overflow-y-auto h-full pb-20"></div>

        <!-- MODAL LOGIN UNIFICADO -->
        <div id="auth-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md mx-4 relative overflow-hidden">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-slate-900 shadow-sm border border-slate-100">
                        <i class="ph-bold ph-fingerprint text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-black text-slate-800 tracking-tight">Identificaci√≥n Oficial</h3>
                    <p class="text-xs text-slate-500 mt-2 font-medium">Acceso exclusivo para funcionarios <strong>@mep.go.cr</strong></p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Correo Institucional</label>
                        <div class="relative">
                            <i class="ph ph-envelope absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="email" id="auth-email" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all text-sm font-bold text-slate-700 placeholder-slate-400" placeholder="nombre.apellido@mep.go.cr">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Contrase√±a</label>
                        <div class="relative">
                            <i class="ph ph-lock-key absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="password" id="auth-password" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all text-sm font-bold text-slate-700 placeholder-slate-400" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    
                    <div id="auth-error" class="bg-red-50 text-red-600 p-3 rounded-xl text-xs font-bold flex items-center gap-2 hidden animate-pulse">
                        <i class="ph-fill ph-warning-circle"></i> <span id="auth-error-text">Error de credenciales</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button onclick="handleAuth('login')" class="bg-slate-900 text-white py-3.5 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 active:scale-95">Entrar</button>
                        <button onclick="handleAuth('register')" class="bg-white border-2 border-slate-200 text-slate-700 py-3.5 rounded-xl text-xs font-black uppercase tracking-widest hover:border-slate-300 hover:bg-slate-50 transition-all active:scale-95">Registrarse</button>
                    </div>
                    <button onclick="closeAuthModal()" class="w-full text-slate-400 py-2 text-[10px] font-black uppercase tracking-widest hover:text-slate-600 transition-colors mt-2">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- MODAL FORO -->
        <div id="forum-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-xl mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-slate-800">Nueva Discusi√≥n</h3>
                    <button onclick="closeForumModal()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors"><i class="ph-bold ph-x"></i></button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="post-title" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 font-bold text-slate-700 placeholder-slate-400" placeholder="T√≠tulo del tema">
                    <select id="post-tag" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 font-bold text-slate-700">
                        <option value="Metodolog√≠a">Metodolog√≠a / Design Thinking</option>
                        <option value="Evaluaci√≥n">Evaluaci√≥n del Proyecto</option>
                        <option value="Administrativo">Administrativo / Laboratoio</option>
                        <option value="Consulta">Consulta a aseso</option>
                        <option value="Recursos">Recursos Did√°cticos</option>
                    </select>
                    <textarea id="post-content" class="w-full h-40 p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 font-medium text-slate-700 placeholder-slate-400 resize-none" placeholder="Escribe tu consulta o aporte..."></textarea>
                    <button onclick="savePost()" class="w-full bg-teal-600 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-teal-700 transition-all shadow-lg shadow-teal-600/20 active:scale-95 flex items-center justify-center gap-2"><i class="ph-bold ph-paper-plane-right"></i> Publicar</button>
                </div>
            </div>
        </div>

        <!-- REPLY MODAL -->
        <div id="reply-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-md mx-4 text-sm">
                <h3 class="text-lg font-black mb-4 text-slate-800 tracking-tight">Responder Consulta</h3>
                <input type="hidden" id="reply-post-id">
                <textarea id="reply-content" class="w-full h-32 p-3 border border-slate-200 rounded-lg text-sm leading-relaxed outline-none focus:ring-2 focus:ring-indigo-500 font-medium" placeholder="Escribe tu respuesta t√©cnica oficial aqu√≠..."></textarea>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="closeReplyModal()" class="px-4 py-2 text-slate-500 font-bold uppercase text-[10px]">Cancelar</button>
                    <button onclick="saveReply()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-black text-[10px] uppercase tracking-widest hover:bg-indigo-700 shadow-md font-bold">Enviar Respuesta</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. CONFIGURACI√ìN
        // Using the exact config provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBABrNvQH1Zu-peF3Rn1uCe-Yfb2LBGC9A",
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:f096970be5c69a465988aa"
        };
        
        // We initialize with the provided config.
        // We also check for a stored local key, but default to the config's key if available.
        let apiKeyGemini = localStorage.getItem('gemini_api_key') || firebaseConfig.apiKey; 
        
        const appId = firebaseConfig.appId; // Using the provided appId
        const MODEL_NAME = "gemini-1.5-flash-latest";
        
        const ADVISOR_EMAILS = ["alberto.bustos.ortega@mep.go.cr", "rodolfo.juarez.perez@mep.go.cr"];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. ESTADO GLOBAL
        window.state = { view: 'dashboard', user: null, advisor: false, posts: [], institutions: [], accessLogs: [], guideLevel: '7', guideTab: 'curriculum' };

        // 3. DATOS EST√ÅTICOS
        const TEACHER_GUIDE_DATA = {
            pillars: [
                "Apropiaci√≥n Tecnol√≥gica: Hardware, software y herramientas de productividad.",
                "Programaci√≥n y Algoritmos: Desarrollo del pensamiento l√≥gico.",
                "Computaci√≥n F√≠sica y Rob√≥tica: Electr√≥nica, mec√°nica y creaci√≥n de artefactos.",
                "Ciencia de Datos e IA: An√°lisis de datos y comprensi√≥n de la inteligencia artificial."
            ],
            axes: ["Pensamiento Computacional", "Ciudadan√≠a Digital", "Emprendimiento"],
            knowledgeTypes: [
                "Conceptuales: El 'saber' (temas t√©cnicos).",
                "Procedimentales: El 'saber hacer' (abstraer, depurar, programar).",
                "Actitudinales: El 'ser' (tolerancia a la frustraci√≥n, precisi√≥n y √©tica)."
            ],
            levels: {
                "7": { 
                    title: "S√©timo: Fundamentos y L√≥gica", 
                    focus: "Hardware/Software, tablas de verdad, algoritmos b√°sicos, herramientas de nube y netiqueta.",
                    modules: [
                        { name: "M√≥dulo 1: Fundamentos", topics: ["Hardware y Perif√©ricos", "Software y Funciones", "Sistemas Operativos", "Algoritmos (Entrada/Proceso/Salida)", "Tablas de Verdad", "Estructuras Condicionales", "Tipos de Datos"] },
                        { name: "M√≥dulo 2: Ciudadan√≠a Digital", topics: ["Internet y Navegadores", "Almacenamiento Nube", "Netiqueta", "Ciberseguridad", "Multimedia Gr√°fica", "Fundamentos IA", "Bucles"] }
                    ]
                },
                "8": { 
                    title: "Octavo: Multimedia y Rob√≥tica", 
                    focus: "Edici√≥n de video, redes, circuitos el√©ctricos, microcontroladores, IoT y ciberseguridad.",
                    modules: [
                        { name: "M√≥dulo 1: Rob√≥tica F√≠sica", topics: ["Hardware Interno", "Software Libre vs Paga", "Compresi√≥n Archivos", "Edici√≥n Audio/Video", "Mecanismos Rob√≥ticos", "Circuitos El√©ctricos", "Fundamentos Electr√≥nica", "Entorno programaci√≥n rob√≥tica"] },
                        { name: "M√≥dulo 2: Datos y Sensores", topics: ["Hoja de C√°lculo (Datos)", "Internet de las Cosas (IoT)", "Sensores y Actuadores", "Microcontroladores", "Recolecci√≥n de Datos", "IA Generativa"] }
                    ]
                },
                "9": { 
                    title: "Noveno: Prototipado y Conectividad", 
                    focus: "Dom√≥tica, prototipos avanzados, modelado 3D, bases de datos y √©tica en la IA.",
                    modules: [
                        { name: "M√≥dulo 1: Automatizaci√≥n", topics: ["Microcontroladores Avanzados", "Dom√≥tica", "Prototipado Real", "Algoritmos Complejos", "Optimizaci√≥n SO"] },
                        { name: "M√≥dulo 2: Gesti√≥n y √âtica", topics: ["Gestores Base de Datos", "Protocolos Red (HTTP/TCP)", "Derechos de Autor", "Huella Digital", "√âtica y Sesgos IA", "Modelado 3D"] }
                    ]
                }
            },
            methodology: {
                title: "Metodolog√≠a y Evaluaci√≥n",
                strategies: ["Aprendizaje Basado en Juegos (ABJ)", "Aprendizaje Basado en Retos (ABR)", "Design Thinking"],
                role: "Facilitador que contextualiza las estrategias y prioriza la l√≥gica algor√≠tmica antes que la codificaci√≥n pura.",
                eval: "Basada en indicadores de logro espec√≠ficos que miden desde la clasificaci√≥n de componentes hasta el dise√±o de soluciones automatizadas complejas."
            },
            project: { phases: [{name:"Empatizar"}, {name:"Definir"}, {name:"Idear"}, {name:"Prototipar"}, {name:"Evaluar"}] }
        };

        const DOCUMENT_SUMMARY = [
            { 
                title: "1. Niveles de Implementaci√≥n y Cobertura", 
                icon: "ph-buildings", 
                subsections: [{ 
                    subtitle: "Modalidades 2026", 
                    points: [
                        "III Ciclo (Acad√©mico): Implementaci√≥n completa en los niveles de 7¬∞, 8¬∞ y 9¬∞.",
                        "Educaci√≥n Diversificada: No se implementar√° el curr√≠culo de Formaci√≥n Tecnol√≥gica (FT) en el ciclo acad√©mico este a√±o.",
                        "CTP: No se imparte en III Ciclo ni Diversificada t√©cnica. S√≠ se implementa en Ciclo Diversificado Vocacional (seg√∫n matr√≠cula).",
                        "EPJA: Se implementar√° en IPEC, CINDEA, CAN y CONED, sujeto a la infraestructura y recursos."
                    ] 
                }] 
            },
            { 
                title: "2. Disposiciones Administrativas y Carga Horaria", 
                icon: "ph-user-gear", 
                subsections: [{ 
                    subtitle: "Organizaci√≥n", 
                    points: [
                        "Carga Horaria: Asignaci√≥n basada en la matr√≠cula (no cuota fija).",
                        "Responsabilidad: El docente de Inform√°tica Educativa tiene la responsabilidad total de la lecci√≥n.",
                        "Lecciones: 2 lecciones semanales.",
                        "Evaluaci√≥n: Car√°cter sumativo."
                    ] 
                }] 
            },
            { 
                title: "3. Metodolog√≠a: Enfoque en Proyectos", 
                icon: "ph-chalkboard-teacher", 
                subsections: [{ 
                    subtitle: "Estrategias Pedag√≥gicas", 
                    points: [
                        "Estrategia Base: Se recomienda el uso de Design Thinking.",
                        "Flexibilidad: El docente puede optar por otras metodolog√≠as activas si incorpora componente de proyecto y evaluaci√≥n sumativa (con propuesta previa).",
                        "Estructura: Dos m√≥dulos anuales (uno por periodo) que integran Programaci√≥n, Rob√≥tica, IA y Apropiaci√≥n."
                    ] 
                }] 
            },
            { 
                title: "4. Evaluaci√≥n de los Aprendizajes", 
                icon: "ph-check-square", 
                subsections: [
                    { 
                        subtitle: "Componente Proyecto", 
                        points: [
                            "Centrada en el Componente Proyecto, realizado √≠ntegramente durante las lecciones.",
                            "Fases: Etapa Inicial (Comprensi√≥n/Planificaci√≥n) y Etapa de Desarrollo/Cierre (Prototipado/Evaluaci√≥n)."
                        ] 
                    },
                    {
                        subtitle: "Desglose de Calificaci√≥n",
                        points: ["Trabajo Cotidiano: 50%", "Proyecto (Uno solo): 30%", "Tareas: 10%", "Asistencia: 10%"]
                    }
                ] 
            },
            { 
                title: "5. Gesti√≥n de Recursos y Responsabilidades", 
                icon: "ph-monitor-play", 
                subsections: [{ 
                    subtitle: "Control de Equipos", 
                    points: [
                        "Docente es custodio legal de laboratorios y dispositivos.",
                        "Obligatorio mantener actualizada la bit√°cora y el inventario en TecnoPresta.",
                        "Se debe mantener carpeta institucional (f√≠sica o digital).",
                        "Prioridad absoluta de las lecciones de IE sobre el uso del equipo."
                    ] 
                }] 
            },
            {
                title: "6. Planeamiento Did√°ctico",
                icon: "ph-pencil-line",
                subsections: [{
                    subtitle: "Lineamientos",
                    points: [
                        "Periodicidad: Bimestral.",
                        "Nivel: Planificaci√≥n por nivel educativo, considerando particularidades.",
                        "Herramientas: Obligatorio el uso de la plantilla actualizada 2026."
                    ]
                }]
            }
        ];

        // --- 4. FUNCIONES DE L√ìGICA (DEFINIDAS ANTES DE USARSE) ---
        
        // Manejador seguro de listeners
        const setupRealtimeListeners = () => {
            try {
                const forumRef = collection(db, 'artifacts', appId, 'public', 'data', 'forum');
                const instRef = collection(db, 'artifacts', appId, 'public', 'data', 'institutions');
                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'access_logs');

                onSnapshot(query(forumRef, orderBy("timestamp", "desc")), (snapshot) => {
                    window.state.posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (window.state.view === 'forum') renderView('forum');
                }, (e) => console.log("Forum sync limited"));

                onSnapshot(instRef, (snapshot) => {
                    window.state.institutions = snapshot.docs.map(d => ({ code: d.id, ...d.data() }));
                    if (window.state.view === 'advisorDashboard') renderView('advisorDashboard');
                }, (e) => console.log("Inst sync limited"));
                
                if (window.state.advisor) {
                    onSnapshot(query(logsRef, orderBy("timestamp", "desc")), (snapshot) => {
                        window.state.accessLogs = snapshot.docs.map(d => d.data());
                        if (window.state.view === 'advisorDashboard') renderView('advisorDashboard');
                    }, (e) => console.log("Logs sync limited"));
                }
            } catch (e) { console.log("Error en listeners:", e); }
        };

        const initApp = async () => {
            try { await signInAnonymously(auth); } 
            catch (e) { document.getElementById('auth-status').innerText = "Modo Visitante"; }
        };

        // --- 5. FUNCIONES GLOBALES (VINCULACI√ìN A WINDOW) ---
        
        window.openTeacherAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeTeacherAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');
        window.closeAuthModal = window.closeTeacherAuthModal;

        window.openForumModal = () => document.getElementById('forum-modal').classList.remove('hidden');
        window.closeForumModal = () => document.getElementById('forum-modal').classList.add('hidden');
        window.openReplyModal = (id) => { document.getElementById('reply-post-id').value = id; document.getElementById('reply-modal').classList.remove('hidden'); };
        window.closeReplyModal = () => document.getElementById('reply-modal').classList.add('hidden');

        window.saveApiKey = () => {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                apiKeyGemini = key;
                window.showToast("API Key guardada ‚úÖ");
            }
        };

        window.handleAuth = async (mode) => {
            const email = document.getElementById('auth-email').value.trim().toLowerCase();
            const password = document.getElementById('auth-password').value;
            const err = document.getElementById('auth-error');
            const errText = document.getElementById('auth-error-text');
            if (!email.endsWith('@mep.go.cr')) {
                errText.innerText = "Solo correos @mep.go.cr";
                err.classList.remove('hidden');
                return;
            }
            try {
                if (mode === 'register') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    window.showToast("Cuenta creada. ¬°Bienvenido!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.showToast("Sesi√≥n iniciada correctamente.");
                }
                window.closeAuthModal();
            } catch (e) {
                errText.innerText = e.code === 'auth/wrong-password' ? "Contrase√±a incorrecta" : "Error de autenticaci√≥n";
                err.classList.remove('hidden');
            }
        };

        window.logout = async () => {
            await signOut(auth);
            try { await signInAnonymously(auth); } catch(e){}
            window.showToast("Sesi√≥n cerrada.");
            window.renderView('dashboard');
        };

        window.savePost = async () => {
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const tag = document.getElementById('post-tag').value;
            if (!title || !content) return;
            const author = window.state.advisor ? "Asesor Nacional" : (window.state.user.email || "Docente");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'forum'), { title, content, tag, author, date: new Date().toLocaleDateString(), timestamp: Date.now() });
                window.closeForumModal(); window.showToast("Publicado.");
            } catch(e) { window.showToast("Error de permisos/escritura"); }
        };

        window.saveReply = async () => {
            const id = document.getElementById('reply-post-id').value;
            const content = document.getElementById('reply-content').value;
            if(!content) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'forum', id), { reply: content });
                window.closeReplyModal(); window.showToast("Respuesta enviada.");
            } catch(e) { window.showToast("Error de permisos"); }
        };

        window.deletePost = async (id) => {
            if (confirm("¬øEliminar esta publicaci√≥n?")) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'forum', id)); }
                catch(e) { window.showToast("Error de permisos"); }
            }
        };

        window.handleExcel = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const advisorName = document.getElementById('import-advisor-select').value;
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let count = 0;
                for (const row of data) {
                    const code = String(row["C√≥digo Presupuestario"] || Math.random().toString(36).substr(2, 9));
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'institutions', code), {
                            code, name: row["CENTRO_EDUCATIVO"] || "Sin Nombre",
                            email: row["Correo institucional"] || "", regional: row["REGIONAL"] || "",
                            circuito: row["CIRCUITO"] || "", advisor: advisorName, status: 'pending', date: ""
                        });
                        count++;
                    } catch(e) {}
                }
                window.showToast(`${count} registros cargados`);
            };
            reader.readAsArrayBuffer(file);
        };

        window.toggleStatus = async (code) => {
            const inst = window.state.institutions.find(i => i.code === code);
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'institutions', code), {
                    status: inst.status === 'done' ? 'pending' : 'done'
                });
            } catch(e) { window.showToast("Error de permisos"); }
        };

        window.updateDate = async (code, val) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'institutions', code), { date: val }); }
            catch(e) { window.showToast("Error de permisos"); }
        };

        async function callGeminiAPI(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKeyGemini}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "Error: Verifique su API Key en el Tablero de Gesti√≥n."; }
        }

        window.askAI = async () => {
            const q = document.getElementById('ai-q').value;
            const r = document.getElementById('ai-r');
            if(!q) return;
            r.classList.remove('hidden');
            r.innerHTML = '<span class="animate-pulse">‚ú® Pensando...</span>';
            const res = await callGeminiAPI(`Consulta docente secundaria: ${q}. Responde de forma t√©cnica, puntual, en vi√±etas y sin introducci√≥n.`);
            r.innerHTML = `<div class="prose prose-sm text-slate-200 max-w-none shadow-inner p-2 font-bold">${res}</div>`;
        };

        window.generateProjectIdeas = async () => {
            const level = window.state.guideLevel; const theme = document.getElementById('project-theme').value || "Contexto Educativo";
            const topics = Array.from(document.querySelectorAll('.topic-checkbox:checked')).map(cb => cb.value);
            if (topics.length === 0) { window.showToast("Seleccione al menos un saber"); return; }
            const r = document.getElementById('project-ai-results'); r.classList.remove('hidden');
            r.innerHTML = '<span class="animate-pulse">Generando propuestas...</span>';
            const prompt = `Genera 3 situaciones problema de contexto educativo real para ${level}¬∞ a√±o. Tema: ${theme}. Integra obligatoriamente estos saberes: ${topics.join(', ')}. Formato: Solo lista de vi√±etas. Sin introducci√≥n ni conclusi√≥n.`;
            const res = await callGeminiAPI(prompt);
            r.innerHTML = `<div class="bg-indigo-900 p-6 rounded-2xl text-slate-300 text-sm mt-4">${res}</div>`;
        };

        window.analyzeAdvisorDashboard = async () => {
            const r = document.getElementById('ai-advisor-results'); r.classList.remove('hidden');
            r.innerHTML = '<span class="animate-pulse">‚ú® Analizando datos...</span>';
            const data = window.state.institutions.map(i => `${i.name} (${i.regional}): ${i.status}`).join(', ');
            const res = await callGeminiAPI(`Analiza cobertura regional (resumen ejecutivo): ${data.substring(0,2000)}. Responde de forma puntual y en vi√±etas.`);
            r.innerHTML = `<div class="bg-indigo-900 text-white p-6 rounded-2xl text-xs font-medium">${res}</div>`;
        };

        window.logAccess = async () => {
            if (!window.state.user) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'access_logs'), {
                    email: window.state.user.email || "An√≥nimo", type: window.state.advisor ? "Asesor" : "Docente",
                    timestamp: Date.now(), date: new Date().toLocaleString()
                });
            } catch (e) {}
        };

        window.showToast = (msg) => { const t = document.createElement('div'); t.className = 'fixed bottom-4 right-4 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-xl z-50 font-bold text-xs fade-in'; t.innerHTML = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); };

        // --- 6. RENDERIZADO ---
        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const items = [{id:'dashboard', icon:'ph-squares-four', label:'Inicio'}, {section:'Recursos'}, {id:'summary', icon:'ph-clipboard-text', label:'Orientaciones Docentes'}, {id:'teacherGuide', icon:'ph-graduation-cap', label:'Gu√≠a Docente'}, {id:'planner', icon:'ph-calendar-check', label:'Planeamiento 2026'}, {id:'forum', icon:'ph-users-three', label:'Comunidad Docente'}, {section:'Herramientas'}, {id:'ai', icon:'ph-sparkle', label:'Asistente IA'}];
            if (window.state.advisor) items.push({section:'Gesti√≥n'}, {id:'advisorDashboard', icon:'ph-chart-pie-slice', label:'Tablero Asesor'});
            nav.innerHTML = items.map(i => i.section ? 
                `<div class="mt-6 mb-2 px-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">${i.section}</div>` : 
                `<button onclick="renderView('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${window.state.view === i.id ? 'bg-teal-50 text-teal-700' : 'text-slate-500 hover:bg-slate-50'}"><i class="ph ${i.icon} text-lg"></i>${i.label}</button>`
            ).join('');
            
            nav.innerHTML += window.state.user && !window.state.user.isAnonymous ? 
                `<button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-red-500 hover:bg-red-50 mt-4"><i class="ph ph-sign-out"></i>Cerrar Sesi√≥n</button>` :
                `<button onclick="openTeacherAuthModal()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-800 bg-slate-100 hover:bg-slate-200 mt-4"><i class="ph ph-sign-in"></i>Ingresar</button>`;
        }

        window.renderView = (viewId) => {
            window.state.view = viewId; renderSidebar();
            const c = document.getElementById('app-content');
            
            if (viewId === 'dashboard') {
                c.innerHTML = `
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-10 text-white mb-8 relative overflow-hidden">
                        <i class="ph ph-rocket-launch absolute top-0 right-0 p-10 text-9xl opacity-10"></i>
                        <h1 class="text-4xl font-black mb-2">Portal de Apoyo Dimensi√≥n 1 PNFT</h1>
                        <p class="text-slate-400">Gesti√≥n t√©cnica y pedag√≥gica exclusiva para secundaria 2026.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm cursor-pointer hover:border-teal-500 transition-colors" onclick="renderView('teacherGuide')"><i class="ph ph-graduation-cap text-3xl text-teal-600 mb-4"></i><h3 class="font-bold text-lg">Malla Curricular</h3></div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-blue-500 cursor-pointer transition-colors" onclick="renderView('forum')"><i class="ph ph-users-three text-3xl text-blue-600 mb-4"></i><h3 class="font-bold text-lg">Comunidad</h3></div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-purple-500 cursor-pointer transition-colors" onclick="renderView('ai')"><i class="ph ph-sparkle text-3xl text-purple-600 mb-4"></i><h3 class="font-bold text-lg">Asistente IA</h3></div>
                    </div>`;
            } else if (viewId === 'summary') {
                c.innerHTML = `
                    <h2 class="text-3xl font-black text-slate-800 mb-8">Orientaciones Generales 2026 (Secundaria)</h2>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 mb-8 flex items-center gap-4 shadow-sm">
                        <div class="p-3 bg-teal-50 text-teal-600 rounded-full"><i class="ph ph-speaker-high text-2xl"></i></div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm">Resumen en Audio</h4>
                            <video controls class="w-full h-10 mt-2 rounded bg-slate-100"><source src="https://res.cloudinary.com/dljxx3chc/video/upload/v1769616584/Orientaciones_Docente_2026_t1q9so.mp4" type="video/mp4"></video>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">${DOCUMENT_SUMMARY.map(s => `<div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm"><h3 class="font-bold text-lg mb-4 flex gap-2 items-center"><i class="ph ${s.icon} text-teal-600"></i>${s.title}</h3><ul class="list-disc pl-5 text-sm text-slate-600 space-y-2">${s.subsections[0].points.map(p => `<li>${p}</li>`).join('')}</ul>${s.title.includes("6.") ? `<div class="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-3"><a href="https://res.cloudinary.com/dljxx3chc/image/upload/v1740624021/Formaci%C3%B3n_Tecnol%C3%B3gica_Gu%C3%ADa_de_Implementaci%C3%B3n_2026_id9wov.pdf" target="_blank" class="text-teal-600 font-bold text-sm flex items-center gap-2 hover:underline"><i class="ph ph-file-pdf"></i> Descargar Gu√≠a Resumen PDF</a><a href="https://adminmepcr-my.sharepoint.com/:b:/g/personal/alberto_bustos_ortega_mep_go_cr/IQB2V-ZCEVyHRaw6p6kqi6TsAUFYsCO3i6cWwMwPmsR-69U?e=7fz66K" target="_blank" class="text-indigo-600 font-bold text-sm flex items-center gap-2 hover:underline"><i class="ph ph-cloud-arrow-down"></i> Descargar Documento Oficial</a></div>` : ''}</div>`).join('')}</div>`;
            } else if (viewId === 'teacherGuide') {
                const data = TEACHER_GUIDE_DATA.levels[window.state.guideLevel];
                c.innerHTML = `<h2 class="text-3xl font-black mb-6">Gu√≠a Docente Secundaria</h2><div class="flex gap-2 mb-8">${['7','8','9'].map(l => `<button onclick="window.state.guideLevel='${l}';renderView('teacherGuide')" class="px-6 py-2 rounded-xl font-bold transition-all ${window.state.guideLevel === l ? 'bg-teal-600 text-white' : 'bg-white text-slate-500'}">${l}¬∞ A√±o</button>`).join('')}</div><div class="flex border-b mb-8 font-bold">${['curriculum', 'projects'].map(t => `<button onclick="window.state.guideTab='${t}'; renderView('teacherGuide')" class="px-6 py-2 border-b-2 transition-all ${window.state.guideTab === t ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-slate-400'}">${t==='curriculum'?'Malla':'Proyectos ‚ú®'}</button>`).join('')}</div>`;
                if(window.state.guideTab === 'curriculum') {
                    c.innerHTML += `
                    <div class="space-y-6">
                        <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100">
                            <h4 class="font-black text-indigo-800 mb-4 uppercase text-xs tracking-widest">Estructura y √Åreas de Conocimiento</h4>
                            <ul class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
                                ${TEACHER_GUIDE_DATA.pillars.map(p => `<li class="flex gap-2"><i class="ph-fill ph-check-circle text-indigo-500"></i>${p}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-3xl border border-slate-200">
                                <h4 class="font-black text-teal-600 mb-3 uppercase text-xs tracking-widest">Ejes Transversales</h4>
                                <div class="flex flex-wrap gap-2">${TEACHER_GUIDE_DATA.axes.map(a => `<span class="px-3 py-1 bg-teal-50 text-teal-700 rounded-lg text-xs font-bold border border-teal-100">${a}</span>`).join('')}</div>
                            </div>
                            <div class="bg-white p-6 rounded-3xl border border-slate-200">
                                <h4 class="font-black text-teal-600 mb-3 uppercase text-xs tracking-widest">Tipos de Saberes</h4>
                                <ul class="space-y-2 text-xs font-medium text-slate-600">${TEACHER_GUIDE_DATA.knowledgeTypes.map(k => `<li>‚Ä¢ ${k}</li>`).join('')}</ul>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200"><h4 class="font-black text-slate-800 mb-4 uppercase text-xs tracking-widest">M√≥dulos del Nivel ${window.state.guideLevel}¬∞</h4><p class="text-sm text-slate-500 mb-4 font-bold">${data.focus}</p><div class="grid md:grid-cols-2 gap-6">${data.modules.map(m => `<div class="bg-slate-50 p-5 rounded-2xl"><h5 class="font-bold text-slate-800 mb-2">${m.name}</h5><ul class="space-y-1 text-xs text-slate-600">${m.topics.map(t => `<li class="flex items-center gap-2"><div class="w-1.5 h-1.5 bg-teal-500 rounded-full"></div>${t}</li>`).join('')}</ul></div>`).join('')}</div></div>
                        <div class="bg-orange-50 p-6 rounded-3xl border border-orange-100"><h4 class="font-black text-orange-800 mb-3 uppercase text-xs tracking-widest">Metodolog√≠a y Evaluaci√≥n</h4><div class="text-sm text-slate-700 space-y-2"><p><strong>Estrategias:</strong> ${TEACHER_GUIDE_DATA.methodology.strategies.join(', ')}</p><p><strong>Rol Docente:</strong> ${TEACHER_GUIDE_DATA.methodology.role}</p><p><strong>Evaluaci√≥n:</strong> ${TEACHER_GUIDE_DATA.methodology.eval}</p></div></div>
                    </div>`;
                } else {
                    c.innerHTML += `<div class="bg-slate-900 p-8 rounded-[2rem] text-white"><div class="flex gap-4 mb-6"><input type="text" id="project-theme" class="flex-1 p-3 rounded-xl bg-slate-800 border-none outline-none font-bold" placeholder="Contexto (ej. Reciclaje)..."><button onclick="generateProjectIdeas()" class="bg-teal-500 px-6 rounded-xl font-bold">Generar</button></div><div class="grid grid-cols-2 gap-4 text-xs mb-6">${data.modules.map(m => m.topics.map(t => `<label class="flex items-center gap-2"><input type="checkbox" value="${t}" class="topic-checkbox"> ${t}</label>`).join('')).join('')}</div><div id="project-ai-results"></div></div><div class="mt-8 bg-white p-6 rounded-2xl border"><h4 class="font-bold mb-4">Design Thinking</h4><div class="grid grid-cols-5 gap-2 text-center text-xs">${TEACHER_GUIDE_DATA.project.phases.map((p,i)=>`<div class="p-2 bg-slate-50 rounded-lg"><div class="font-bold mb-1">${i+1}</div>${p.name}</div>`).join('')}</div></div>`;
                }
            } else if (viewId === 'planner') {
                c.innerHTML = `<div class="text-center py-12"><div class="bg-white p-12 rounded-[3rem] border border-slate-200 shadow-xl inline-block"><i class="ph ph-file-text text-5xl text-indigo-600 mb-6"></i><h2 class="text-3xl font-black text-slate-800 mb-4">Planeamiento 2026</h2><p class="text-slate-500 mb-8">Herramienta oficial para secundaria.</p><a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold hover:bg-black transition-all">Ir a la Plantilla Web</a></div></div>`;
            } else if (viewId === 'forum') {
                c.innerHTML = `<div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-black text-slate-800">Comunidad</h2>${window.state.user && !window.state.user.isAnonymous ? `<button onclick="openForumModal()" class="bg-teal-600 text-white px-6 py-3 rounded-xl font-bold">Publicar</button>` : `<button onclick="openTeacherAuthModal()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold">Ingresar</button>`}</div><div class="space-y-4">${window.state.posts.map(p => `<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><div class="flex justify-between mb-2"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">${p.tag}</span><span class="text-xs text-slate-400 font-bold">${p.date}</span></div><h4 class="font-bold text-lg mb-2">${p.title}</h4><p class="text-sm text-slate-600 mb-4">${p.content}</p>${p.reply ? `<div class="bg-indigo-50 p-4 rounded-xl text-sm border-l-4 border-indigo-500 mb-4"><p class="font-bold text-indigo-800 text-xs mb-1">Respuesta Oficial</p>${p.reply}</div>` : ''}<div class="flex justify-between items-center pt-4 border-t"><span class="text-xs font-bold text-slate-400">Por: ${p.author}</span><div class="flex gap-2">${window.state.advisor ? `<button onclick="openReplyModal('${p.id}')" class="text-indigo-600 text-xs font-bold hover:underline">Responder</button><button onclick="deletePost('${p.id}')" class="text-red-500 text-xs font-bold hover:underline">Eliminar</button>` : ''}</div></div></div>`).join('')}</div>`;
                window.logAccess(); 
            } else if (viewId === 'ai') {
                c.innerHTML = `<div class="max-w-4xl mx-auto"><div class="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-xl"><h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3"><i class="ph-fill ph-sparkle text-purple-600"></i> Asistente Pedag√≥gico</h2><textarea id="ai-q" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 mb-4 h-32 resize-none font-medium" placeholder="Consulta sobre normativa, did√°ctica o evaluaci√≥n..."></textarea><div class="flex justify-end"><button onclick="askAI()" class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition-all">Consultar</button></div><div id="ai-r" class="mt-8 p-6 bg-slate-50 rounded-2xl border border-slate-100 hidden text-sm leading-relaxed text-slate-700"></div></div></div>`;
            } else if (viewId === 'advisorDashboard') {
                const list = window.state.institutions.filter(i => i.advisor.includes(window.state.user.email.includes('alberto') ? 'Alberto' : 'Rodolfo'));
                const logs = (window.state.accessLogs || []).slice(0, 50);
                c.innerHTML = `<div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-black text-slate-800">Tablero de Gesti√≥n</h2><div class="flex gap-3"><div class="bg-white border p-2 rounded-xl flex items-center gap-2"><input type="password" id="api-key-input" placeholder="API Key" class="text-xs w-20 outline-none"><button onclick="saveApiKey()" class="text-xs font-bold">üíæ</button><select id="import-advisor-select" class="text-xs font-bold bg-transparent outline-none"><option value="Alberto Bustos">Alberto</option><option value="Rodolfo Ju√°rez">Rodolfo</option></select><label class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold cursor-pointer hover:bg-black"><i class="ph-bold ph-upload-simple mr-2"></i>Importar<input type="file" class="hidden" onchange="handleExcel(event)"></label></div><button onclick="analyzeAdvisorDashboard()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700">‚ú® Analizar</button></div></div><div id="ai-advisor-results" class="hidden mb-6 bg-indigo-50 p-6 rounded-2xl text-indigo-800 text-sm font-medium"></div><div class="grid lg:grid-cols-3 gap-8"><div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b"><tr><th class="p-4">Instituci√≥n</th><th class="p-4">Estado</th><th class="p-4">Fecha</th><th class="p-4 text-right">Acci√≥n</th></tr></thead><tbody class="divide-y divide-slate-100">${list.map(i => `<tr class="hover:bg-slate-50"><td class="p-4 font-bold text-slate-700">${i.name}<br><span class="text-xs text-slate-400 font-normal">${i.code} | ${i.regional}</span></td><td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${i.status==='done'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${i.status==='done'?'VISITADO':'PENDIENTE'}</span></td><td class="p-4"><input type="date" value="${i.date||''}" onchange="updateDate('${i.code}',this.value)" class="text-xs border rounded p-1"></td><td class="p-4 text-right"><button onclick="toggleStatus('${i.code}')" class="text-slate-400 hover:text-teal-600"><i class="ph-bold ph-arrows-clockwise text-xl"></i></button></td></tr>`).join('')}</tbody></table></div><div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 h-[500px] overflow-y-auto"><h3 class="font-bold mb-4">Registros</h3>${logs.map(l => `<div class="mb-3 p-3 bg-slate-50 rounded-xl text-xs"><p class="font-bold">${l.email}</p><p>${l.date}</p></div>`).join('')}</div></div>`;
            }
        };

        // --- AUTH LISTENER ---
        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user && !user.isAnonymous) {
                window.state.advisor = ADVISOR_EMAILS.includes(user.email.toLowerCase());
                document.getElementById('auth-status').innerText = window.state.advisor ? "Asesor Nacional ‚úÖ" : "Docente MEP ‚úÖ";
            } else {
                window.state.advisor = false;
                document.getElementById('auth-status').innerText = "Invitado";
            }
            setupRealtimeListeners();
            renderSidebar();
            if (['forum', 'advisorDashboard'].includes(window.state.view)) renderView(window.state.view);
        });

        initApp();
        renderView('dashboard');
    </script>
</body>
</html>
