<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal PNFT 2026 | Acceso Seguro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: white; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 12px; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #14b8a6; box-shadow: 0 0 10px rgba(20, 184, 166, 0.2); }
        .tab-btn { padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; color: #64748b; font-weight: bold; width: 50%; text-align: center; }
        .tab-btn.active { border-color: #14b8a6; color: #14b8a6; }
        .hidden { display: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black p-4">

    <div id="auth-container" class="glass p-8 rounded-[2rem] max-w-md w-full shadow-2xl relative animate-fade-in">
        
        <div class="flex mb-6 border-b border-slate-700">
            <div id="tab-login" class="tab-btn active" onclick="switchTab('login')">INGRESAR</div>
            <div id="tab-register" class="tab-btn" onclick="switchTab('register')">REGISTRARSE</div>
        </div>

        <div id="form-login">
            <h2 class="text-2xl font-bold mb-4">Bienvenido Docente</h2>
            <input type="email" id="login-email" class="input-field" placeholder="Correo Institucional (@mep.go.cr)">
            <input type="password" id="login-pass" class="input-field" placeholder="Contrase√±a">
            <button onclick="loginUser()" class="w-full bg-teal-500 hover:bg-teal-400 text-slate-900 font-bold py-3 rounded-xl transition mt-2">
                Iniciar Sesi√≥n
            </button>
        </div>

        <div id="form-register" class="hidden">
            <h2 class="text-xl font-bold mb-1">Crear Cuenta Nueva</h2>
            <p class="text-xs text-slate-400 mb-4">Todos los datos son obligatorios para auditor√≠a.</p>
            
            <input type="text" id="reg-name" class="input-field" placeholder="Nombre Completo">
            <input type="email" id="reg-email" class="input-field" placeholder="Correo (@mep.go.cr)">
            <input type="tel" id="reg-phone" class="input-field" placeholder="Tel√©fono Celular (8 d√≠gitos)" maxlength="8">
            <input type="text" id="reg-code" class="input-field" placeholder="C√≥digo de Instituci√≥n (Ej: 4056)">
            <input type="password" id="reg-pass" class="input-field" placeholder="Crear Contrase√±a (m√≠n 6 caracteres)">
            
            <button onclick="registerUser()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition mt-2">
                Registrar mis Datos
            </button>
        </div>

        <p id="feedback" class="mt-4 text-xs font-mono text-center h-4 text-red-400"></p>
    </div>

    <div id="app-content" class="hidden text-center max-w-2xl">
        <div class="glass p-12 rounded-[3rem]">
            <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center text-green-400 mx-auto mb-6">
                <i class="ph-fill ph-check-circle text-4xl"></i>
            </div>
            <h2 class="text-4xl font-black text-white mb-2">Acceso Autorizado</h2>
            <p class="text-xl text-teal-400 font-bold" id="welcome-name">Usuario</p>
            <p class="text-slate-400 mt-2">C√≥digo Institucional: <span id="welcome-code" class="text-white font-mono">...</span></p>
            
            <div class="mt-8 grid grid-cols-2 gap-4 text-left bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <div>
                    <span class="text-[10px] uppercase text-slate-500 font-bold">Estado</span>
                    <p class="text-green-400 font-bold text-sm">‚óè Activo</p>
                </div>
                <div>
                     <span class="text-[10px] uppercase text-slate-500 font-bold">Tel√©fono Verificado</span>
                    <p id="welcome-phone" class="text-white font-bold text-sm">...</p>
                </div>
            </div>

            <button onclick="logout()" class="mt-8 text-red-400 hover:text-red-300 text-sm font-bold underline">Cerrar Sesi√≥n Segura</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // üëá PEGA TU LLAVE AQU√ç üëá
        const firebaseConfig = {
            apiKey: "AIzaSyCNX4Z5h33uLz3V_zdFgF7LhVM-GGaq4WE", // La que termina en ...Stv84
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:f096970be5c69a465988aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- L√≥gica de Interfaz ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            if(tab === 'login') {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-register').classList.add('hidden');
            } else {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-register').classList.remove('hidden');
            }
            showError("");
        };

        function showError(msg) {
            const el = document.getElementById('feedback');
            el.innerText = msg;
            el.className = msg ? "mt-4 text-xs font-mono text-center h-4 text-red-400 animate-pulse" : "mt-4 h-4";
        }

        // --- L√≥gica de REGISTRO ---
        window.registerUser = async () => {
            const email = document.getElementById('reg-email').value.trim().toLowerCase();
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value.trim();
            const code = document.getElementById('reg-code').value.trim();

            // 1. Validaciones
            if(!email.endsWith('@mep.go.cr')) return showError("‚õî Error: Solo se permiten correos @mep.go.cr");
            if(pass.length < 6) return showError("‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres");
            if(!name || !code) return showError("‚ö†Ô∏è Nombre y C√≥digo son obligatorios");
            
            // Validaci√≥n Tel√©fono (Formato CR simple)
            const phoneRegex = /^[2-9][0-9]{7}$/; // Empieza con 2-9 y tiene 8 d√≠gitos en total
            if(!phoneRegex.test(phone)) return showError("üìû El tel√©fono debe ser un n√∫mero v√°lido de 8 d√≠gitos.");

            showError("‚è≥ Registrando en sistema nacional...");

            try {
                // 2. Crear usuario en Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                // 3. Guardar datos extra en Firestore
                await setDoc(doc(db, "registro_usuarios", user.uid), {
                    nombre: name,
                    email: email,
                    telefono: phone,
                    codigo_institucion: code,
                    fecha_registro: serverTimestamp(),
                    rol: "docente"
                });

                showError("‚úÖ Registro exitoso. Ingresando...");
                // AuthStateChanged se encargar√° de mostrar la app

            } catch (error) {
                console.error(error);
                if(error.code === 'auth/email-already-in-use') showError("‚ö†Ô∏è Ese correo ya est√° registrado.");
                else showError("Error: " + error.message);
            }
        };

        // --- L√≥gica de LOGIN ---
        window.loginUser = async () => {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-pass').value;

            if(!email || !pass) return showError("‚ö†Ô∏è Faltan datos");

            showError("‚è≥ Verificando credenciales...");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // AuthStateChanged manejar√° la entrada
            } catch (error) {
                console.error(error);
                if(error.code === 'auth/invalid-credential') showError("‚õî Correo o contrase√±a incorrectos");
                else showError("Error: " + error.message);
            }
        };

        window.logout = () => signOut(auth);

        // --- Monitor de Sesi√≥n ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario logueado: Buscar sus datos extra
                const docRef = await getDoc(doc(db, "registro_usuarios", user.uid));
                
                if (docRef.exists()) {
                    const data = docRef.data();
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    
                    document.getElementById('welcome-name').innerText = data.nombre;
                    document.getElementById('welcome-code').innerText = data.codigo_institucion;
                    document.getElementById('welcome-phone').innerText = data.telefono;
                } else {
                    // Si el usuario existe en Auth pero no tiene datos en DB (Raro, pero posible)
                    showError("‚ö†Ô∏è Error de integridad de datos. Contacte al admin.");
                    logout();
                }
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('login-email').value = "";
                document.getElementById('login-pass').value = "";
                showError("");
            }
        });
    </script>
</body>
</html>

