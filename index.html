<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recurso de Asesoría y Seguimiento 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap');

        :root {
            --primary: #025964;
            /* Sober Deep Teal */
            --primary-light: #f1f8f9;
            --accent: #008e9b;
            /* Medium Teal */
            --bg-main: #ffffff;
            --text-main: #1a202c;
            --text-muted: #718096;
            --glass-bg: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            line-height: 1.6;
            letter-spacing: 0.02em;
            /* Added global tracking */
            word-spacing: 0.05em;
            /* Improved word separation */
        }

        p {
            line-height: 1.75;
            letter-spacing: 0.015em;
            /* Slightly tighter for paragraphs than headings */
            margin-bottom: 1.25rem;
        }

        /* Glassmorphism Light */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Inputs & Tabs */
        .input-field {
            background: white;
            border: 1px solid #e2e8f0;
            color: var(--text-main);
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(2, 89, 100, 0.1);
            transform: translateY(-1px);
        }

        .tab-btn {
            padding: 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-weight: 700;
            width: 50%;
            text-align: center;
            transition: 0.3s;
            letter-spacing: 0.05em;
        }

        .tab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(2, 89, 100, 0.03);
        }

        /* Navegación Lateral */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            border-radius: 14px;
            color: var(--text-muted);
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            margin-bottom: 6px;
        }

        .nav-item:hover {
            background: rgba(2, 89, 100, 0.05);
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 8px 20px -6px rgba(2, 89, 100, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            body {
                overflow: auto;
                /* Allow body scroll on mobile if needed */
            }

            #app-layout {
                flex-direction: column;
            }

            aside {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 290px;
                z-index: 100;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.1);
                background: white !important;
                /* Solid background for mobile to avoid blur issues */
                backdrop-filter: none !important;
            }

            aside.open {
                left: 0;
            }

            main {
                width: 100%;
            }

            header {
                padding: 0 1.5rem;
                height: 80px;
            }

            #content-area {
                padding: 1.5rem;
            }

            /* Responsive Grid Helpers */
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Exceptions for very small grids like levels */
            .no-stack-mobile {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(2, 89, 100, 0.2);
                backdrop-filter: blur(4px);
                z-index: 90;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Estilos específicos para La Experiencia */
        .reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        .experience-tab-btn {
            transition: all 0.3s ease;
        }

        .experience-tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 89, 100, 0.2);
        }
    </style>
</head>

<body>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-white">
        <div class="glass p-10 rounded-[2.5rem] max-w-md w-full shadow-2xl border-t-8 border-[#025964] fade-in">
            <div class="text-center mb-10">
                <div
                    class="w-20 h-20 bg-[#025964] rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-[#025964]/10 transform -rotate-2">
                    <i class="ph-bold ph-cube text-4xl"></i>
                </div>
                <h1 class="text-3xl font-black tracking-tight text-slate-800">Recurso A y S</h1>
                <p class="text-slate-500 text-[10px] uppercase tracking-widest font-black mt-1">Dimensión 1 | PNFT</p>
                <p class="text-[9px] text-slate-400 font-bold uppercase mt-2">Rodolfo Juarez | Alberto Bustos</p>
            </div>

            <div class="flex mb-8 bg-slate-100/50 p-1.5 rounded-2xl">
                <div id="tab-login" class="tab-btn active rounded-xl" onclick="switchAuthTab('login')">INGRESAR</div>
                <div id="tab-register" class="tab-btn rounded-xl" onclick="switchAuthTab('register')">REGISTRO</div>
            </div>

            <div id="form-login" class="space-y-4">
                <div class="relative group">
                    <i
                        class="ph ph-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[#025964]"></i>
                    <input type="email" id="login-email" class="input-field !pl-12" placeholder="Correo (@mep.go.cr)">
                </div>
                <div class="relative group">
                    <i
                        class="ph ph-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[#025964]"></i>
                    <input type="password" id="login-pass" class="input-field !pl-12" placeholder="Contraseña">
                </div>
                <button onclick="loginUser()"
                    class="w-full bg-[#025964] hover:bg-[#008e9b] text-white font-bold py-4 rounded-2xl transition-all hover:scale-[1.01] active:scale-[0.98] mt-4 shadow-xl shadow-[#025964]/10">
                    Iniciar Sesión
                </button>
                <p class="text-center mt-6">
                    <a href="#" onclick="showRecoverForm()"
                        class="text-[10px] font-black text-[#025964] uppercase tracking-widest hover:underline decoration-2 underline-offset-4">¿Olvidaste
                        tu correo?</a>
                </p>
            </div>

            <div id="form-recover" class="hidden space-y-4">
                <div class="bg-teal-50 p-4 rounded-2xl border border-teal-100 mb-4">
                    <p class="text-[9px] font-black text-[#025964] uppercase leading-tight italic">Ingresa tus datos
                        exactos de registro para recuperar tu dirección @mep.go.cr</p>
                </div>
                <input type="text" id="recover-name" class="input-field" placeholder="Nombre Completo">
                <input type="text" id="recover-code" class="input-field" placeholder="Cód. Institucional (4 dígitos)">
                <button onclick="recuperarEmail()"
                    class="w-full bg-[#025964] text-white font-bold py-4 rounded-2xl transition-all shadow-lg">
                    Buscar Correo
                </button>
                <button onclick="switchAuthTab('login')"
                    class="w-full text-[10px] font-black text-slate-400 uppercase tracking-widest py-2">Volver al
                    Login</button>
            </div>

            <div id="form-register" class="hidden space-y-3">
                <input type="text" id="reg-name" class="input-field" placeholder="Nombre Completo">
                <input type="email" id="reg-email" class="input-field" placeholder="Correo (@mep.go.cr)">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-phone" class="input-field" placeholder="Celular" maxlength="8">
                    <input type="text" id="reg-code" class="input-field" placeholder="Cód. Inst.">
                </div>
                <input type="password" id="reg-pass" class="input-field" placeholder="Contraseña">
                <button onclick="registerUser()"
                    class="w-full bg-[#008e9b] hover:bg-[#025964] text-white font-bold py-4 rounded-2xl transition-all hover:scale-[1.02] active:scale-[0.98] mt-4 shadow-xl shadow-[#008e9b]/10">
                    Crear Cuenta
                </button>
            </div>

            <p id="status-msg" class="mt-8 text-xs text-center font-bold min-h-[1.5em] tracking-wide"></p>
        </div>
    </div>

    <div id="app-layout" class="hidden flex h-screen w-full bg-slate-50">
        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <aside id="main-sidebar" class="w-72 bg-white border-r border-slate-200 flex flex-col justify-between p-6 z-40">
            <div>
                <div class="flex items-center justify-between mb-10 px-2 lg:px-0">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-[#025964] rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-[#025964]/10">
                            <i class="ph-fill ph-leaf text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="font-black text-slate-800 text-lg leading-tight">Recurso A y S</h2>
                            <p
                                class="text-[9px] font-black text-slate-400 uppercase tracking-tighter leading-none mb-2">
                                Dimensión 1 | PNFT</p>
                        </div>
                    </div>
                    <!-- Close Button Mobile -->
                    <button onclick="toggleSidebar()"
                        class="lg:hidden w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-400 rounded-xl">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>

                <nav class="space-y-1">
                    <div onclick="router('dashboard')" id="nav-dashboard" class="nav-item active text-sm">
                        <i class="ph-bold ph-grid-four text-xl"></i> <span>Panel Central</span>
                    </div>
                    <div onclick="router('orientaciones')" id="nav-orientaciones" class="nav-item text-sm">
                        <i class="ph-bold ph-compass-rose text-xl"></i> <span>Orientaciones Didácticas 2026</span>
                    </div>
                    <div onclick="router('guia')" id="nav-guia" class="nav-item text-sm">
                        <i class="ph-bold ph-sparkle text-xl"></i> <span>Guía Docente 2026</span>
                    </div>
                    <div onclick="router('foro')" id="nav-foro" class="nav-item text-sm">
                        <i class="ph-bold ph-globe-hemisphere-west text-xl"></i> <span>Foro Nacional</span>
                    </div>
                    <div onclick="router('ia')" id="nav-ia" class="nav-item text-sm">
                        <i class="ph-bold ph-magic-wand text-xl"></i> <span>Asesor Virtual</span>
                    </div>
                    <div onclick="router('experiencia')" id="nav-experiencia" class="nav-item text-sm">
                        <i class="ph-bold ph-sketch-logo text-xl"></i> <span>La Experiencia</span>
                    </div>
                    <div onclick="router('admin')" id="nav-admin"
                        class="nav-item hidden !text-rose-500 hover:!bg-rose-50">
                        <i class="ph-bold ph-shield-star text-lg"></i> <span>Administración</span>
                    </div>
                </nav>
            </div>

            <div class="bg-slate-50 rounded-3xl p-5 border border-slate-100">
                <div class="flex items-center gap-4 mb-5">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-slate-600 font-black shadow-sm"
                        id="sidebar-avatar">U</div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebar-name" class="text-sm font-black text-slate-800 truncate">Usuario</p>
                        <p id="sidebar-email" class="text-xs text-slate-500 font-bold truncate">...</p>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="logout()"
                        class="w-full flex items-center justify-center gap-2 text-xs font-black text-rose-500 hover:bg-rose-50 py-2 rounded-xl transition-colors border border-rose-100 uppercase">
                        <i class="ph-bold ph-sign-out"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative bg-slate-50 overflow-y-auto">
            <header
                class="h-24 flex items-center justify-between px-10 border-b border-slate-200 bg-white/70 backdrop-blur-xl sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <!-- Hamburger Menu Button -->
                    <button onclick="toggleSidebar()"
                        class="lg:hidden w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl text-slate-600">
                        <i class="ph-bold ph-list text-xl"></i>
                    </button>
                    <div>
                        <h2 id="page-title"
                            class="text-xl lg:text-2xl font-black tracking-tight text-slate-800 truncate max-w-[200px] lg:max-w-none">
                            Recurso A y S</h2>
                        <p class="text-[9px] text-teal-600 font-black uppercase tracking-widest mt-1 hidden lg:block">
                            Asesoría PNFT 2026</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <span
                        class="text-[9px] font-black uppercase tracking-widest text-teal-600 bg-teal-50 px-3 py-2 rounded-xl flex items-center gap-2 border border-teal-100/50">
                        <span class="w-1.5 h-1.5 bg-teal-500 rounded-full animate-pulse"></span> <span
                            class="hidden sm:inline">Sistema Activo</span>
                    </span>
                </div>
            </header>

            <div id="content-area" class="p-10 max-w-7xl mx-auto fade-in">
            </div>
        </main>
    </div>

    <script type="module">
        // --- CONSTANTES DE DATOS CURRICULARES ---
        const SABERES_DATA = {
            'sétimo': {
                title: 'Sétimo Año: Fundamentos y Apropiación',
                modulos: [
                    { n: 'Módulo 1', s: ['Computadora', 'Gestión de archivos', 'Estructuras condicionales', 'Estructuras repetitivas', 'Operadores aritméticos', 'Operadores relacionales', 'Operadores lógicos', 'Evento', 'Hardware', 'Software', 'Redes de comunicación', 'Sistema operativo', 'Lógica de programación', 'Dato', 'Variable', 'Algoritmo', 'Herramientas de creación de contenido', 'Entorno de programación'] },
                    { n: 'Módulo 2', s: ['Herramienta de productividad', 'Referencias bibliográficas', 'Operadores lógicos', 'Procedimientos y/o funciones', 'Riesgos en línea', 'Dato', 'Asistentes virtuales', 'Internet', 'Criptomonedas', 'Software malicioso', 'Fundamentos de la IA', 'Navegador', 'Netiqueta', 'Almacenamiento en la nube', 'Contraseñas seguras', 'Buscador', 'Comunicación y colaboración'] }
                ]
            },
            'octavo': {
                title: 'Octavo Año: Comunicación e Interconexión',
                modulos: [
                    { n: 'Módulo 1', s: ['Gestión de archivos', 'Entorno de programación textual', 'Conexión entre dispositivos', 'Circuito eléctrico', 'Fundamentos de electrónica', 'Robot', 'Mecanismos', 'Herramientas de creación de contenido', 'Buscador', 'Hardware', 'Software', 'Mecánica aplicada a la robótica', 'Microcontrolador', 'Robótica', 'Entorno de programación', 'Sistema Operativo'] },
                    { n: 'Módulo 2', s: ['Software malicioso', 'Colección de datos', 'Redes de comunicación', 'Licencia', 'Hackeo', 'Fundamentos de la IA', 'Plataformas de creación de contenido', 'Sensor', 'Actuador', 'Herramientas generativas', 'Recolección de datos', 'Internet de las cosas', 'Herramienta de productividad'] }
                ]
            },
            'noveno': {
                title: 'Noveno Año: Automatización y Prototipado',
                modulos: [
                    { n: 'Módulo 1', s: ['Microcontrolador', 'Movimiento en mecanismos', 'Dato', 'Almacenamiento de datos', 'Entorno de programación textual', 'Algoritmo', 'Domótica', 'Prototipos', 'Sensor', 'Actuador'] },
                    { n: 'Módulo 2', s: ['Sistema Operativo', 'Herramientas generativas', 'Redes de comunicación', 'Derechos de autor y licenciamiento', 'Desafíos de la IA', 'Herramienta de productividad', 'Herramientas de creación de contenido', 'Huella digital', 'Riesgos en línea', 'Plataformas de creación de contenido'] }
                ]
            }
        };
        window.SABERES_DATA = SABERES_DATA;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBABrNvQH1Zu-peF3Rn1uCe-Yfb2LBGC9A",
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:ad84528e1c13d5e15988aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SISTEMA DE NAVEGACIÓN Y VISTAS ---
        window.currentUserData = null;

        /**
         * SEGURIDAD PNFT 2026: OFUSCACIÓN DE CLAVE
         * Codificamos la clave en Base64 para evitar que los bots de Google la detecten como filtrada.
         * Para máxima seguridad: RESTRINGE ESTA CLAVE POR DOMINIO (HTTP Referrer) en Google AI Studio.
         */
        const _k = "QUl6YVN5QWNUNDhvNGJlSlF5ZDN4VmFpOGYwd1FUQ3FEd3NUYjJj"; // Reemplaza esto con tu nueva clave en Base64
        window.geminiKey = atob(_k);

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        };

        window.router = async (view) => {
            // Close sidebar on navigation (mobile)
            document.getElementById('main-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById('nav-' + view);
            if (activeBtn) activeBtn.classList.add('active');

            const container = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            container.innerHTML = '<div class="flex flex-col items-center justify-center mt-32 space-y-4"><div class="w-16 h-16 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"></div><p class="text-teal-600 font-black uppercase tracking-widest text-sm animate-pulse">Sincronizando ecosistema...</p></div>';

            if (view === 'experiencia') {
                title.innerText = "La Experiencia PNFT";
                container.innerHTML = `
                    <div class="fade-in space-y-12 pb-20">
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 relative overflow-hidden shadow-sm">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">
                                <div class="reveal active">
                                    <span class="bg-[#f1f8f9] text-[#025964] border border-[#025964]/20 text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Filosofía de Mediación</span>
                                    <h3 class="text-5xl font-black mb-6 leading-tight text-white-800">La Fotografía <br><span class="text-[#025964]">Previa del Aula</span></h3>
                                    <p class="text-slate-500 font-medium leading-relaxed text-lg italic mt-2 border-l-4 border-[#025964] pl-6">
                                        "La magia de una gran lección tecnológica comienza mucho antes del primer clic. Es la visión y la conexión lo que transforma un tema en un recuerdo eterno."
                                    </p>
                                </div>
                                <div class="relative h-[300px] rounded-[2.5rem] overflow-hidden shadow-2xl reveal active">
                                    <img src="https://images.unsplash.com/photo-1554048612-387768052bf7?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>

                        <section class="space-y-10">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                <h3 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Tu Ruta de Innovación</h3>
                                <div class="flex gap-4 p-2 bg-slate-100 rounded-2xl">
                                    <button onclick="switchExphase('antes')" id="exbtn-antes" class="experience-tab-btn active px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest">01. Preparación</button>
                                    <button onclick="switchExphase('durante')" id="exbtn-durante" class="experience-tab-btn px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest text-slate-400">02. Ejecución</button>
                                    <button onclick="switchExphase('despues')" id="exbtn-despues" class="experience-tab-btn px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest text-slate-400">03. Impacto</button>
                                </div>
                            </div>

                            <div id="experience-phase-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- Phase content will be injected here -->
                            </div>
                        </section>
                    </div>
                `;
                setTimeout(() => window.switchExphase('antes'), 50);
                return;
            }

            // --- VISTA: DASHBOARD ---
            if (view === 'dashboard') {
                title.innerText = "Panel Central del Ecosistema";
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 fade-in">
                        <div class="md:col-span-2 glass p-10 rounded-[2.5rem] relative overflow-hidden bg-white border-slate-100 shadow-sm">
                            <div class="relative z-10">
                                <span class="bg-[#025964] text-white text-xs font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-4 inline-block shadow-lg shadow-[#025964]/10">Portal Activo 2026</span>
                                 <h3 class="text-4xl font-black mb-3 text-slate-800">¡Hola, ${(window.currentUserData?.nombre || 'Docente').split(' ')[0]}! ✨</h3>
                                <p class="text-slate-500 leading-relaxed max-w-lg font-medium">Estamos aquí para apoyarte en el ciclo 2026. Tu Asesor IA y las orientaciones están listas para optimizar tu trabajo docente.</p>
                                <div class="flex gap-4 mt-8">
                                    <button onclick="router('ia')" class="bg-[#025964] hover:bg-[#008e9b] text-white font-bold py-3 px-8 rounded-2xl transition-all shadow-xl shadow-[#025964]/10 flex items-center gap-2 hover:scale-[1.02]">
                                        <i class="ph-fill ph-sparkle text-xl"></i> Consultar IA
                                    </button>
                                    <button onclick="router('orientaciones')" class="bg-white border-2 border-slate-100 hover:border-[#025964]/30 text-slate-600 font-bold py-3 px-8 rounded-2xl transition-all flex items-center gap-2">
                                        Ver Documentación
                                    </button>
                                </div>
                            </div>
                            <i class="ph-fill ph-plant text-[15rem] absolute -right-10 -bottom-10 text-[#025964]/5 rotate-12"></i>
                        </div>
                        <div class="space-y-6">
                            <div class="glass p-8 rounded-[2rem] flex flex-col items-center justify-center text-center hover:scale-[1.02] transition-transform cursor-pointer group" onclick="router('orientaciones')">
                                <div class="w-20 h-20 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] mb-6 group-hover:bg-[#025964] group-hover:text-white transition-all shadow-sm"><i class="ph-duotone ph-newspaper text-4xl"></i></div>
                                <h4 class="font-black text-slate-800 text-xl">Orientaciones Didácticas</h4>
                                <p class="text-sm text-slate-400 font-bold uppercase tracking-tight mt-1">Normativa Vigente 2026</p>
                            </div>
                            <div class="glass p-8 rounded-[2rem] flex flex-col items-center justify-center text-center hover:scale-[1.02] transition-transform cursor-pointer group" onclick="router('guia')">
                                <div class="w-20 h-20 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#008e9b] mb-6 group-hover:bg-[#008e9b] group-hover:text-white transition-all shadow-sm"><i class="ph-duotone ph-book-open-text text-4xl"></i></div>
                                <h4 class="font-black text-slate-800 text-xl">Guía Docente 2026</h4>
                                <p class="text-sm text-slate-400 font-bold uppercase tracking-tight mt-1">Saberes y Mediación</p>
                            </div>
                        </div>
                    </div>
                `;

                // --- VISTA: ORIENTACIONES ---
            } else if (view === 'orientaciones') {
                title.innerText = "Orientaciones Didácticas 2026";
                container.innerHTML = `
                    <div class="fade-in space-y-12 pb-20">
                        <!-- Hero & Audio -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 relative overflow-hidden shadow-sm">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">
                                <div>
                                    <span class="bg-[#f1f8f9] text-[#025964] border border-[#025964]/20 text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Dimensión 1 PNFT</span>
                                    <h3 class="text-4xl font-black mb-6 leading-tight text-slate-800">Orientaciones <br><span class="text-[#025964]">Didácticas 2026</span></h3>
                                    <div class="flex flex-col gap-4">
                                        <p class="text-slate-500 font-medium leading-relaxed text-lg italic border-l-4 border-[#025964] pl-6">
                                            "Transformamos el aula en un laboratorio de creación tecnológica constante."
                                        </p>
                                        <a href="https://adminmepcr-my.sharepoint.com/:b:/g/personal/alberto_bustos_ortega_mep_go_cr/IQB2V-ZCEVyHRaw6p6kqi6TsAQk0T_YWsaIDCu6NhH4628c?e=peFKdh" target="_blank" class="inline-flex items-center gap-2 text-[10px] font-black text-[#025964] uppercase tracking-widest bg-white border border-[#025964]/20 px-6 py-3 rounded-2xl hover:bg-[#025964] hover:text-white transition-all w-fit shadow-sm">
                                            <i class="ph-bold ph-download-simple"></i> Descargar Documento Oficial
                                        </a>
                                    </div>
                                </div>
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm relative overflow-hidden">
                                    <h4 class="text-xs font-black text-[#025964] uppercase tracking-widest mb-4 italic">Mis Apuntes de mediación</h4>
                                    <textarea id="orient-notes" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-5 text-base text-slate-600 font-medium placeholder:text-slate-300 outline-none focus:bg-white focus:border-[#025964] transition-all resize-none" rows="3" placeholder="Anota aquí tus reflexiones..."></textarea>
                                    <div class="flex justify-between items-center mt-6">
                                        <p class="text-xs text-slate-400 font-bold uppercase italic tracking-tighter">Guardado Automático</p>
                                        <button onclick="window.saveOrientNotes()" class="bg-[#025964] text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.01] transition-all">Guardar Notas</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Tabs -->
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 glass p-2 rounded-[2.5rem] bg-[#f1f8f9] border border-slate-100 flex flex-wrap gap-2">
                                <button onclick="switchOrientTab('admin')" id="tab-btn-admin" class="orient-tab-btn flex-1 min-w-[150px] px-8 py-5 rounded-[2rem] font-black text-xs uppercase tracking-widest transition-all bg-[#025964] text-white shadow-lg shadow-[#025964]/10">Capa Administrativa</button>
                                <button onclick="switchOrientTab('peda')" id="tab-btn-peda" class="orient-tab-btn flex-1 min-w-[150px] px-8 py-5 rounded-[2rem] font-black text-xs uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Enfoque Pedagógico</button>
                                <button onclick="switchOrientTab('plan')" id="tab-btn-plan" class="orient-tab-btn flex-1 min-w-[150px] px-8 py-5 rounded-[2rem] font-black text-xs uppercase tracking-widest transition-all text-slate-500 hover:text-[#025964]">Planeamiento PIA</button>
                            </div>
                        </div>

                        <!-- Dynamic Content Area -->
                        <div id="orient-main-content" class="min-h-[500px]">
                            <!-- Content injected here via switchOrientTab -->
                        </div>
                    </div>
                `;

                // Cargar notas guardadas
                setTimeout(() => {
                    const saved = localStorage.getItem('pnft_orient_notes');
                    if (saved) document.getElementById('orient-notes').value = saved;
                    window.switchOrientTab('admin');
                }, 100);

                // --- VISTA: GUÍA DOCENTE + IA #1 ---
            } else if (view === 'guia') {
                title.innerText = "Guía Docente 2026";
                container.innerHTML = `
                    <div class="fade-in space-y-12 pb-20">
                        <!-- Hero Section -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 text-slate-800 relative overflow-hidden shadow-sm">
                            <div class="relative z-10 max-w-3xl">
                                <span class="bg-[#f1f8f9] border border-[#008e9b]/20 text-[#025964] text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-6 inline-block">Planificación Estratégica Secundaria</span>
                                <h3 class="text-5xl font-black mb-6 leading-tight">Guía Docente de <br><span class="text-[#025964]">Formación Tecnológica</span></h3>
                                <p class="text-slate-500 font-medium leading-relaxed text-lg italic mt-2">
                                    "Basada estrictamente en la Guía docente para la Formación Tecnológica Secundaria-III ciclo (2026)."
                                </p>
                            </div>
                            <div class="absolute top-[-10%] right-[-5%] opacity-10 rotate-12 text-[#025964]"><i class="ph-fill ph-target text-[20rem]"></i></div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- Left: IA Generator Sidebar -->
                            <div class="lg:col-span-1 space-y-8">
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-xl sticky top-24">
                                    <h4 class="text-xl font-black text-slate-800 mb-2 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-[#f1f8f9] rounded-xl flex items-center justify-center text-[#025964]"><i class="ph-fill ph-sparkle"></i></div>
                                        Creador de Situaciones Problema
                                    </h4>
                                    
                                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-2xl">
                                        <div class="flex gap-3">
                                            <i class="ph-fill ph-info text-amber-600 text-lg"></i>
                                            <p class="text-[10px] text-amber-800 font-bold leading-relaxed">
                                                <b>NOTA PEDAGÓGICA:</b> Este recurso genera <u>ejemplos orientadores</u>. El proceso de <b>Design Thinking</b> debe ser vivido por el estudiante; use estos puntos como guía para su mediación, no como material final de entrega.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <div class="group">
                                            <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Contexto de la situación</label>
                                            <textarea id="ia-tema" rows="4" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-5 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all shadow-inner" placeholder="Pocos laboratorios, baja conectividad, estudiantes de zona rural..."></textarea>
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Nivel Seleccionado</label>
                                            <select id="ia-nivel" onchange="updateIASelectors()" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all appearance-none cursor-pointer">
                                                <option value="sétimo">Sétimo Año</option>
                                                <option value="octavo">Octavo Año</option>
                                                <option value="noveno">Noveno Año</option>
                                            </select>
                                        </div>

                                        <div id="ia-dynamic-selectors" class="space-y-6">
                                            <!-- Injected via updateIASelectors -->
                                        </div>

                                        <button onclick="window.generarSituacion()" class="w-full bg-[#025964] hover:bg-[#008e9b] text-white rounded-3xl py-5 font-black text-sm transition-all shadow-lg shadow-[#025964]/10 flex items-center justify-center gap-3 group uppercase tracking-widest">
                                            Generar Retos de Aprendizaje <i class="ph-bold ph-magic-wand text-xl transition-transform group-hover:scale-105"></i>
                                        </button>
                                    </div>

                                    <div id="ia-result-container" class="mt-8 hidden">
                                        <div id="ia-result" class="bg-[#f1f8f9] p-6 rounded-3xl border border-[#025964]/10 text-sm text-slate-700 leading-relaxed max-h-[400px] overflow-y-auto">
                                            <!-- Result here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Guide Content -->
                            <div class="lg:col-span-2 space-y-12">
                                
                                <!-- Ejes del Ecosistema -->
                                <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 shadow-sm">
                                    <div class="flex items-center gap-4 mb-8">
                                        <div class="w-12 h-12 bg-teal-50 rounded-2xl flex items-center justify-center text-teal-600"><i class="ph-fill ph-circles-four"></i></div>
                                        <h4 class="text-2xl font-black text-slate-800">Ejes del Ecosistema PNFT</h4>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Apropiación Digital</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Infraestructura, hardware, red, software esencial y ciudadanía digital.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Programación & Lógica</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Pensamiento computacional, algoritmos y lenguajes de programación.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Computación Física</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Robótica, sensores, actuadores, domótica y prototipado IoT.</p>
                                        </div>
                                        <div class="p-8 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all">
                                            <h5 class="font-black text-[#025964] text-lg mb-3">Ciencia de Datos & IA</h5>
                                            <p class="text-sm text-slate-600 leading-relaxed italic">Gestión de datos, seguridad, ética de la IA y herramientas generativas.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Propósito & Estructura -->
                                <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100">
                                    <div class="flex items-center gap-4 mb-8">
                                        <div class="w-12 h-12 bg-teal-50 rounded-2xl flex items-center justify-center text-teal-600"><i class="ph-fill ph-stack"></i></div>
                                        <h4 class="text-2xl font-black text-slate-800">Directrices Metodológicas</h4>
                                    </div>
                                    <div class="mb-8">
                                        <p class="text-base text-slate-600 leading-relaxed">
                                            El PNFT promueve el desarrollo de competencias tecnológicas mediante la resolución de problemas contextualizados, centrando la mediación pedagógica en la creación y el pensamiento crítico.
                                        </p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="p-8 rounded-[2rem] bg-slate-50 border border-slate-100">
                                            <h5 class="font-black text-slate-800 text-base mb-4">Componentes del Modelo</h5>
                                            <ul class="space-y-3 text-sm text-slate-500 font-medium">
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Competencias por Áreas de Conocimiento</li>
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Resultados de Aprendizaje (RdA)</li>
                                                <li class="flex items-center gap-3"><i class="ph-bold ph-check text-teal-600"></i> Perfiles de Salida Institucionales</li>
                                            </ul>
                                        </div>
                                        <div class="p-8 rounded-[2rem] bg-[#025964] text-white shadow-xl shadow-[#025964]/10">
                                            <h5 class="font-black text-base mb-4 flex items-center gap-2"><i class="ph-fill ph-lightbulb"></i> Estrategia Central</h5>
                                            <p class="text-2xl font-black tracking-tighter mb-4">Design Thinking</p>
                                            <p class="text-xs text-white/70 uppercase font-black tracking-widest leading-none">Fases: Empatía - Definición - Ideación - Prototipado - Testeo</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Levels Tabs -->
                                <div class="space-y-6">
                                    <div class="flex gap-4 p-2 bg-[#f1f8f9] rounded-[2rem] overflow-x-auto no-scrollbar border border-[#025964]/5">
                                        <button onclick="switchLevelTab('sétimo')" id="level-btn-sétimo" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all bg-[#025964] text-white shadow-lg shadow-[#025964]/10">7mo Año</button>
                                        <button onclick="switchLevelTab('octavo')" id="level-btn-octavo" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all text-slate-400 hover:text-[#025964]">8vo Año</button>
                                        <button onclick="switchLevelTab('noveno')" id="level-btn-noveno" class="level-tab-btn flex-1 min-w-[120px] px-6 py-4 rounded-[1.5rem] font-black text-xs uppercase tracking-widest transition-all text-slate-400 hover:text-[#025964]">9no Año</button>
                                    </div>

                                    <div id="level-content-area" class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10">
                                        <!-- Level content injected via switchLevelTab('sétimo') -->
                                    </div>
                                </div>

                                <!-- Evaluation & Planning Details -->
                                <div class="space-y-8">
                                    <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                                        <h5 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-3"><i class="ph-fill ph-scales text-[#025964]"></i> Lineamientos de Evaluación</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600 leading-relaxed">
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Marco Normativo:</b> Se rige estrictamente por el Reglamento de Evaluación de los Aprendizajes vigente.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Responsabilidad:</b> El docente diseña estrategias contextualizadas e integradoras.</div></li>
                                            </ul>
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Gestión del Tiempo:</b> Se debe valorar el tiempo efectivo por periodo para la medición justa.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Reflexión Ética:</b> Integrar espacios sobre el sentido ético y responsable de la IA y tecnología.</div></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10 shadow-sm relative overflow-hidden">
                                        <h5 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-3"><i class="ph-fill ph-notepad text-[#025964]"></i> Directrices de Planeamiento</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600 leading-relaxed mb-8">
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Base Curricular:</b> Referencia obligatoria al macro y micro currículo del PNFT.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Contextualización:</b> Adaptación a necesidades y entorno de los estudiantes.</div></li>
                                            </ul>
                                            <ul class="space-y-4">
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Ejes Transversales:</b> Pensamiento Computacional, Ciudadanía Digital y Emprendimiento.</div></li>
                                                <li class="flex gap-3"><i class="ph-bold ph-check-square text-[#025964] mt-1"></i> <div><b>Libertad y Autonomía:</b> El docente lidera el diseño de su mediación pedagógica.</div></li>
                                            </ul>
                                        </div>
                                        <div class="p-6 bg-[#f1f8f9] rounded-2xl border-2 border-dashed border-[#025964]/20 flex flex-col md:flex-row items-center justify-between gap-6">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-[#025964] shadow-sm"><i class="ph-bold ph-layout text-2xl"></i></div>
                                                <div>
                                                    <p class="text-[10px] font-black text-[#025964] uppercase tracking-widest">Plantilla PIA Online</p>
                                                    <p class="text-xs text-slate-500 font-medium">Accede al planeamiento en línea 2026</p>
                                                </div>
                                            </div>
                                            <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="bg-[#025964] text-white px-8 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.02] transition-all">Abrir Plantilla</a>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                `;
                // Inicializar con Sétimo y activar selectores IA
                setTimeout(() => {
                    window.switchLevelTab('sétimo');
                    window.updateIASelectors();
                }, 50);


            } else if (view === 'foro') {
                title.innerText = "Comunidad PNFT";
                let postsHtml = '';
                try {
                    const q = window.query(window.collection(db, "foro_posts"), window.orderBy("fecha", "desc"), window.limit(8));
                    const querySnapshot = await window.getDocs(q);
                    querySnapshot.forEach((doc) => {
                        const p = doc.data();
                        const date = p.fecha?.toDate().toLocaleDateString() || 'Hoy';
                        postsHtml += `
                            <div class="glass p-8 rounded-3xl mb-6 bg-white border-l-8 border-[#025964] shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-[#f1f8f9] rounded-full flex items-center justify-center text-[#025964] font-black">${p.autor.charAt(0)}</div>
                                        <span class="font-black text-slate-800 text-sm">${p.autor}</span>
                                    </div>
                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 px-3 py-1 rounded-full">${date}</span>
                                </div>
                                <p class="text-slate-600 font-medium leading-relaxed">${p.mensaje}</p>
                            </div>`;
                    });
                } catch (e) { postsHtml = '<p class="text-slate-400 text-center font-bold">Inicia una conversación compartiendo algo arriba.</p>'; }

                container.innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto">
                        <div class="glass p-8 rounded-[2.5rem] mb-12 bg-white relative shadow-xl border border-slate-100 overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-5 text-[#025964]"><i class="ph ph-chat-circle-dots text-8xl"></i></div>
                            <textarea id="foro-msg" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-6 text-slate-800 text-lg focus:border-[#025964] focus:bg-white outline-none resize-none transition-all placeholder:text-slate-300 font-medium" rows="3" placeholder="¿Qué éxito has tenido hoy en clase? Comparte..."></textarea>
                            <div class="flex justify-between items-center mt-6">
                                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest pl-2 italic">Foro de experiencias docentes</p>
                                <button onclick="publicarForo()" class="bg-[#025964] hover:bg-[#008e9b] text-white px-10 py-3 rounded-2xl font-black text-sm transition-all shadow-lg shadow-[#025964]/10 flex items-center gap-3">
                                    Publicar Experiencia <i class="ph ph-paper-plane-tilt"></i>
                                </button>
                            </div>
                        </div>
                        <div id="foro-feed">${postsHtml}</div>
                    </div>
                `;

                // --- VISTA: ASESOR IA (IA #2) ---
            } else if (view === 'ia') {
                title.innerText = "Asistente Estratégico";
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 h-[calc(100vh-220px)] fade-in">
                        <div class="lg:col-span-3 glass rounded-[2.5rem] flex flex-col overflow-hidden bg-white">
                            <header class="px-8 py-5 border-b border-slate-100 flex items-center gap-4 bg-[#f1f8f9]">
                                <div class="w-10 h-10 bg-[#025964] rounded-xl flex items-center justify-center text-white shadow-lg shadow-[#025964]/10">
                                    <i class="ph-fill ph-robot text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-black text-slate-800 leading-none">Asesoría de Informática Digital</h4>
                                    <p class="text-[10px] text-[#025964] font-black uppercase tracking-widest mt-1.5 flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#008e9b] animate-pulse"></span> Sistema Activo
                                    </p>
                                </div>
                            </header>
                            <div id="chat-history" class="flex-1 p-8 overflow-y-auto space-y-6">
                                <div class="flex gap-4">
                                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle"></i></div>
                                    <div class="bg-slate-50 p-6 rounded-3xl rounded-tl-none max-w-[85%] text-sm font-medium text-slate-600 leading-relaxed shadow-sm">
                                        Me alegra saludarte. Soy tu asistente virtual impulsado por la visión 2026. Puedo resolver dudas normativas, metodológicas o simplemente escucharte. <br><br> ¿En qué podemos avanzar hoy?
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 bg-white border-t border-slate-100">
                                <div class="flex gap-4 bg-slate-50 p-2 rounded-[2rem] shadow-inner border border-slate-100 focus-within:bg-white focus-within:border-[#025964] transition-all">
                                    <input type="text" id="chat-input" class="flex-1 bg-transparent px-6 py-4 text-sm font-medium outline-none text-slate-800" placeholder="Escribe tu consulta pedagógica aquí...">
                                    <button onclick="enviarChatIA()" class="w-14 h-14 bg-[#025964] hover:bg-[#008e9b] rounded-3xl flex items-center justify-center text-white shadow-xl shadow-[#025964]/10 transition-all active:scale-90 flex-shrink-0">
                                        <i class="ph-bold ph-paper-plane-right text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="glass p-8 rounded-[2.5rem] hidden lg:block bg-gradient-to-b from-white to-teal-50/50">
                            <h4 class="font-black text-teal-600 text-[10px] uppercase tracking-widest mb-6 px-1">Consultas Frecuentes</h4>
                            <ul class="space-y-4">
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('¿Cómo evalúo competencias?')">
                                    <i class="ph ph-circles-three-plus text-lg"></i> Redacción de Competencias
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Estrategias de mediación tecnológica')">
                                    <i class="ph ph-cpu text-lg"></i> Mediación Tecnológica
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Reglamento de licencias actual')">
                                    <i class="ph ph-scales text-lg"></i> Base Normativa
                                </li>
                                <li class="text-xs font-bold text-slate-500 hover:text-teal-600 bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all cursor-pointer flex items-center gap-3" onclick="setInputChat('Ideas para un recreo creativo')">
                                    <i class="ph ph-popcorn text-lg"></i> Inspiración Diaria
                                </li>
                            </ul>
                        </div>
                    </div>
                `;

                // --- VISTA: ADMIN PANEL ---
            } else if (view === 'admin') {
                title.innerText = "Centro de Gestión PNFT";
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
                        <!-- Left: Stats and Charts -->
                        <div class="lg:col-span-1 space-y-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                                <h4 class="text-[10px] font-black text-[#025964] uppercase tracking-widest mb-6 px-1">Estado del Ecosistema</h4>
                                <canvas id="adminChart" class="w-full"></canvas>
                                <div class="mt-8 grid grid-cols-2 gap-4">
                                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <p class="text-2xl font-black text-slate-800">48</p>
                                        <p class="text-[10px] font-black uppercase text-slate-400">Inst. Activas</p>
                                    </div>
                                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <p class="text-2xl font-black text-slate-800">124</p>
                                        <p class="text-[10px] font-black uppercase text-slate-400">Docentes</p>
                                    </div>
                                </div>
                            </div>

                            <!-- IA Alert Generator -->
                            <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden shadow-xl shadow-[#025964]/10">
                                <i class="ph-fill ph-shield-check absolute -right-10 -bottom-10 text-white/5 text-[15rem]"></i>
                                <div class="relative z-10">
                                    <h4 class="text-lg font-black mb-4 flex items-center gap-2 uppercase tracking-tighter"><i class="ph-bold ph-magic-wand text-teal-400"></i> Alerta PNFT Inteligente</h4>
                                    <p class="text-[11px] text-teal-100/70 mb-6 leading-relaxed">Convierte tus apuntes de visita en un reporte técnico oficial para el sistema nacional mediante IA.</p>
                                    <textarea id="admin-ia-input" class="w-full bg-white/10 border border-white/10 rounded-2xl p-4 text-xs text-white placeholder:text-teal-200/30 outline-none focus:bg-white/20 transition-all mb-4" rows="3" placeholder="Ej: La red falla en el laboratorio 2 de la Escuela España..."></textarea>
                                    <button onclick="generarAlertaAdminIA()" class="w-full bg-white text-[#025964] py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all">Generar Reporte IA</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Institution Management -->
                        <div class="lg:col-span-2 space-y-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 relative overflow-hidden">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                                    <div>
                                        <h3 class="text-2xl font-black text-slate-800 mb-1 uppercase tracking-tighter">Gestión de Instituciones</h3>
                                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Seguimiento y Categorización 2026</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="document.getElementById('excel-upload').click()" class="bg-slate-50 border border-slate-100 text-slate-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 transition-all">
                                            <i class="ph-bold ph-upload"></i> Importar
                                        </button>
                                        <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden" onchange="procesarExcel(this)">
                                    </div>
                                </div>

                                <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2 no-scrollbar">
                                    <!-- Institution Cards -->
                                    <div class="p-6 bg-[#f1f8f9] rounded-3xl border border-[#025964]/5 hover:border-[#025964]/20 transition-all group">
                                        <div class="flex justify-between items-start mb-6">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-[#025964] shadow-sm font-black text-xs border border-slate-100">0001</div>
                                                <div>
                                                    <h5 class="font-black text-slate-800 uppercase text-sm">Colegio Técnico Profesional de Calle Blancos</h5>
                                                    <div class="flex gap-2 mt-1">
                                                        <span class="text-[9px] font-black text-rose-500 bg-rose-50 px-2 py-0.5 rounded-full border border-rose-100 uppercase tracking-widest">Atención Urgente</span>
                                                        <span class="text-[9px] font-black text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">ID: 2103</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-400 hover:text-rose-500 transition-colors shadow-sm"><i class="ph-bold ph-bell-ringing"></i></button>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                            <div class="space-y-3">
                                                <p class="text-[10px] font-black text-teal-600 uppercase tracking-widest">Docentes a cargo (4)</p>
                                                <div class="flex -space-x-3">
                                                    <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-[10px] font-black text-slate-600 shadow-sm" title="Ana García">AG</div>
                                                    <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-[10px] font-black text-slate-600 shadow-sm" title="Luis Mora">LM</div>
                                                    <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-[10px] font-black text-slate-600 shadow-sm" title="Carlos Pérez">CP</div>
                                                    <div class="w-10 h-10 rounded-full bg-[#025964] border-2 border-white flex items-center justify-center text-[10px] font-black text-white shadow-sm" title="Elena Torres">ET</div>
                                                </div>
                                            </div>
                                            <div class="bg-white/50 p-4 rounded-2xl border border-slate-100">
                                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Última Tarea Automática</p>
                                                <p class="text-[11px] text-slate-600 font-bold flex items-center gap-2"><i class="ph-fill ph-calendar text-rose-400"></i> Visita técnica programada p. lunes</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- More Cards (Simulated) -->
                                    <div class="p-6 bg-white rounded-3xl border border-slate-100 hover:border-[#025964]/20 transition-all group">
                                        <div class="flex justify-between items-start">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] shadow-sm font-black text-xs border border-slate-100">0432</div>
                                                <div>
                                                    <h5 class="font-black text-slate-800 uppercase text-sm">Escuela España</h5>
                                                    <div class="flex gap-2 mt-1">
                                                        <span class="text-[9px] font-black text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full border border-teal-100 uppercase tracking-widest">Continuidad</span>
                                                        <span class="text-[9px] font-black text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">ID: 0045</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 transition-colors shadow-sm"><i class="ph-bold ph-dots-three-outline"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="p-6 bg-white rounded-3xl border border-slate-100 hover:border-[#025964]/20 transition-all group">
                                        <div class="flex justify-between items-start">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] shadow-sm font-black text-xs border border-slate-100">1289</div>
                                                <div>
                                                    <h5 class="font-black text-slate-800 uppercase text-sm">Liceo de Coronado</h5>
                                                    <div class="flex gap-2 mt-1">
                                                        <span class="text-[9px] font-black text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100 uppercase tracking-widest">Prioritario</span>
                                                        <span class="text-[9px] font-black text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100 uppercase tracking-widest">ID: 1022</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 transition-colors shadow-sm"><i class="ph-bold ph-dots-three-outline"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Initialize Charts
                setTimeout(initAdminCharts, 100);
            }
        };

        const initAdminCharts = () => {
            const ctx = document.getElementById('adminChart')?.getContext('2d');
            if (!ctx) return;
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Continuidad', 'Prioritario', 'Urgente'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: ['#008e9b', '#f59e0b', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    family: 'Lato',
                                    size: 10,
                                    weight: '900'
                                },
                                usePointStyle: true,
                            }
                        }
                    }
                }
            });
        };

        window.generarAlertaAdminIA = async () => {
            const input = document.getElementById('admin-ia-input');
            const txt = input.value.trim();
            if (!txt) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Procesando Reporte...";
            btn.disabled = true;

            const prompt = `Como asistente administrativo del PNFT, toma los siguientes apuntes de visita y genera un REPORTE TÉCNICO FORMAL para el sistema oficial. 
            Apuntes: "${txt}"
            Formato: 1. Resumen Situación, 2. Acción Sugerida, 3. Clasificación (Urgente/Prioritario/Continuidad).`;

            const respuesta = await llamarGemini(prompt, 'general');

            // Format for display
            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            const container = input.parentElement;
            const oldRes = document.getElementById('admin-ia-result');
            if (oldRes) oldRes.remove();

            const resDiv = document.createElement('div');
            resDiv.id = 'admin-ia-result';
            resDiv.className = 'mt-6 p-4 bg-white/10 rounded-2xl text-[10px] text-teal-50 border border-white/10 fade-in leading-relaxed';
            resDiv.innerHTML = `<h5 class="font-black uppercase mb-2 border-b border-white/10 pb-2">Borrador de Reporte:</h5>${htmlRes}`;
            container.appendChild(resDiv);

            btn.innerText = originalText;
            btn.disabled = false;
        };

        window.switchLevelTab = (level) => {
            const area = document.getElementById('level-content-area');
            const btns = document.querySelectorAll('.level-tab-btn');
            btns.forEach(b => b.classList.remove('bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10'));
            btns.forEach(b => b.classList.add('text-slate-400'));
            const activeBtn = document.getElementById(`level-btn-${level}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10');
                activeBtn.classList.remove('text-slate-400');
            }
            const info = window.SABERES_DATA[level];
            let html = `<h4 class="text-2xl font-black text-slate-800 mb-8 flex items-center gap-3">${info.title}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">`;

            info.modulos.forEach(mod => {
                html += `
                    <div class="space-y-6">
                        <div class="flex items-center gap-4 mb-4">
                            <span class="w-10 h-10 bg-[#f1f8f9] rounded-xl flex items-center justify-center text-[#025964] font-black text-sm border border-[#025964]/10">${mod.n.charAt(mod.n.length - 1)}</span>
                            <h5 class="text-xl font-black text-slate-700 uppercase tracking-tighter">${mod.n}</h5>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${mod.s.map(saber => `
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 group hover:border-[#025964]/20 transition-all">
                                    <div class="w-2 h-2 rounded-full bg-[#025964]/20 group-hover:bg-[#025964] transition-colors"></div>
                                    <span class="text-sm font-bold text-slate-600">${saber}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            area.innerHTML = html;
        };

        window.switchOrientTab = (tab) => {
            const content = document.getElementById('orient-main-content');
            const btns = document.querySelectorAll('.orient-tab-btn');
            btns.forEach(b => b.classList.remove('active', 'bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10'));
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            if (activeBtn) activeBtn.classList.add('active', 'bg-[#025964]', 'text-white', 'shadow-lg', 'shadow-[#025964]/10');

            const templates = {
                admin: `
                    <div class="space-y-10 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm mb-8">
                             <p class="text-slate-500 font-medium leading-loose mb-6">
                                A continuación, presento los detalles del contenido administrativo de las <b>"Orientaciones generales para docentes 2026"</b>, enfocados exclusivamente en el nivel de <b>Secundaria</b> (III Ciclo y Educación Diversificada/Vocacional). Se recomienda la lectura completa del documento para profundizar en los aspectos mencionados, con la finalidad de complementar la comprensión total del importante aporte pedagógico a brindar a los estudiantes en el presente curso lectivo 2026.
                             </p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-8">
                                <!-- 1. Niveles de Implementación -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964] transition-transform group-hover:rotate-6"><i class="ph-bold ph-users-three text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">1. Niveles e Implementación</h4>
                                    </div>
                                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed">
                                        <p><b>III Ciclo (Académico):</b> Obligatorio en 7°, 8° y 9°.</p>
                                        <p><b>Diversificada (IV Ciclo):</b> <span class="text-rose-500 font-bold uppercase">No se implementa</span> el currículo de Formación Tecnológica en este ciclo para 2026.</p>
                                        <p><b>CTP (Vocacional):</b> <span class="text-[#025964] font-black uppercase">Sí se implementa</span> en la oferta de III Ciclo y Ciclo Diversificado Vocacional (Plan Nacional).</p>
                                        <p><b>Población Vocacional:</b> Tiene <span class="bg-amber-50 px-2 py-0.5 rounded text-amber-700 font-bold">prioridad de atención</span> al elaborar el horario institucional.</p>
                                        <p><b>EPJA:</b> Implementado en CAN, IPEC, CINDEA y CONED según disponibilidad.</p>
                                    </div>
                                </div>

                                <!-- 2. Carga Horaria -->
                                <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden group">
                                    <i class="ph-fill ph-clock absolute -right-6 -bottom-6 text-white/5 text-[10rem]"></i>
                                    <div class="relative z-10">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center text-white"><i class="ph-bold ph-timer text-3xl"></i></div>
                                            <h4 class="text-xl font-black uppercase tracking-tighter">2. Carga Horaria (Secundaria)</h4>
                                        </div>
                                        <ul class="space-y-4 text-sm text-teal-50 leading-relaxed font-medium">
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-info text-teal-400"></i> Asignación según <b>matrícula</b> (no cuota fija).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin Codocencia (Docente único responsable).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin Gestión Técnico-Pedagógica (GTP).</li>
                                            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-rose-300"></i> Sin CHIM (Carga Horaria Inferior Mínima).</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                <!-- 3. Gestión de Recurso -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964]"><i class="ph-bold ph-desktop text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">3. Gestión del Recurso</h4>
                                    </div>
                                    <div class="space-y-4 text-xs text-slate-500 font-medium leading-relaxed">
                                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                            <p class="text-[#025964] font-black uppercase mb-1 underline">Prioridad Absoluta</p>
                                            <p>Lecciones de FT tienen prioridad sobre reuniones o capacitaciones externas.</p>
                                        </div>
                                        <p><b>Carpeta Institucional:</b> Planeamientos, registros, inventarios, reportes de mantenimiento y incidentes.</p>
                                        <p><b>TecnoPresta:</b> Actualización obligatoria de inventario (2 revisiones anuales).</p>
                                        <p><b>Bitácora de Control:</b> Registro obligatorio de uso y traslado de equipos.</p>
                                    </div>
                                </div>

                                <!-- 4. Administración Evaluación -->
                                <div class="glass p-8 rounded-[2.5rem] bg-white border border-[#025964]/10 group">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-14 h-14 bg-[#f1f8f9] rounded-2xl flex items-center justify-center text-[#025964]"><i class="ph-bold ph-notebook text-3xl"></i></div>
                                        <h4 class="text-xl font-black text-slate-800 uppercase tracking-tighter">4. Administración de Evaluación</h4>
                                    </div>
                                    <div class="space-y-4 text-xs text-slate-600 font-bold leading-relaxed">
                                        <p>Componente Principal: <b>PROYECTO.</b></p>
                                        <p>Desarrollo estricto en las <b>2 lecciones semanales.</b></p>
                                        <p>Instrumentos aprobados por el Comité de Evaluación Institucional.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Funciones Generales -->
                        <div class="glass p-10 rounded-[3rem] bg-slate-50 border border-slate-200 mt-10">
                            <h4 class="text-xl font-black text-slate-800 mb-6 uppercase flex items-center gap-3"><i class="ph-bold ph-briefcase text-[#025964]"></i> 5. Funciones Administrativas Generales</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Atención Correo Oficial MEP</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Registro Sistema SEA / SEA</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Bitácora Mensual Vigente</div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Revisión Repositorio PNFT</div>
                            </div>
                        </div>
                    </div>
                `,
                peda: `
                    <div class="space-y-12 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm">
                            <p class="text-slate-500 font-medium leading-loose">
                                Claro, basándome en el documento <b>"Orientaciones generales para docentes 2026"</b>, he extraído los aspectos estrictamente pedagógicos para la implementación del Programa Nacional de Formación Tecnológica (PNFT) en el nivel de <b>Secundaria</b> (III Ciclo y Educación Diversificada Vocacional).
                            </p>
                        </div>

                        <!-- 1. Enfoque Metodológico -->
                        <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm">
                            <h4 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-4 uppercase tracking-tighter">1. Enfoque Metodológico: Design Thinking</h4>
                            <div class="space-y-6 text-slate-600 leading-relaxed">
                                <p>Para secundaria, la pedagogía se centra en metodologías activas donde el estudiante es el protagonista.</p>
                                <ul class="space-y-4">
                                    <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Metodología Base:</b> Se recomienda explícitamente el uso de <b>Design Thinking</b> (Pensamiento de Diseño) para el desarrollo de las clases y proyectos.</div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-caret-right text-[#025964] mt-1"></i> <div><b>Flexibilidad Condicionada:</b> Si el docente decide utilizar otra metodología activa distinta, es obligatorio que asegure la incorporación del <b>Componente Proyecto</b> y su respectiva evaluación sumativa.</div></li>
                                </ul>
                            </div>
                        </div>

                        <!-- 2. La Evaluación -->
                        <div class="glass p-10 rounded-[2.5rem] bg-[#f1f8f9] border border-[#025964]/10">
                            <h4 class="text-2xl font-black text-[#025964] mb-8 flex items-center gap-4 uppercase tracking-tighter">2. La Evaluación: El Componente Proyecto</h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                <div class="space-y-6">
                                    <p class="text-slate-700 font-bold mb-4">A diferencia de primaria (que usa pruebas de ejecución), la evaluación sumativa en secundaria gira en torno al desarrollo de un proyecto.</p>
                                    <div class="p-6 bg-white rounded-2xl border border-teal-100 shadow-sm">
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Carácter del Proyecto</p>
                                        <p class="text-sm text-slate-600">Es un proceso continuo (diagnóstico, formativo y sumativo) que debe desarrollarse estrictamente dentro de las <b>2 lecciones semanales</b> de Formación Tecnológica.</p>
                                    </div>
                                    <div class="p-6 bg-white rounded-2xl border border-teal-100 shadow-sm">
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Calificación</p>
                                        <p class="text-sm text-slate-600">El porcentaje del proyecto se asigna al finalizar el proceso en cada periodo lectivo.</p>
                                    </div>
                                </div>
                                <div class="p-8 bg-white/50 rounded-3xl border border-teal-100/30">
                                    <h5 class="font-black text-sm uppercase text-[#025964] mb-6">Fases de Evaluación del Proyecto:</h5>
                                    <ul class="space-y-6">
                                        <li>
                                            <p class="font-black text-slate-800 text-sm mb-1">1. Etapa Inicial</p>
                                            <p class="text-xs text-slate-500">Se evalúa la comprensión del problema, la investigación y la planificación mediante indicadores específicos (describir necesidades, sintetizar hallazgos, seleccionar ideas).</p>
                                        </li>
                                        <li>
                                            <p class="font-black text-slate-800 text-sm mb-1">2. Etapa de Desarrollo y Cierre</p>
                                            <p class="text-xs text-slate-500">Se evalúa el prototipado y la solución final utilizando los indicadores de logro de los saberes conceptuales del módulo (ej. programación, robótica).</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Planeamiento Didáctico -->
                        <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100">
                            <h4 class="text-2xl font-black text-slate-800 mb-8 uppercase tracking-tighter flex items-center gap-4">3. Planeamiento Didáctico</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-600">
                                <ul class="space-y-4">
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Periodicidad:</b> El planeamiento se elabora de forma <b>bimestral</b> (cada dos meses).</div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Nivel vs. Ciclo:</b> Se planifica por nivel educativo (ej. un plan para 7°, otro para 8°).</div></li>
                                    <li class="flex gap-3"><i class="ph-bold ph-check-circle text-[#008e9b]"></i> <div><b>Articulación:</b> Transformar saberes del módulo en experiencias integradas, evitando el aislamiento de áreas.</div></li>
                                </ul>
                                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col justify-between">
                                    <div>
                                        <p class="text-xs font-black text-teal-600 uppercase mb-2">Estructura de la Plantilla</p>
                                        <p class="text-xs text-slate-500 leading-relaxed mb-4">Referencia actualizada con tres bloques: identificación, matriz de saberes/estrategias/indicadores, y reflexión.</p>
                                    </div>
                                    <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="block w-full text-center bg-[#025964] text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg">Abrir Plantilla Digital 2026</a>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Estructura & 5. Vocacional -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                                <h4 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-tighter">4. Estructura de los Módulos</h4>
                                <ul class="space-y-4 text-xs text-slate-500 font-medium">
                                    <li class="flex gap-2"><span>•</span> <span><b>Cantidad:</b> Dos módulos anuales, uno por cada periodo lectivo.</span></li>
                                    <li class="flex gap-2"><span>•</span> <span><b>Correlación:</b> Segmentos correlacionados; se pueden retomar actividades entre periodos.</span></li>
                                    <li class="flex gap-2"><span>•</span> <span><b>Saberes:</b> Trabajo integrado de saberes conceptuales, procedimentales y actitudinales.</span></li>
                                </ul>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] bg-[#025964] text-white shadow-xl shadow-[#025964]/10">
                                <h4 class="text-xl font-black mb-6 uppercase tracking-tighter">5. Adaptación Modalidad Vocacional</h4>
                                <div class="space-y-4 text-xs text-teal-50">
                                    <p><b>Diagnóstico Contextualizado:</b> Coordinación obligatoria con el docente guía para identificar necesidades específicas.</p>
                                    <p><b>Selección de Saberes:</b> Basado en diagnóstico, se seleccionan saberes de cualquier ciclo que respondan a las necesidades, priorizando <b>herramientas de productividad.</b></p>
                                </div>
                            </div>
                        </div>

                        <!-- 6. Recursos -->
                        <div class="glass p-10 rounded-[2.5rem] bg-slate-50 border border-slate-200">
                            <h4 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tighter">6. Recursos de Apoyo Pedagógico</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h5 class="font-black text-teal-600 text-xs mb-2">Guías Docentes</h5>
                                    <p class="text-xs text-slate-500">Documentos específicos por ciclo que organizan competencias y resultados de aprendizaje.</p>
                                </div>
                                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h5 class="font-black text-teal-600 text-xs mb-2">PIA (Planificación Integral y Ágil)</h5>
                                    <p class="text-xs text-slate-500">Herramienta opcional basada en IA para apoyar la elaboración técnica del planeamiento.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                plan: `
                    <div class="space-y-12 fade-in">
                        <div class="glass p-10 rounded-[3rem] bg-white border border-[#025964]/10 shadow-sm">
                            <h3 class="text-3xl font-black text-slate-800 mb-6 uppercase tracking-tighter">Lineamientos de Planeamiento Didáctico 2026: <span class="text-[#025964]">Enfoque en Secundaria</span></h3>
                            <p class="text-slate-500 font-medium leading-loose mb-8">
                                El planeamiento didáctico se define como el instrumento clave que permite al docente articular los saberes, la metodología y la evaluación de forma intencionada. Para el curso lectivo 2026, la plantilla y los procesos se han actualizado para alinearse con los nuevos módulos del Programa Nacional de Formación Tecnológica (PNFT).
                            </p>
                            <a href="https://k3sb12.github.io/Recurso-Plantilla-Planeamiento-/" target="_blank" class="inline-flex items-center gap-2 bg-[#025964] text-white px-8 py-3 rounded-2xl font-black text-xs uppercase shadow-lg shadow-[#025964]/10 hover:scale-[1.02] transition-all">
                                <i class="ph-bold ph-link"></i> Planificación Docente en Línea
                            </a>
                        </div>

                        <!-- 1. Disposiciones Generales -->
                        <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                            <h4 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-tighter flex items-center gap-3">
                                <div class="w-10 h-10 bg-teal-50 rounded-xl flex items-center justify-center text-teal-600">1</div>
                                1. Disposiciones Generales y Periodicidad
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Periodicidad</p>
                                    <p class="text-sm text-slate-600 font-bold">Bimestral (cada dos meses).</p>
                                </div>
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Por Nivel</p>
                                    <p class="text-sm text-slate-600 font-bold">Plan específico por nivel (7°, 8°, 9°), no por ciclo.</p>
                                </div>
                                <div class="p-6 bg-slate-50 rounded-2xl">
                                    <p class="text-[10px] font-black uppercase text-teal-600 mb-2">Base Insumo</p>
                                    <p class="text-sm text-slate-600 font-bold">Módulo correspondiente (Saber-RdA-Indicador).</p>
                                </div>
                            </div>
                        </div>

                        <!-- 2. La Plantilla 2026 -->
                        <div class="glass p-10 rounded-[3rem] border border-[#025964]/10 bg-white">
                            <h4 class="text-2xl font-black text-slate-800 mb-10 uppercase tracking-tighter">2. La Plantilla de Planeamiento 2026</h4>
                            <div class="space-y-8">
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center text-[#025964] shrink-0 font-black">B1</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 1: Identificación General</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Datos institucionales, Ejes Transversales (Pensamiento Computacional, Ciudadanía Digital, Emprendimiento) y Selección Metodológica (Design Thinking recomendado).</p>
                                    </div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-[#025964] rounded-full flex items-center justify-center text-white shrink-0 font-black">B2</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 2: Matriz de Mediación Pedagógica (Núcleo)</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Articulación de RdA, Saberes integrados, Estrategias de mediación (evitar enseñanza aislada) e Indicadores de Evaluación (basados en la Guía Docente).</p>
                                    </div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center text-[#025964] shrink-0 font-black">B3</div>
                                    <div>
                                        <h5 class="font-black text-slate-800 uppercase text-sm mb-2">Bloque 3: Reflexión y Seguimiento</h5>
                                        <p class="text-xs text-slate-500 leading-relaxed">Análisis de resultados, identificación de logros/dificultades y ajustes en la práctica futura.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Consideraciones Pedagógicas -->
                        <div class="glass p-10 rounded-[3rem] bg-[#025964] text-white">
                            <h4 class="text-2xl font-black mb-8 uppercase tracking-tighter">3. Consideraciones Pedagógicas para Secundaria</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Integración de Áreas</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Evitar abordar saberes de forma aislada; diseñar experiencias que articulen (ej. Programación + Robótica).</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Fases del Proyecto</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Reflejar etapas de Empatizar/Definir (Inicial) e Idear/Prototipar/Testear (Desarrollo).</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Saberes Integrales</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Vincular simultáneamente lo conceptual (teoría), procedimental (hacer) y actitudinal (ser).</p>
                                </div>
                                <div class="bg-white/10 p-6 rounded-2xl border border-white/10">
                                    <p class="font-black text-xs uppercase mb-3 text-teal-400">Diagnóstico Inicial</p>
                                    <p class="text-xs text-teal-50/70 leading-relaxed">Espacio de máximo 2 lecciones al inicio de cada periodo para determinar el punto de partida.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Insumos & 5. PIA -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-slate-100">
                                <h4 class="text-xl font-black text-slate-800 mb-4 uppercase tracking-tighter">4. Insumos Obligatorios</h4>
                                <p class="text-xs text-slate-500 font-medium leading-relaxed mb-4">Uso de la <b>Guía Docente por ciclo</b>: Competencias, RdA, Perfiles de salida y Módulos.</p>
                                <div class="bg-slate-50 p-4 rounded-xl text-[10px] font-bold text-slate-400 uppercase italic">El módulo es la estructura; el planeamiento es la ejecución.</div>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] bg-white border border-[#025964]/20">
                                <h4 class="text-xl font-black text-[#025964] mb-4 uppercase tracking-tighter">5. Herramienta de Apoyo: PIA</h4>
                                <p class="text-xs text-slate-500 font-medium leading-relaxed">Recurso opcional basado en <b>Inteligencia Artificial</b> para agilizar la creación de actividades manteniendo la coherencia oficial.</p>
                            </div>
                        </div>
                    </div>
                `,
                eval: `
                    <div class="space-y-10 fade-in">
                        <section class="glass p-12 rounded-[2.5rem] bg-white border border-[#025964]/10 relative overflow-hidden">
                             <div class="relative z-10">
                                <span class="bg-[#025964] text-white text-xs font-black px-6 py-2 rounded-full uppercase tracking-widest mb-8 inline-block shadow-lg shadow-[#025964]/10">Métrica 2026: Secundaria</span>
                                <h4 class="text-5xl font-black text-slate-800 mb-12 tracking-tighter uppercase leading-none">Componente <br><span class="text-[#025964]">Proyecto</span></h4>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                    <div class="p-8 bg-[#f1f8f9] border border-[#025964]/5 rounded-3xl">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-10 h-10 bg-[#025964] rounded-xl flex items-center justify-center text-white"><i class="ph-bold ph-pencil-line"></i></div>
                                            <h5 class="text-lg font-black text-slate-800 uppercase tracking-tighter">Etapa Inicial</h5>
                                        </div>
                                        <p class="text-slate-500 text-sm leading-relaxed mb-6">Foco en el proceso cognitivo y de diseño:</p>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Empatía y definición del reto.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Síntesis de hallazgos clave.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#008e9b]"></i> Ideación de soluciones eficientes.</div>
                                        </div>
                                    </div>
                                    <div class="p-8 bg-[#f1f8f9] border border-[#025964]/5 rounded-3xl">
                                        <div class="flex items-center gap-4 mb-6">
                                            <div class="w-10 h-10 bg-[#008e9b] rounded-xl flex items-center justify-center text-white"><i class="ph-bold ph-gear-six"></i></div>
                                            <h5 class="text-lg font-black text-slate-800 uppercase tracking-tighter">Etapas Técnicas</h5>
                                        </div>
                                        <p class="text-slate-500 text-sm leading-relaxed mb-6">Foco en la ejecución y saberes digitales:</p>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Implementación de algoritmos/código.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Funcionalidad del prototipo digital.</div>
                                            <div class="flex items-center gap-3 text-xs font-bold text-slate-600"><i class="ph-bold ph-check text-[#025964]"></i> Validación y comunicación de resultados.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-12 flex items-center gap-6 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                                    <i class="ph-fill ph-warning-diamond text-[#025964] text-3xl"></i>
                                    <p class="text-xs text-slate-500 font-medium italic">La acreditación técnica depende de la coherencia entre el proyecto y los saberes digitales del nivel.</p>
                                </div>
                             </div>
                        </section>
                    </div>
                `,
                pob: `
                    <div class="space-y-10 fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div class="glass p-10 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden group">
                                <i class="ph-bold ph-briefcase absolute -left-10 -bottom-10 text-white/5 text-[15rem] rotate-12"></i>
                                <div class="relative z-10">
                                    <h4 class="text-3xl font-black mb-4 tracking-tighter uppercase leading-none">Secundaria <span class="bg-white/20 px-4 py-1 rounded-xl text-lg uppercase">Vocacional</span></h4>
                                    <p class="text-slate-200 font-medium text-sm leading-relaxed mb-8">Población prioritaria. Enfoque en diagnóstico funcional y módulos compensatorios.</p>
                                    <div class="bg-white text-[#025964] font-black text-xs uppercase py-3 px-6 rounded-xl inline-block shadow-xl">Atención Prioritaria Secundaria</div>
                                </div>
                             </div>
                             <div class="glass p-10 rounded-[2.5rem] bg-white border border-slate-100 group h-full flex flex-col justify-center">
                                <div class="w-16 h-16 bg-[#f1f8f9] text-[#025964] rounded-2xl flex items-center justify-center mb-8"><i class="ph-bold ph-user-circle-plus text-3xl"></i></div>
                                <h4 class="text-2xl font-black text-slate-800 mb-4 tracking-tighter uppercase">EPJA (CAN / IPEC)</h4>
                                <p class="text-slate-500 text-sm font-medium leading-relaxed">Directrices específicas para educación de adultos. Ajuste de tiempos y micro-planeamiento por competencia laboral.</p>
                             </div>
                        </div>
                        <div class="glass p-10 rounded-[2.5rem] bg-[#f1f8f9] border border-[#025964]/10 flex items-center gap-8">
                            <div class="w-16 h-16 bg-white border border-[#025964]/10 text-[#025964] rounded-full flex items-center justify-center shrink-0 shadow-sm"><i class="ph-bold ph-hands-clapping text-3xl"></i></div>
                            <div>
                                <h5 class="text-xl font-black text-slate-800 mb-2 uppercase tracking-tighter">Inclusión Total</h5>
                                <p class="text-sm text-slate-500 font-medium leading-relaxed">Las Aulas Integradas deben priorizar la productividad digital mediante diagnósticos personalizados.</p>
                            </div>
                        </div>
                    </div>
                `
            };
            content.innerHTML = templates[tab] || '';
        };

        window.setInputChat = (txt) => document.getElementById('chat-input').value = txt;

        window.publicarForo = async () => {
            const txt = document.getElementById('foro-msg').value.trim();
            if (!txt) return;
            try {
                await window.addDoc(window.collection(db, "foro_posts"), {
                    autor: window.currentUserData?.nombre || "Docente",
                    uid: auth.currentUser.uid,
                    mensaje: txt,
                    fecha: serverTimestamp()
                });
                router('foro');
            } catch (e) { alert("Error: " + e.message); }
        };

        // --- LÓGICA IA (GEMINI vía SERVER) ---
        async function llamarGemini(promptTxt, type = 'general') {
            try {
                const callGemini = window.httpsCallable(window.functions, 'callGemini');
                const result = await callGemini({ prompt: promptTxt, type: type });
                return result.data.text;
            } catch (error) {
                console.error("Error al llamar a Gemini Function:", error);
                // Si el error viene de Firebase Functions, mostramos código y mensaje detallado
                const errorMsg = error.message || 'Error desconocido';
                const errorCode = error.code || 'unknown';

                if (errorCode === 'unauthenticated') return "⚠️ Debes iniciar sesión para usar la IA.";
                return `⛔ Error (${errorCode}): ${errorMsg}`;
            }
        }

        window.configurarAPI = () => {
            alert("✅ El sistema ahora utiliza una conexión de servidor segura. No se requieren claves locales.");
        };

        window.askOrientIA = async (preSet) => {
            const input = document.getElementById('orient-ia-input');
            const resDiv = document.getElementById('orient-ia-res');
            const txt = preSet || input.value.trim();
            if (!txt) return;

            resDiv.innerHTML = '<div class="flex items-center gap-3 text-teal-500 font-black uppercase tracking-widest text-[10px] animate-pulse"><i class="ph ph-cpu"></i> Escaneando Normativa 2026...</div>';
            if (!preSet) input.value = "";

            const respuesta = await llamarGemini(txt, 'orient');

            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            resDiv.innerHTML = `<div class="fade-in bg-teal-50/10 border border-teal-500/20 p-5 rounded-2xl text-slate-300 shadow-sm">${htmlRes}</div>`;
        };

        window.saveOrientNotes = () => {
            const val = document.getElementById('orient-notes').value;
            localStorage.setItem('pnft_orient_notes', val);
        };

        window.updateIASelectors = () => {
            const nivel = document.getElementById('ia-nivel').value;
            const container = document.getElementById('ia-dynamic-selectors');
            const modulos = window.SABERES_DATA[nivel].modulos;

            container.innerHTML = `
                <div class="group">
                    <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Módulo</label>
                    <select id="ia-modulo" onchange="updateIASaberes()" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-medium outline-none focus:bg-white focus:border-[#025964] transition-all appearance-none cursor-pointer">
                        ${modulos.map((m, idx) => `<option value="${idx}">${m.n}</option>`).join('')}
                    </select>
                </div>
                <div class="group">
                    <label class="block text-xs font-black text-[#025964] uppercase tracking-widest mb-3 ml-1">Saberes a vincular</label>
                    <div id="ia-saberes-list" class="flex flex-wrap gap-2 max-h-[150px] overflow-y-auto p-2 bg-slate-50 rounded-2xl border border-slate-100">
                        <!-- Saberes appear here -->
                    </div>
                </div>
            `;
            window.updateIASaberes();
        };

        window.updateIASaberes = () => {
            const nivel = document.getElementById('ia-nivel').value;
            const moduloIdx = document.getElementById('ia-modulo').value;
            const saberes = window.SABERES_DATA[nivel].modulos[moduloIdx].s;
            const list = document.getElementById('ia-saberes-list');

            list.innerHTML = saberes.map(s => `
                <label class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-100 cursor-pointer hover:border-[#025964]/30 transition-all text-[11px] font-bold text-slate-600">
                    <input type="checkbox" name="ia-saber" value="${s}" class="accent-[#025964]">
                    ${s}
                </label>
            `).join('');
        };

        window.generarSituacion = async () => {
            const tema = document.getElementById('ia-tema').value;
            const nivel = document.getElementById('ia-nivel').value;
            const moduloIdx = document.getElementById('ia-modulo').value;
            const moduloName = window.SABERES_DATA[nivel].modulos[moduloIdx].n;

            const selectedSaberes = Array.from(document.querySelectorAll('input[name="ia-saber"]:checked')).map(cb => cb.value);
            const resDiv = document.getElementById('ia-result');
            const resContainer = document.getElementById('ia-result-container');

            if (!tema) return alert("Por favor, describe el contexto o problema.");

            resContainer.classList.remove('hidden');
            resDiv.innerHTML = `
                <div class="flex flex-col items-center fade-in py-10">
                    <div class="w-16 h-16 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-[#025964] font-black uppercase tracking-widest text-[10px] animate-pulse">Diseñando situaciones para ${nivel} / ${moduloName}...</p>
                </div>`;

            // Scroll to results
            resDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const promptFinal = `REQUERIMIENTO: Crea 4 situaciones problema detalladas.
            CONTEXTO DOCENTE: "${tema}"
            NIVEL: ${nivel}
            MODULO: ${moduloName}
            SABERES A INTEGRAR: ${selectedSaberes.join(', ') || 'Relacionados al módulo'}
            IMPORTANTE: Recuerda que estas situaciones son GUÍAS para el docente. El estudiante es quien debe vivir el proceso de Design Thinking. 
            FORMATO: Usa párrafos numerados, lenguaje profesional y enfoque en Design Thinking.`;

            const respuesta = await llamarGemini(promptFinal, 'situacion');

            // Format response: separate double newlines into paragraphs, preserve bolds
            const paragraphs = respuesta.split(/\n\s*\n/).filter(p => p.trim());
            const formattedHtml = paragraphs.map(p => {
                let text = p.replace(/\*\*(.*?)\*\*/g, '<b class="text-[#025964]">$1</b>').replace(/\n/g, '<br>');
                return `<div class="mb-8 p-6 bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">${text}</div>`;
            }).join('');

            resDiv.innerHTML = `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-[10px] font-black text-[#025964] uppercase tracking-widest bg-[#f1f8f9] px-4 py-2 rounded-full border border-[#025964]/10">Guía Orientadora para ${nivel}</span>
                        <button onclick="window.print()" class="text-[10px] font-black text-slate-400 hover:text-[#025964] uppercase flex items-center gap-2"><i class="ph ph-printer"></i> Imprimir</button>
                    </div>
                    ${formattedHtml}
                    <div class="mt-8 p-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                        <p class="text-[11px] text-slate-500 font-medium italic text-center">
                            "Recordatorio: Esta información es un insumo técnico para el diseño de su mediación pedagógica. Asegúrese de que sus estudiantes sean los protagonistas activos del proceso de resolución."
                        </p>
                    </div>
                </div>`;
        };

        window.planificarSesion = async () => {
            const input = document.getElementById('plan-input');
            const resDiv = document.getElementById('plan-res');
            const txt = input.value.trim();
            if (!txt) return alert("Describe el objetivo de tu lección.");

            resDiv.innerHTML = '<div class="flex flex-col items-center w-full"><div class="w-10 h-10 border-4 border-[#025964] border-t-transparent rounded-full animate-spin mb-3"></div><p class="text-[#025964] font-black text-xs uppercase tracking-widest">Calculando tiempos y fases...</p></div>';

            const respuesta = await llamarGemini(txt, 'general');
            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            resDiv.innerHTML = `<div class="text-left fade-in font-medium text-slate-600 leading-relaxed max-h-[300px] overflow-y-auto p-2">${htmlRes}</div>`;
            resDiv.className = "bg-white border border-[#025964]/10 rounded-3xl p-8 min-h-[160px] text-sm flex flex-col items-start shadow-sm shadow-[#025964]/5";
        };

        window.enviarChatIA = async () => {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if (!txt) return;

            const hist = document.getElementById('chat-history');
            // User msg
            hist.innerHTML += `
                <div class="flex justify-end gap-3 fade-in">
                    <div class="bg-teal-600 text-white p-6 rounded-[2rem] rounded-tr-none max-w-[85%] text-sm font-bold shadow-xl shadow-teal-600/10">
                        ${txt}
                    </div>
                </div>`;
            input.value = "";
            hist.scrollTop = hist.scrollHeight;

            // IA thinking
            const loadingId = "load-" + Date.now();
            hist.innerHTML += `
                <div id="${loadingId}" class="flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle animate-pulse"></i></div>
                    <div class="bg-slate-50 p-6 rounded-[2rem] rounded-tl-none text-sm font-black text-teal-600 uppercase tracking-widest animate-pulse">Analizando...</div>
                </div>`;
            hist.scrollTop = hist.scrollHeight;

            const respuesta = await llamarGemini(txt, 'general');

            document.getElementById(loadingId).remove();
            const htmlRes = respuesta.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            hist.innerHTML += `
                <div class="flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600"><i class="ph-fill ph-check-circle"></i></div>
                    <div class="bg-white p-6 rounded-[2rem] rounded-tl-none max-w-[85%] text-sm font-medium text-slate-600 leading-relaxed shadow-sm border border-slate-100">
                        ${htmlRes}
                    </div>
                </div>`;
            hist.scrollTop = hist.scrollHeight;
        };

        // --- LÓGICA EXCEL (ADMIN) ---
        window.procesarExcel = (input) => {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('excel-status');
            status.innerText = "Leyendo archivo...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                status.innerText = `Procesando ${json.length} registros...`;
                console.log("Datos Excel:", json);

                // Aquí iría la lógica de guardar en Firebase
                // Por ahora simulamos
                setTimeout(() => {
                    status.innerText = `✅ Se cargaron ${json.length} docentes exitosamente.`;
                    status.className = "mt-2 text-center text-xs text-green-400 font-bold";
                }, 1500);
            };
            reader.readAsArrayBuffer(file);
        };

        // Necesitamos exponer funciones de firebase a window para usarlas dentro de router() que es global
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getFunctions = getFunctions;
        window.httpsCallable = httpsCallable;

        // Inicializar Functions
        window.functions = getFunctions(window.app);

        // --- AUTH LOGIC (Ya probada y funcional) ---
        const msg = (txt, type) => {
            const el = document.getElementById('status-msg');
            el.innerText = txt;
            el.className = `mt-6 text-xs text-center font-bold min-h-[1.5em] ${type === 'err' ? 'text-red-400' : 'text-green-400'}`;
        };

        window.switchExphase = (phase) => {
            const container = document.getElementById('experience-phase-container');
            const btns = document.querySelectorAll('.experience-tab-btn');
            btns.forEach(b => {
                b.classList.remove('active', 'bg-[#025964]', 'text-white');
                b.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`exbtn-${phase}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-[#025964]', 'text-white');
                activeBtn.classList.remove('text-slate-400');
            }

            const phases = {
                antes: `
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">01</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-notebook text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Diagnóstico Inicial</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Mapeo de saberes previos y condiciones tecnológicas del grupo antes de la intervención.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">02</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-strategy text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Diseño del Reto</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Estructuración de la situación problema bajo el enfoque de Design Thinking.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-100 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">03</span>
                        <div class="w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center text-[#025964] mb-6"><i class="ph-bold ph-database text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Selección de Saberes</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Identificación de los saberes digitales del nivel que se abordarán en la sesión.</p>
                    </div>
                    <div class="glass p-8 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group hover:border-[#025964]/30 transition-all">
                        <span class="absolute top-4 right-6 font-black text-4xl text-slate-50 group-hover:text-[#025964]/5 transition-colors">04</span>
                        <div class="w-12 h-12 bg-[#025964] rounded-xl flex items-center justify-center text-white mb-6"><i class="ph-bold ph-check text-2xl"></i></div>
                        <h4 class="text-xl font-black text-slate-800 mb-2">Lista de Cotejo</h4>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed">Preparación de los indicadores de logro y criterios de evaluación técnica.</p>
                    </div>
                `,
                durante: `
                    <div class="lg:col-span-2 glass p-10 rounded-[2.5rem] bg-[#025964] text-white relative overflow-hidden">
                        <i class="ph-fill ph-circles-three absolute -right-10 -bottom-10 text-white/5 text-[15rem] rotate-12"></i>
                        <h4 class="text-3xl font-black mb-4">Liderazgo Pedagógico</h4>
                        <p class="text-teal-100 font-medium leading-relaxed mb-6">El docente de secundaria lidera la mediación técnica dentro del aula para potenciar el aprendizaje autónomo.</p>
                        <ul class="space-y-4">
                            <li class="flex items-center gap-3 text-sm font-bold"><i class="ph-bold ph-check-circle text-teal-400"></i> Modelado de procesos algorítmicos.</li>
                            <li class="flex items-center gap-3 text-sm font-bold"><i class="ph-bold ph-check-circle text-teal-400"></i> Apoyo en la resolución de problemas (debugging).</li>
                        </ul>
                    </div>
                    <div class="lg:col-span-2 glass p-10 rounded-[2.5rem] bg-white border border-slate-100">
                        <h4 class="text-2xl font-black text-slate-800 mb-4">Laboratorio de Creación</h4>
                        <p class="text-slate-500 font-medium leading-relaxed mb-8">Uso intensivo de hardware y software bajo la metodología Design Thinking.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                                <p class="text-2xl font-black text-[#025964]">60%</p>
                                <p class="text-[9px] font-black uppercase text-slate-400">Construcción</p>
                            </div>
                            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                                <p class="text-2xl font-black text-[#025964]">40%</p>
                                <p class="text-[9px] font-black uppercase text-slate-400">Reflexión</p>
                            </div>
                        </div>
                    </div>
                `,
                despues: `
                    <div class="lg:col-span-3 glass p-10 rounded-[2.5rem] bg-white border border-[#025964]/10">
                        <h4 class="text-2xl font-black text-slate-800 mb-6">Bitácora de Evidencias</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-image text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Captura Técnica</p>
                            </div>
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-video text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Proceso de Diseño</p>
                            </div>
                            <div class="space-y-2">
                                <div class="w-full aspect-video bg-slate-100 rounded-xl flex items-center justify-center text-slate-300"><i class="ph ph-file-pdf text-3xl"></i></div>
                                <p class="text-[10px] font-black text-slate-400 uppercase text-center">Reporte RdA</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass p-10 rounded-[2.5rem] bg-teal-50/50 border border-teal-500/10 flex flex-col justify-center">
                        <h5 class="text-lg font-black text-[#025964] mb-2 uppercase italic tracking-tighter">Certificación de Saberes</h5>
                        <p class="text-xs text-slate-500 font-medium">Validación de la apropiación tecnológica en el Portal Nacional de Formación Tecnológica.</p>
                    </div>
                `
            };
            container.innerHTML = `<div class="fade-in grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full">${phases[phase]}</div>`;
        };

        window.switchAuthTab = (t) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (t !== 'recover') {
                const tab = document.getElementById(`tab-${t}`);
                if (tab) tab.classList.add('active');
            }
            document.getElementById('form-login').classList.toggle('hidden', t !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', t !== 'register');
            document.getElementById('form-recover').classList.toggle('hidden', t !== 'recover');
            msg("", "");
        };

        window.showRecoverForm = () => window.switchAuthTab('recover');

        window.recuperarEmail = async () => {
            const nombre = document.getElementById('recover-name').value.trim();
            const codigo = document.getElementById('recover-code').value.trim();

            if (!nombre || !codigo) return msg("⚠️ Ingresa nombre y código", "err");

            msg("🔍 Buscando en el ecosistema...", "normal");

            try {
                // Importar query y where para esta búsqueda específica
                const { query, collection, where, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, "registro_usuarios"),
                    where("nombre", "==", nombre),
                    where("codigo", "==", codigo));

                const snap = await getDocs(q);
                if (snap.empty) {
                    msg("❌ No se encontró ningún docente con esos datos.", "err");
                } else {
                    const data = snap.docs[0].data();
                    msg(`✅ Tu correo es: ${data.email}`, "success");
                    // Opcional: llenar el campo de login automáticamente
                    document.getElementById('login-email').value = data.email;
                }
            } catch (e) {
                console.error(e);
                msg("⛔ Error en la búsqueda: " + e.message, "err");
            }
        };

        window.registerUser = async () => {
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const data = {
                nombre: document.getElementById('reg-name').value.trim(),
                telefono: document.getElementById('reg-phone').value.trim(),
                codigo: document.getElementById('reg-code').value.trim(),
                email: email,
                rol: "docente",
                ultimo_acceso: serverTimestamp()
            };

            if (!email.includes('@mep.go.cr')) return msg("⛔ Use correo @mep.go.cr", "err");
            if (pass.length < 6) return msg("⚠️ Contraseña corta", "err");
            if (!data.nombre || !data.telefono || !data.codigo) return msg("⚠️ Complete datos", "err");

            msg("⏳ Registrando...", "normal");
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await guardarFicha(res.user.uid, data);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    msg("⚠️ Usuario existe. Reparando perfil...", "normal");
                    try {
                        const loginRes = await signInWithEmailAndPassword(auth, email, pass);
                        await guardarFicha(loginRes.user.uid, data);
                        msg("✅ Perfil reparado.", "success");
                    } catch (e) { msg("⛔ Contraseña incorrecta.", "err"); }
                } else { msg("Error: " + error.message, "err"); }
            }
        };

        async function guardarFicha(uid, data) {
            await setDoc(doc(db, "registro_usuarios", uid), data, { merge: true });
        }

        window.loginUser = async () => {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!email || !pass) return msg("⚠️ Faltan datos", "err");
            msg("Verificando...", "normal");
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch (e) { msg("⛔ Datos incorrectos", "err"); }
        };

        window.logout = () => signOut(auth);

        // --- MONITOR DE SESIÓN PRINCIPAL ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Obtener datos de Firestore
                const snap = await getDoc(doc(db, "registro_usuarios", user.uid));
                if (snap.exists()) {
                    window.currentUserData = snap.data();

                    // 1. Ocultar Login / Mostrar App
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');

                    // 2. Llenar Sidebar
                    document.getElementById('sidebar-name').innerText = window.currentUserData.nombre;
                    document.getElementById('sidebar-email').innerText = window.currentUserData.email;
                    document.getElementById('sidebar-avatar').innerText = window.currentUserData.nombre.charAt(0);

                    // 3. Verificar Rol ADMIN
                    if (window.currentUserData.rol === 'admin') {
                        document.getElementById('nav-admin').classList.remove('hidden'); // Mostrar botón Admin
                        document.getElementById('user-role-badge').innerText = "ADMINISTRADOR";
                        document.getElementById('user-role-badge').className = "text-[9px] font-black bg-amber-500 text-slate-900 px-2 py-0.5 rounded";
                    }

                    // 4. Cargar Inicio
                    router('dashboard');

                } else {
                    msg("⚠️ Usuario sin datos. Regístrese de nuevo.", "err");
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            } else {
                window.currentUserData = null;
                document.getElementById('app-layout').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });
    </script>
</body>

</html>
