<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal PNFT 2026 - Gestión Nacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; margin: 0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-primary { background: #14b8a6; color: #0f172a; font-weight: 900; text-transform: uppercase; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary:hover { background: #06b6d4; transform: translateY(-2px); shadow: 0 10px 15px -3px rgba(20, 184, 166, 0.3); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app" class="flex min-h-screen">
        <aside class="w-72 border-r border-slate-800 p-6 flex flex-col fixed h-full bg-[#0f172a] z-50">
            <div class="flex items-center gap-3 mb-10 px-2">
                <div class="w-10 h-10 bg-teal-500 rounded-xl flex items-center justify-center text-slate-900 shadow-lg shadow-teal-500/20">
                    <i class="ph-fill ph-shield-check text-2xl"></i>
                </div>
                <div>
                    <h2 class="font-black text-xl tracking-tighter leading-none">PNFT Core</h2>
                    <span id="auth-status" class="text-[10px] font-bold text-teal-500 uppercase tracking-widest">Iniciando...</span>
                </div>
            </div>
            <nav id="sidebar-nav" class="flex-1 space-y-2"></nav>
            <div id="user-info" class="pt-6 border-t border-slate-800 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center"></div>
        </aside>

        <main class="flex-1 ml-72 p-12">
            <div id="app-content" class="max-w-6xl mx-auto fade-in">
                <div class="flex flex-col items-center justify-center py-40">
                    <div class="w-12 h-12 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-400 font-bold uppercase tracking-widest text-xs">Cargando Módulos 2026...</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, query, orderBy, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBABrNvQH1Zu-peF3Rn1uCe-Yfb2LBGC9A",
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:f096970be5c69a465988aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // FIRMAS DINÁMICAS BASADAS EN LOS ASESORES ASIGNADOS
        const ASESORES_INFO = {
            "alberto.bustos.ortega@mep.go.cr": { nombre: "Alberto José Bustos Ortega", cargo: "Asesor Nacional de Recursos Tecnológicos en Educación" },
            "rodolfo.juarez.perez@mep.go.cr": { nombre: "Rodolfo Juárez Pérez", cargo: "Asesor Nacional de Recursos Tecnológicos en Educación" }
        };

        window.state = { view: 'dashboard', user: null, isAdmin: false };

        // --- GENERADOR DE INSTRUMENTOS (Rúbricas y Listas) ---
        window.generateTool = async () => {
            const nivel = document.getElementById('nivel-sel').value;
            const saber = document.getElementById('saber-input').value;
            const tipo = document.getElementById('tipo-sel').value;
            const resArea = document.getElementById('tool-results');
            if(!saber) return alert("Indique el saber técnico.");

            resArea.innerHTML = `<div class="p-8 glass rounded-3xl animate-pulse text-teal-400 font-bold">✨ Generando ${tipo} con IA...</div>`;

            // Prompt basado en la estructura Acción + Contenido + Condición
            const prompt = `Como Asesor PNFT, genera una ${tipo.toUpperCase()} para nivel ${nivel}°. Saber: ${saber}. 
            REGLA: Usa la estructura Acción+Contenido+Condición. Si es rúbrica, incluye niveles Inicial, Intermedio y Avanzado.`;

            try {
                const docRef = await addDoc(collection(db, "docentes", auth.currentUser.uid, "consultas_ia"), { prompt, timestamp: Date.now() });

                onSnapshot(doc(db, "docentes", auth.currentUser.uid, "consultas_ia", docRef.id), (snap) => {
                    const res = snap.data()?.response;
                    if(res) {
                        const info = ASESORES_INFO[auth.currentUser.email?.toLowerCase()] || { nombre: "Asesor Nacional", cargo: "PNFT" };
                        const firma = `\n\n__________________________________\n${info.nombre}\n${info.cargo}`;
                        resArea.innerHTML = `
                            <div id="pdf-area" class="glass p-10 rounded-[2.5rem] border-teal-500/20 text-slate-300 text-sm leading-relaxed">
                                ${res.replace(/\n/g, '<br>')}
                                <div class="mt-8 pt-6 border-t border-white/5 text-slate-500 italic uppercase text-[9px] tracking-widest">${firma.replace(/\n/g, '<br>')}</div>
                            </div>
                            <button onclick="downloadPDF('pdf-area', 'Instrumento_PNFT_2026')" class="mt-6 btn-primary px-8 py-4 rounded-2xl w-full flex items-center justify-center gap-2">
                                <i class="ph ph-file-pdf text-xl"></i> DESCARGAR PDF OFICIAL
                            </button>`;
                    }
                });
            } catch (e) { alert("Error al conectar con el servicio de IA."); }
        };

        // --- GESTIÓN NACIONAL (Excel y MITDE) ---
        window.processExcel = (event) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const batch = writeBatch(db);
                rows.forEach(row => {
                    batch.set(doc(collection(db, "gestion_asesoria")), {
                        institucion: row["Nombre de la Institución"] || row["Institución"] || "N/A",
                        regional: row["Dirección Regional"] || "N/A",
                        docente: row["Nombre del docente"] || "N/A",
                        esMITDE: false,
                        asesor: auth.currentUser.email,
                        timestamp: Date.now()
                    });
                });
                await batch.commit();
                alert("Centros cargados exitosamente.");
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        };

        // --- RENDERIZADO DE VISTAS ---
        window.renderView = (viewId) => {
            window.state.view = viewId;
            const c = document.getElementById('app-content');
            window.renderSidebar();

            if (viewId === 'pedagogia') {
                c.innerHTML = `
                <div class="max-w-3xl fade-in">
                    <h2 class="text-5xl font-black mb-10 text-white tracking-tighter">Instrumentos de<br><span class="text-teal-500">Evaluación 2026</span></h2>
                    <div class="glass p-10 rounded-[3rem] space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="nivel-sel" class="bg-slate-800 p-4 rounded-xl border-none outline-none font-bold text-sm"><option value="7">Sétimo Año</option><option value="8">Octavo Año</option><option value="9">Noveno Año</option></select>
                            <select id="tipo-sel" class="bg-slate-800 p-4 rounded-xl border-none outline-none font-bold text-sm"><option value="rubrica">Rúbrica de Desempeño</option><option value="cotejo">Lista de Cotejo</option></select>
                        </div>
                        <input id="saber-input" class="w-full bg-slate-800 p-5 rounded-2xl border-none outline-none" placeholder="Saber técnico (ej. Robótica, IA, Circuitos)...">
                        <button onclick="generateTool()" class="w-full btn-primary py-6 rounded-3xl shadow-xl shadow-teal-500/10">Generar con IA ✨</button>
                    </div>
                    <div id="tool-results" class="mt-10"></div>
                </div>`;
            } else if (viewId === 'admin') {
                c.innerHTML = `
                <div class="space-y-10 fade-in">
                    <div class="flex justify-between items-end">
                        <h2 class="text-4xl font-black text-white tracking-tight">Gestión Nacional de Asesoría</h2>
                        <label class="bg-indigo-600 px-6 py-3 rounded-2xl cursor-pointer font-bold text-xs uppercase flex items-center gap-2">
                            <i class="ph ph-file-xls text-xl"></i> Cargar Excel
                            <input type="file" class="hidden" onchange="processExcel(event)">
                        </label>
                    </div>
                    <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>`;
                onSnapshot(query(collection(db, "gestion_asesoria"), orderBy("timestamp", "desc")), (snap) => {
                    document.getElementById('cards-container').innerHTML = snap.docs.map(d => {
                        const i = d.data();
                        return `
                        <div class="glass p-8 rounded-[2.5rem] border-t-2 ${i.esMITDE ? 'border-teal-400' : 'border-slate-800'}">
                            <div class="flex justify-between mb-4">
                                <span class="bg-slate-900 px-3 py-1 rounded text-[10px] font-black text-slate-500 uppercase">${i.regional}</span>
                                <span class="text-[9px] font-bold text-teal-500 uppercase tracking-widest">${i.esMITDE ? 'CENTRO MITDE' : ''}</span>
                            </div>
                            <h4 class="text-xl font-black text-white leading-tight mb-2">${i.institucion}</h4>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Docente: ${i.docente}</p>
                        </div>`;
                    }).join('');
                });
            } else {
                c.innerHTML = `
                <div class="bg-gradient-to-br from-slate-800 to-indigo-950 p-24 rounded-[5rem] text-white relative overflow-hidden shadow-2xl fade-in">
                    <h1 class="text-8xl font-black tracking-tighter mb-4 leading-none">PNFT CORE<br><span class="text-teal-500">2026</span></h1>
                    <p class="text-slate-400 text-2xl font-medium max-w-xl italic leading-relaxed">"Transformando la educación tecnológica a través de la gestión estratégica."</p>
                    <i class="ph-fill ph-rocket-launch text-[30rem] absolute -right-20 -bottom-20 opacity-5"></i>
                </div>`;
            }
            window.renderSidebar();
        };

        window.renderSidebar = () => {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { id: 'dashboard', icon: 'ph-house', label: 'Inicio' },
                { section: 'Pedagogía' },
                { id: 'pedagogia', icon: 'ph-list-checks', label: 'Instrumentos IA' }
            ];
            if(window.state.isAdmin) {
                items.push({ section: 'Asesoría' });
                items.push({ id: 'admin', icon: 'ph-chart-pie', label: 'Gestión Nacional' });
            }
            nav.innerHTML = items.map(i => i.section ? `<div class="mt-8 mb-2 px-6 text-[10px] font-black text-slate-600 uppercase tracking-widest">${i.section}</div>` : 
                `<button onclick="renderView('${i.id}')" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-sm font-bold transition-all ${window.state.view === i.id ? 'bg-teal-500/10 text-teal-400 shadow-inner' : 'text-slate-500 hover:bg-white/5 hover:text-slate-200'}">
                    <i class="ph ${i.icon} text-xl"></i> ${i.label}
                </button>`
            ).join('');
        };

        // --- INICIALIZACIÓN ---
        onAuthStateChanged(auth, async (user) => {
            if(!user) {
                try { await signInAnonymously(auth); } catch(e) { console.error("Auth", e); }
                return;
            }
            window.state.user = user;
            const email = user.email ? user.email.toLowerCase() : "";
            window.state.isAdmin = Object.keys(ASESORES_INFO).includes(email);
            document.getElementById('auth-status').innerText = window.state.isAdmin ? "Control Asesor" : "Portal Docente";
            document.getElementById('user-info').innerText = window.state.isAdmin ? "Modo: Asesoría Nacional" : "Modo: Consulta";
            window.renderView('dashboard');
        });

        window.downloadPDF = (id, title) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14); doc.text("INSTRUMENTO OFICIAL PNFT 2026", 15, 20);
            doc.setFontSize(10); const lines = doc.splitTextToSize(document.getElementById(id).innerText, 180);
            doc.text(lines, 15, 30);
            doc.save(`${title}.pdf`);
        };
    </script>
</body>
</html>
