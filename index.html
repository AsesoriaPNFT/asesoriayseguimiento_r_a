<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal PNFT - Dashboard Nacional MITDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .chart-container { position: relative; height: 250px; width: 100%; }
    </style>
</head>
<body>
    <div id="app" class="flex min-h-screen">
        <aside class="w-72 border-r border-slate-800 p-6 flex flex-col fixed h-full bg-[#0f172a] z-50">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-teal-500 rounded-xl flex items-center justify-center text-slate-900 shadow-lg shadow-teal-500/20">
                    <i class="ph-fill ph-presentation-chart text-2xl"></i>
                </div>
                <div>
                    <h2 class="font-black text-xl tracking-tighter">PNFT Core</h2>
                    <span id="auth-status" class="text-[10px] font-bold text-teal-500 uppercase">En línea</span>
                </div>
            </div>
            <nav id="sidebar-nav" class="flex-1 space-y-1"></nav>
        </aside>

        <main class="flex-1 ml-72 p-12">
            <div id="app-content" class="fade-in max-w-6xl mx-auto"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBABrNvQH1Zu-peF3Rn1uCe-Yfb2LBGC9A",
            authDomain: "asesoriayseguimiento2026.firebaseapp.com",
            projectId: "asesoriayseguimiento2026",
            storageBucket: "asesoriayseguimiento2026.firebasestorage.app",
            messagingSenderId: "800061887135",
            appId: "1:800061887135:web:f096970be5c69a465988aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMINS = ["alberto.bustos.ortega@mep.go.cr", "rodolfo.juarez.perez@mep.go.cr"];
        const SIGNATURE = "\n\n__________________________________\nAlberto José Bustos Ortega\nAsesor Nacional de Recursos Tecnológicos en Educación";
        
        window.state = { view: 'dashboard', user: null, isAdmin: false, myChart: null };

        // --- EXCEL & MITDE LOGIC ---
        window.processExcel = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const batch = writeBatch(db);
                rows.forEach(row => {
                    batch.set(doc(collection(db, "gestion_asesoria")), {
                        codigoSaber: row["Codigo Saber"] || "",
                        codigo: row["Código"] || "",
                        regional: row["Dirección Regional"] || "",
                        institucion: row["Nombre de la Institución"] || "",
                        docente: row["Nombre del docente"] || "",
                        esMITDE: false, // MITDE se marca según tu preferencia
                        timestamp: Date.now(),
                        asesor: auth.currentUser.email
                    });
                });
                await batch.commit();
            };
            reader.readAsArrayBuffer(file);
        };

        // --- GRÁFICO ESTADÍSTICO ---
        window.initStatsChart = (data) => {
            const ctx = document.getElementById('statsChart').getContext('2d');
            const mitdeCount = data.filter(i => i.esMITDE).length;
            const regularCount = data.length - mitdeCount;

            if (window.state.myChart) window.state.myChart.destroy();

            window.state.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Centros MITDE', 'Centros Regulares'],
                    datasets: [{
                        data: [mitdeCount, regularCount],
                        backgroundColor: ['#14b8a6', '#334155'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { weight: 'bold' } } }
                    }
                }
            });
        };

        // --- INFORME QUINCENAL CON FIRMA ---
        window.generateQuincenalReport = async () => {
            const r = document.getElementById('report-status');
            r.innerHTML = "<span class='animate-pulse text-teal-400'>✨ IA analizando impacto en centros MITDE...</span>";
            
            onSnapshot(query(collection(db, "gestion_asesoria"), orderBy("timestamp", "desc")), async (snap) => {
                const gestiones = snap.docs.map(d => d.data());
                const mitdeCount = gestiones.filter(i => i.esMITDE).length;
                
                const prompt = `Genera un INFORME QUINCENAL profesional. Datos: ${JSON.stringify(gestiones.slice(0,10))}. 
                Centros MITDE atendidos: ${mitdeCount}. Analiza el avance en Dimensión 1 del PNFT.`;

                const docRef = await addDoc(collection(db, "docentes", auth.currentUser.uid, "consultas_ia"), {
                    prompt: prompt,
                    timestamp: Date.now()
                });

                onSnapshot(doc(db, "docentes", auth.currentUser.uid, "consultas_ia", docRef.id), (snapIA) => {
                    const res = snapIA.data()?.response;
                    if (res) {
                        const finalContent = res + SIGNATURE;
                        document.getElementById('report-content').innerHTML = `
                            <div id="pdf-area" class="glass p-10 rounded-[2.5rem] border-teal-500/20 text-sm leading-relaxed mb-6">
                                ${finalContent.replace(/\n/g, '<br>')}
                            </div>
                            <button onclick="window.downloadPDF('pdf-area', 'Informe_Quincenal_PNFT')" class="bg-teal-500 text-slate-900 px-8 py-3 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg shadow-teal-500/20">Descargar PDF Oficial</button>
                        `;
                        r.innerHTML = "✅ Análisis quincenal completado.";
                    }
                });
            }, { once: true });
        };

        // --- RENDERIZADO DE VISTA ADMIN ---
        window.renderAdminView = () => {
            const c = document.getElementById('app-content');
            c.innerHTML = `
                <div class="grid lg:grid-cols-3 gap-8 mb-12">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-4xl font-black text-white">Gestión Nacional</h2>
                            <label class="bg-indigo-600 px-6 py-3 rounded-2xl cursor-pointer font-bold text-xs uppercase flex items-center gap-2 hover:bg-indigo-500 transition-all">
                                <i class="ph ph-file-xls text-xl"></i> Cargar Datos
                                <input type="file" class="hidden" onchange="processExcel(event)">
                            </label>
                        </div>
                        <div id="report-status" class="text-xs font-bold uppercase tracking-widest"></div>
                        <div id="report-content" class="fade-in"></div>
                    </div>
                    
                    <div class="glass p-8 rounded-[3rem] border-slate-700/50 flex flex-col items-center">
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-8">Balance de Atención</h3>
                        <div class="chart-container">
                            <canvas id="statsChart"></canvas>
                        </div>
                        <button onclick="generateQuincenalReport()" class="w-full mt-10 bg-slate-800 border border-slate-700 p-4 rounded-2xl font-bold text-xs hover:bg-slate-700 transition-all">SINTETIZAR QUINCENA ✨</button>
                    </div>
                </div>
                <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;

            onSnapshot(query(collection(db, "gestion_asesoria"), orderBy("timestamp", "desc")), (snap) => {
                const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                window.initStatsChart(data);
                document.getElementById('cards-container').innerHTML = data.map(i => `
                    <div class="glass p-8 rounded-[2.5rem] border-t-4 ${i.esMITDE ? 'border-teal-400' : 'border-slate-700'}">
                        <div class="flex justify-between mb-4">
                            <span class="bg-slate-900 px-3 py-1 rounded-lg text-[10px] font-black text-slate-500">${i.regional}</span>
                            <span class="text-[10px] font-black ${i.esMITDE ? 'text-teal-400' : 'text-slate-600'}">${i.esMITDE ? 'CENTRO MITDE' : 'CENTRO REGULAR'}</span>
                        </div>
                        <h4 class="text-xl font-bold text-white mb-1">${i.institucion}</h4>
                        <p class="text-xs text-slate-400 font-medium mb-6 uppercase tracking-wider">${i.docente}</p>
                        <div class="flex justify-between text-[10px] font-black text-slate-500 border-t border-white/5 pt-4">
                            <span>SABER: ${i.codigoSaber}</span>
                            <span>ID: ${i.codigo}</span>
                        </div>
                    </div>`).join('');
            });
        };

        // --- SISTEMA DE NAVEGACIÓN ---
        window.renderSidebar = () => {
            const nav = document.getElementById('sidebar-nav');
            const menu = [
                { id: 'dashboard', icon: 'ph-house', label: 'Inicio' },
                { section: 'Administración' },
                { id: 'admin', icon: 'ph-chart-pie', label: 'Dashboard Nacional' }
            ];
            nav.innerHTML = menu.map(i => i.section ? 
                `<div class="mt-8 mb-2 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">${i.section}</div>` : 
                `<button onclick="window.state.view='${i.id}';renderView('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold ${window.state.view === i.id ? 'bg-teal-500/10 text-teal-400' : 'text-slate-400 hover:bg-white/5'}"><i class="ph ${i.icon}"></i>${i.label}</button>`
            ).join('');
        };

        window.renderView = (v) => {
            if(v === 'admin') renderAdminView();
            else document.getElementById('app-content').innerHTML = `<h1 class="text-6xl font-black tracking-tighter">PNFT 2026</h1>`;
            renderSidebar();
        };

        onAuthStateChanged(auth, async (u) => {
            if (!u) await signInAnonymously(auth);
            window.state.isAdmin = ADMINS.includes(auth.currentUser.email?.toLowerCase());
            renderView('dashboard');
        });

        window.downloadPDF = (id, t) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const content = document.getElementById(id).innerText;
            doc.setFontSize(16); doc.text("Informe Quincenal de Labores PNFT", 15, 20);
            doc.setFontSize(10); const lines = doc.splitTextToSize(content, 180);
            doc.text(lines, 15, 35);
            doc.save(`${t}.pdf`);
        };
    </script>
</body>
</html>
